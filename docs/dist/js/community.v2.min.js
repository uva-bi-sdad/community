!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Community=t()}(this,(function(){"use strict";function e(e,t,i,s){return new(i||(i=Promise))((function(a,n){function r(e){try{o(s.next(e))}catch(e){n(e)}}function l(e){try{o(s.throw(e))}catch(e){n(e)}}function o(e){e.done?a(e.value):function(e){return e instanceof i?e:new i((function(t){t(e)}))}(e.value).then(r,l)}o((s=s.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const t={file_format:"csv",table_format:"mixed",features:{ID:"id",Name:"name"},feature_conditions:[],variables:{filter_by:[],conditions:[]}},i={file_format:["csv","tsv"],table_format:["tall","mixed","wide"],filter_components:["first","min","mean","sum","max","last"]},s={"!":function(e){return this!==e},"=":function(e){return this===e},includes:function(e){return-1!==this.indexOf(e)},excludes:function(e){return-1===this.indexOf(e)}},a={file_format:function(e){return-1===i.file_format.indexOf(e)},table_format:function(e){return-1===i.table_format.indexOf(e)},include:function(e,t){for(let i=e.length;i--;)if(!(e[i]in t))return e[i];return""}};function n(e,t){if(Array.isArray(e)){const i=Math.min(t[1]+1,e.length),s={missing:0,first:e[0],min:1/0,mean:0,sum:0,max:-1/0,last:e[i-1]};let a=0;for(let n=Math.max(t[0],0);n<i;n++){const t=e[n];"number"==typeof t?isNaN(t)?s.missing++:(a++,s.min>t&&(s.min=t),s.max<t&&(s.max=t),s.sum+=t):"NA"!==t&&a++}return s.mean=a?s.sum/a:0,s}return{missing:Number(isNaN(e))+0,first:e,min:e,mean:e,sum:e,max:e,last:e}}const r={seps:/[\s._-]/g,comma:/,/,word_start:/\b(\w)/g,single_operator:/([<>!])([^=])/,greater:/%3E$/,less:/%3C$/,operator_start:/[<>!]$/,component:/^(.+)\[(.+)\]/,number:/^[0-9.+-]+$/,non_letter_num:/[^0-9a-z]+/g};var l=Object.freeze({__proto__:null,mixed:function(e,t,i,s,a){if(e.group in this.meta.times){const n=[],r=this.meta.times[e.group].value;let l="";Object.keys(i).forEach((t=>{l+='"'+e.features[i[t]]+'"'+a}));const o=t[1]+1;for(let i=t[0];i<o;i++){let t=l+r[i];s.forEach((s=>{const n=e.variables[s].code;if(n in e.data){const r=this.meta.variables[e.group][s].time_range,l=e.data[n];let o=NaN;Array.isArray(l)?i>=r[0]&&i<=r[1]&&(o=l[i-r[0]]):i===r[0]&&(o=l),t+=a+(isNaN(o)?"NA":o)}else t+=a+"NA"})),n.push(t)}return n.join("\n")}return""},tall:function(e,t,i,s,a){if(e.group in this.meta.times){const n=[],r=this.meta.times[e.group].value;let l="";return Object.keys(i).forEach((t=>{l+='"'+e.features[i[t]]+'"'+a})),s.forEach((i=>{const s=e.variables[i].code;if(s in e.data){const o=this.meta.variables[e.group][i].time_range;let d="";const h=t[1]+1;for(let n=t[0];n<h;n++)if(n>=o[0]&&n<=o[1]){const t=e.data[s],h=Array.isArray(t)?t[n-o[0]]:t;isNaN(h)||(d+=(d?"\n":"")+l+r[n]+a+'"'+i+'"'+a+h)}d&&n.push(d)}})),n.join("\n")}return""},wide:function(e,t,i,s,a){if(e.group in this.meta.times){let n="";return Object.keys(i).forEach((t=>{n+=(n?a:"")+'"'+e.features[i[t]]+'"'})),s.forEach((i=>{const s=e.variables[i].code,r=this.meta.ranges[i],l=this.meta.variables[e.group][i].time_range,o=t[1]+1;for(let i=t[0];i<o;i++)if(i>=r[0]&&i<=r[1])if(s in e.data){const t=e.data[s];let r=NaN;Array.isArray(t)?i>=l[0]&&i<=l[1]&&(r=t[i-l[0]]):i===l[0]&&(r=t),n+=a+(isNaN(r)?"NA":r)}else n+=a+"NA"})),n}return""}});function o(o,d,h,c){return e(this,void 0,void 0,(function*(){h||(yield this.data_ready);const e=this.parse_query(o);d=d||this.entities,-1===i.file_format.indexOf(e.file_format)&&(e.file_format=t.file_format),e.table_format in l||(e.table_format=t.table_format);const u={statusCode:400,headers:{"Content-Type":"text/plain; charset=utf-8","Content-Disposition":"attachment; filename="},body:"Invalid Request"},p=e.include&&e.include.length?"string"==typeof e.include?e.include in this.variables?[e.include]:e.include.split(","):e.include:Object.keys(this.variables),m=e.exclude||[],f=[],_=e.features||JSON.parse(JSON.stringify(t.features)),v=[],g=[1/0,-1/0],b="csv"===e.file_format?",":"\t",y=l[e.table_format].bind(this),E=!e.variables.filter_by.length,x=!e.feature_conditions.length,w="dataset"in e?s[e.dataset.operator].bind(e.dataset.value):()=>!0;let C="";p.forEach((e=>{e in this.features&&!(e in _)?_[e]=this.format_label(e):e in this.variables||(C+=e+",",C in this.variables&&(p.push(C),C=""))}));for(const t in a)if(t in e){const i=a[t]("include"===t?p:e[t],this.variables);if(i)return u.body="Failed check for "+t+": "+i,u}Object.keys(this.variable_codes).forEach((e=>{if(-1!==p.indexOf(this.variable_codes[e].name)&&-1===m.indexOf(this.variable_codes[e].name)){f.push(this.variable_codes[e].name);const t=this.meta.ranges[this.variable_codes[e].name];t[0]<g[0]&&(g[0]=t[0]),t[1]>g[1]&&(g[1]=t[1])}})),e.time_range[0]<g[0]&&(e.time_range[0]=g[0]),e.time_range[1]>g[1]&&(e.time_range[1]=g[1]),v.push(Object.keys(_).join(b)),"wide"===e.table_format?f.forEach((t=>{const i=this.meta.ranges[t],s=Math.min(e.time_range[1],i[1])+1;for(let a=Math.max(e.time_range[0],i[0]);a<s;a++)v[0]+=b+'"'+t+"_"+this.meta.overall.value[a]+'"'})):v[0]+=b+"time"+b+("mixed"===e.table_format?f.map((e=>'"'+e+'"')):["variable","value"]).join(b);let k="";Object.keys(d).forEach((t=>{const i=d[t];if(w(i.group)&&(x||function(e,t,i){const s=e[t];for(let t=i.length;t--;){const a=i[t].value;if("-1"!==a){if("id"===i[t].name&&Array.isArray(a)){let t=!1;return a.forEach((i=>{if(!t){const a=i in e&&e[i].group;(a&&a in s.features?i===s.features[a]:i.length<s.features.id.length?i===s.features.id.substring(0,i.length):i===s.features.id)&&(t=!0)}})),t}if(!i[t].check(s.features[i[t].name]))return!1}}return!0}(d,t,e.feature_conditions))&&(E||function(e,t,i,s){const a={},r={};for(let l=i.filter_by.length;l--;){const o=i.filter_by[l],d=s[o].code;if(!(d in e.data))return!1;const h=e.group in s[o].info?s[o].info[e.group].time_range:s[o].time_range[e.group];if(!h)return!1;r[o]=h[0],a[o]=n(e.data[d],[t[0]-h[0],Math.max(t[1]-h[0],t[1]-h[1])])}for(let t=i.conditions.length;t--;){const n=i.conditions[t];if(!(n.time_component?n.check(e.data[s[n.name].code],r[n.name]||0):n.check(a[n.name])))return!1}return!0}(i,e.time_range,e.variables,this.variables))){const s=y(i,e.time_range,_,f,b);s&&(k||(k=t),v.push(s))}})),u.headers["Content-Type"]="text/"+(","===b?"csv":"plain")+"; charset=utf-8",u.body=v.join("\n");const N=this.meta.overall.value,T="export_"+(h&&!c&&k?d[k].group+"_":e.dataset?e.dataset.value+"_":"")+(e.time_range[0]===e.time_range[1]?N[e.time_range[0]]:N[e.time_range[0]]+"-"+N[e.time_range[1]])+"_"+(1===f.length?this.variables[f[0]].meta.short_name.toLowerCase().replace(r.non_letter_num,"-"):f.length+"-variables")+"_"+(v.join("\n").split("\n").length-1)+"x"+v[0].split(b).length;if(h){const t=document.createElement("a");document.body.appendChild(t),t.rel="noreferrer",t.target="_blank",t.download=T+"."+e.file_format,t.href=URL.createObjectURL(new Blob([u.body],{type:u.headers["Content-Type"]})),setTimeout((function(){t.dispatchEvent(new MouseEvent("click")),URL.revokeObjectURL.bind(null,t.href),document.body.removeChild(t)}),0)}return u.statusCode=200,u.headers["Content-Disposition"]+=T+"."+e.file_format,u}))}var d=Object.freeze({__proto__:null,multi:function(e,t){if(t<0)return NaN;if(this.variables[e].is_time)return Array.isArray(this.time.value)?this.time.value[t]:this.time.value;{e=this.variables[e].code;const i=this.data[e];return e in this.data?Array.isArray(i)?t<i.length?i[t]:NaN:0===t?i:NaN:NaN}},row_time:function(e,t,i){const s=this.i-(i.offset-this.o);return e&&s>=0&&s<e.length?"number"==typeof e[s]?this.format_value(e[s],i.int):e[s]:NaN},single:function(e,t){return t<0?NaN:this.variables[e].is_time?Array.isArray(this.time.value)&&t<this.time.value.length?this.time.value[t]:NaN:(e=this.variables[e].code,0===t&&e in this.data?this.data[e]:NaN)}});function h(e,t){return null===e||isNaN(e)?NaN:t||"number"!=typeof this.settings.settings.digits?e:e.toFixed(this.settings.settings.digits>0?this.settings.settings.digits:0)}function c(e){return"string"!=typeof e?"":e in this.variables&&this.variables[e].meta&&this.variables[e].meta.short_name?this.variables[e].meta.short_name:e.replace(r.seps," ").replace(r.word_start,(function(e){return e.toUpperCase()}))}function u(e,t){if(this.sets[t]=e,this.loaded[t]=!0,t in this.info||(this.info[t]={name:t,site_file:t+".json",schema:{fields:[]},ids:[]}),"_meta"in e){const i=e._meta.time;this.meta.times[t]=i,"number"==typeof i.value&&(i.value=[i.value]);const s=i.value;i.n=s.length,i.is_single=1===i.n,i.range=[s[0],s[i.n-1]],e._meta.time.name in this.variables&&(i.info=this.variables[i.name],i.info.is_time=!0),i.range[0]<this.meta.overall.range[0]&&(this.meta.overall.range[0]=i.range[0]),i.range[1]>this.meta.overall.range[1]&&(this.meta.overall.range[1]=i.range[1]),s.forEach((e=>{-1===this.meta.overall.value.indexOf(e)&&this.meta.overall.value.push(e)})),this.meta.overall.value.sort(),this.meta.variables[t]=e._meta.variables||{},Object.keys(this.meta.variables[t]).forEach((e=>{e in this.variables||(this.variables[e]={datasets:[t],info:{},time_range:{},type:"unknown",name:e,code:e,views:{},meta:{full_name:e,measure:e.split(":")[1]||e,short_name:this.format_label(e),long_name:e,type:"unknown"}},this.variable_info[e]=this.variables[e].meta),this.variables[e].name=e,this.variables[e].code=this.meta.variables[t][e].code;const i=this.meta.variables[t][e].time_range;this.variables[e].time_range[t]=i,this.variable_codes[this.variables[e].code]=this.variables[e],-1!==i[0]&&(e in this.meta.ranges?(i[0]<this.meta.ranges[e][0]&&(this.meta.ranges[e][0]=i[0]),i[1]>this.meta.ranges[e][1]&&(this.meta.ranges[e][1]=i[1])):this.meta.ranges[e]=[i[0],i[1]])}))}this.load_id_maps()}function p(){return e(this,void 0,void 0,(function*(){this.metadata.datasets&&this.metadata.datasets.forEach((e=>{let t=!1;e in this.info&&this.info[e].ids.forEach(((i,s)=>{if("map"in i){t=!0;const a=i.map;if(a in this.data_maps)if(this.data_maps[a].retrieved){const t=e in this.data_maps[a].resource?this.data_maps[a].resource[e]:this.data_maps[a].resource;this.info[e].schema.fields[s].ids=this.entity_features[e]=t,this.map_entities(e)}else{const t=this.data_maps[a].queue;-1===t.indexOf(e)&&t.push(e)}else if("string"!=typeof a||i.map_content){if("string"==typeof a){this.data_maps[a]={queue:[],resource:JSON.parse(i.map_content),retrieved:!0};const t=e in this.data_maps[a].resource?this.data_maps[a].resource[e]:this.data_maps[a].resource;this.info[e].schema.fields[s].ids=this.entity_features[e]=t}else this.entity_features[e]=a;this.map_entities(e)}else if(this.data_maps[a]={queue:[e],resource:{},retrieved:!1},this.settings.entity_info&&a in this.settings.entity_info){const e=this.settings.entity_info;"string"==typeof e[a]&&(e[a]=JSON.parse(e[a])),this.ingest_map(e[a],a,s)}else if("undefined"==typeof window)require("https").get(a,(e=>{const t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{this.ingest_map(JSON.parse(t.join("")),e.req.protocol+"//"+e.req.host+e.req.path,s)}))})).end();else{const e=new window.XMLHttpRequest;e.onreadystatechange=function(t,i){if(4===e.readyState){if(200!==e.status)throw new Error("data_handler.ingester.id_maps failed: "+e.responseText);this.ingest_map(JSON.parse(e.responseText),t,i)}}.bind(this,a,s),e.open("GET",a,!0),e.send()}}})),t||(this.entity_features[e]={},this.map_entities(e))}))}))}function m(e,t,i){this.data_maps[t].resource=e,this.data_maps[t].retrieved=!0,this.data_maps[t].queue.forEach((e=>{if(this.info[e].schema.fields.length>i){e in this.entity_features||(this.entity_features[e]={});const s=e in this.data_maps[t].resource?this.data_maps[t].resource[e]:this.data_maps[t].resource;this.info[e].schema.fields[i].ids=this.entity_features[e]=s,this.map_entities(e)}})),this.hooks.data_load&&this.hooks.data_load()}function f(e,t){return isNaN(e[1])?isNaN(t[1])?0:-1:isNaN(t[1])?1:e[1]-t[1]}function _(e,t){this.inited_summary[t+e]||this.settings.view_names.forEach((i=>{const s=this.variables[e];i in s.views||(s.views[i]={order:{},selected_order:{},selected_summaries:{},summaries:{},state:{},table:{}}),t in s.time_range||(s.time_range[t]=[0,this.meta.times[t].n-1]);const a=s.time_range[t][2]=s.time_range[t][1]-s.time_range[t][0]+1,n=s.views[i],r=s.code;if(t in this.sets){const n=this.sets[t],l=this.info[t].entity_count,o=!l||l>65535?Uint32Array:l>255?Uint16Array:Uint8Array,d=s.info[t],h="string"===d.type;let c=d.order;if(c)Object.keys(n).forEach((t=>{t in this.entities&&(i in this.entities[t].views||(this.entities[t].views[i]={summary:{},rank:{},subset_rank:{}}),this.entities[t].views[i].rank[e]=new o(a),this.entities[t].views[i].subset_rank[e]=new o(a))}));else{d.order=c=[];for(let e=a;e--;)c.push([]);Object.keys(n).forEach((t=>{const l=n[t];if("_meta"!==t&&r in l){const n=l[r];if(Array.isArray(n)){for(let e=a;e--;)h&&n[e]in s.level_ids?n[e]=s.level_ids[n[e]]:"number"!=typeof n[e]&&(n[e]=NaN),c[e].push([t,n[e]]);Object.freeze(n)}else h&&n in s.level_ids?c[0].push([t,s.level_ids[n]]):"number"!=typeof n?(l[r]=NaN,c[0].push([t,NaN])):c[0].push([t,n]);if(!(t in this.entities))return;i in this.entities[t].views||(this.entities[t].views[i]={summary:{},rank:{},subset_rank:{}});const d=this.entities[t].views[i];e in d.rank||(d.rank[e]=new o(a),d.subset_rank[e]=new o(a))}}))}c.forEach(((t,s)=>{Object.isFrozen(t)||(t.sort(f),Object.freeze(t)),t.forEach(((t,a)=>{this.entities[t[0]].views[i].rank[e][s]=a}))}))}if(!(t in n.summaries)){n.order[t]=[],n.selected_order[t]=[],n.selected_summaries[t]={type:"number",filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[],mode:[],level_ids:{},levels:[]};const e={type:"number",filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[],mode:[],level_ids:{},levels:[]};if("string"===s.info[t].type){e.type="string",e.level_ids=s.level_ids,e.levels=s.levels,n.table={},s.levels.forEach((e=>{n.table[e]=[];for(let t=a;t--;)n.table[e].push(0)}));for(let i=a;i--;)n.order[t].push([]),n.selected_order[t].push([]),e.missing.push(0),e.n.push(0),e.mode.push("");n.summaries[t]=e}else{for(let i=a;i--;)n.order[t].push([]),n.selected_order[t].push([]),n.selected_summaries[t].n.push(0),n.selected_summaries[t].missing.push(0),e.missing.push(0),e.n.push(0),e.sum.push(0),e.max.push(-1/0),e.q3.push(0),e.mean.push(0),e.norm_median.push(0),e.break_median.push(-1),e.lower_median_min.push(-1),e.lower_median_range.push(-1),e.upper_median_min.push(-1),e.upper_median_range.push(-1),e.norm_mean.push(0),e.break_mean.push(-1),e.lower_mean_min.push(-1),e.lower_mean_range.push(-1),e.upper_mean_min.push(-1),e.upper_mean_range.push(-1),e.median.push(0),e.q1.push(0),e.min.push(1/0);n.summaries[t]=e}Object.seal(n.order[t]),Object.seal(n.selected_order[t]),Object.seal(n.selected_summaries[t]),Object.seal(n.summaries[t])}}))}function v(e,t,i,s){const a=e*(t-1),n=a%1,r=1-n,l=i+Math.ceil(a);return s[i+Math.floor(a)][1]*n+s[l][1]*r}function g(t,i,s){return e(this,void 0,void 0,(function*(){const e=i&&i.id,a=i.get.dataset();yield this.data_processed[a];const n=a+t;this.inited_summary[n]||this.init_summary(t,a),this.inited_summary[n]=new Promise((e=>{this.summary_ready[n]=e}));const r=this.variables[t],l=r.views[e];if(i.valid[a]&&l.state[a]!==i.state){const o=this.settings.settings.summary_selection,d=i.selection[o],h=i.selection.all,c=l.order[a],u=l.selected_order[a],p=r.time_range[a][2],m=r.info[a].order,f=r.levels,_=r.level_ids,g=i.n_selected[o]!==i.n_selected.dataset,b=l.selected_summaries[a],y=l.summaries[a],E="string"===r.type;for(let e=p;e--;)c[e]=g?[]:m[e],u[e]=g?[]:m[e],b.missing[e]=0,b.n[e]=0,y.missing[e]=0,y.n[e]=0,E?(y.mode[e]="",f.forEach((t=>l.table[t][e]=0))):(y.sum[e]=0,y.mean[e]=0,y.max[e]=-1/0,y.min[e]=1/0,y.break_mean[e]=-1,y.break_median[e]=-1);if(m.forEach(((i,a)=>{const n=c[a],r=u[a];let o=0;i.forEach((i=>{const u=i[0],p=i[1];if(u in d){const m=d[u].views[e],_=!isNaN(p);a||(t in m.summary||(m.summary[t]={n:0,overall:y,order:c}),m.summary[t].n=0),s&&g&&(n.push(i),u in h&&(r.push(i),_?b.n[a]++:b.missing[a]++)),_?(m.subset_rank[t][a]=o++,m.summary[t].n++,y.n[a]++,E?l.table[f[p]][a]++:(y.sum[a]+=p,p>y.max[a]&&(y.max[a]=p),p<y.min[a]&&(y.min[a]=p))):y.missing[a]++}}))})),s)c.forEach(((e,t)=>{if(E)if(y.n[t]){let e=0;Object.keys(l.table).forEach((i=>{l.table[i][t]>l.table[f[e]][t]&&(e=_[i])})),y.mode[t]=f[e]}else y.mode[t]="";else{if(y.n[t]){y.mean[t]=y.sum[t]/y.n[t],isFinite(y.min[t])||(y.min[t]=y.mean[t]),isFinite(y.max[t])||(y.max[t]=y.mean[t]),y.range[t]=y.max[t]-y.min[t],1===y.n[t]?y.q3[t]=y.median[t]=y.q1[t]=null==e[0][1]?y.mean[t]:e[0][1]:(y.median[t]=v(.5,y.n[t],y.missing[t],e),y.q3[t]=v(.75,y.n[t],y.missing[t],e),y.q1[t]=v(.25,y.n[t],y.missing[t],e));const i=e.length;for(let s=y.missing[t],a=!1,n=!1;s<i;s++){const i=e[s][1];if("number"==typeof i&&(!a&&i>y.median[t]&&(y.break_median[t]=s-1,a=!0),!n&&i>y.mean[t]&&(y.break_mean[t]=s-1,n=!0)),a&&n)break}}else y.max[t]=0,y.q3[t]=0,y.median[t]=0,y.q1[t]=0,y.min[t]=0;y.n[t]&&(y.norm_median[t]=y.range[t]?(y.median[t]-y.min[t])/y.range[t]:.5,-1!==y.break_median[t]&&(y.lower_median_min[t]=y.norm_median[t]-(e[y.missing[t]][1]-y.min[t])/y.range[t],y.lower_median_range[t]=y.norm_median[t]-((e[y.break_median[t]][1]-y.min[t])/y.range[t]-y.lower_median_min[t]),y.upper_median_min[t]=y.norm_median[t]-(e[y.break_median[t]][1]-y.min[t])/y.range[t],y.upper_median_range[t]=(e[e.length-1][1]-y.min[t])/y.range[t]-y.norm_median[t]-y.upper_median_min[t]),y.norm_mean[t]=y.range[t]?(y.mean[t]-y.min[t])/y.range[t]:.5,-1!==y.break_mean[t]&&(y.lower_mean_min[t]=y.norm_mean[t]-(e[y.missing[t]][1]-y.min[t])/y.range[t],y.lower_mean_range[t]=y.norm_mean[t]-((e[y.break_mean[t]][1]-y.min[t])/y.range[t]-y.lower_mean_min[t]),y.upper_mean_min[t]=y.norm_mean[t]-(e[y.break_mean[t]][1]-y.min[t])/y.range[t],y.upper_mean_range[t]=(e[e.length-1][1]-y.min[t])/y.range[t]-y.norm_mean[t]-y.upper_mean_min[t]))}}));else for(let e=0;e<p;e++)if(y.n[e])if(E){let t=0;Object.keys(l.table).forEach((i=>{l.table[i][e]>l.table[f[t]][e]&&(t=_[i])})),y.mode[e]=f[t]}else y.mean[e]=y.sum[e]/y.n[e];else y[E?"mode":"mean"][e]=NaN;y.filled=!0,l.state[a]=i.state,this.summary_ready[n]()}else yield this.summary_ready[n]}))}function b(){this.metadata.datasets.forEach((e=>{this.data_queue[e]={};const t=this.info[e];t&&(t.id_vars=t.ids.map((e=>e.variable)),t.schema.fields.forEach((t=>{const i=t.name;if(i in this.variables){const s=this.variables[i];s.datasets.push(e),s.info[e]=t,"string"===t.type&&(s.levels=[],s.level_ids={},(t.info&&t.info.levels||Object.keys(t.table)).forEach((e=>{e in s.level_ids||(s.level_ids[e]=s.levels.length,s.levels.push(e))})))}else{const s=this.variables[i]={datasets:[e],info:{},time_range:{},type:t.type,code:i,name:i,meta:t.info,levels:[],level_ids:{},table:{},order:[],views:{}};s.info[e]=t,"string"===t.type&&(s.levels=[],s.level_ids={},Object.keys(t.table).forEach((e=>{s.level_ids[e]=s.levels.length,s.levels.push(e)}))),s.meta||(s.meta={full_name:i,measure:i.split(":")[1]||i,short_name:this.format_label(i),type:t.type||"unknown"}),s.meta.full_name=i,"measure"in s.meta||(s.meta.measure=i.split(":")[1]||i),"short_name"in s.meta||(s.meta.short_name=this.format_label(i)),"long_name"in s.meta||(s.meta.long_name=s.meta.short_name),i in this.variable_info||(this.variable_info[i]=s.meta)}})))}))}function y(t){return e(this,void 0,void 0,(function*(){if(t in this.sets&&!this.inited[t]&&t in this.meta.times){const e=this.sets[t],i=this.meta.times[t],s=k.retrievers[i.is_single?"single":"multi"],a=Object.keys(this.sets),n=this.info;Object.keys(e).forEach((r=>{const l=e[r],o=r.length;if("_meta"!==r){const e=this.entity_features[t][r],d=e||{id:r,name:r};d.id=r,d.name||(d.name=r);const h=r in this.entities?this.entities[r]:{group:t,data:l,variables:this.variables,features:d,views:{}};r in this.entities?(h.group=t,h.data=l,h.variables=this.variables,h.features||(h.features={}),h.views||(h.views={})):this.entities[r]=h,r in this.entity_tree||(this.entity_tree[r]={parents:{},children:{}});const c=this.entity_tree[r];h.relations=c,Object.keys(d).forEach((t=>{t in this.features||(this.features[t]=this.format_label(t)),"id"!==t&&!e&&t in h.features||(h.features[t]=d[t]),-1!==this.metadata.datasets.indexOf(t)&&(d[t]in this.entity_tree||(this.entity_tree[d[t]]={parents:{},children:{}}),this.entity_tree[d[t]].children[r]=c,c.parents[d[t]]=this.entity_tree[d[t]])})),n&&a.forEach((e=>{const t=e in n&&n[e].id_length;if(t&&t<o){const i=r.substring(0,t);i in this.sets[e]&&(i in this.entity_tree||(this.entity_tree[i]={parents:{},children:{}}),this.entity_tree[i].children[r]=c,c.parents[i]=this.entity_tree[i])}})),this.settings.view_names.forEach((e=>{e in h.views||(h.views[e]={summary:{},rank:{},subset_rank:{}})})),h.time=i,h.get_value=s.bind(h)}})),this.inited[t]=!0,this.data_promise[t](),setTimeout((()=>{this.inited.first||(this.hooks.init&&this.hooks.init(),this.inited.first=!0),t in this.data_queue&&Object.keys(this.data_queue[t]).forEach((e=>{this.data_queue[t][e](),delete this.data_queue[t][e]})),this.hooks.onload&&this.hooks.onload(t)}),0)}for(const e in this.info)if(Object.prototype.hasOwnProperty.call(this.info,e)&&!this.inited[e])return;this.all_data_ready()}))}const E={any:/\{(?:categor|variant)/,category:/\{categor(?:y|ies)(\.[^}]+?)?\}/g,variant:/\{variants?(\.[^}]+?)?\}/g,all:/\{(?:categor(?:y|ies)|variants?)(\.[^}]+?)?\}/g,desc:/description$/};function x(e,t,i,s,a="default"){t.lastIndex=0;for(let n,r;n=t.exec(e);){const l=s&&"v"===n[0].substring(1,2)?s:i;r=n[1]?n[1].substring(1):a,r in l||("description"in l&&E.desc.test(r)?r=a="description":r===a&&(r="default"));const o=l[r];if("string"==typeof o){for(;e.includes(n[0]);)e=e.replace(n[0],o);t.lastIndex=0}}return e}function w(e,t,i,s){const a={name:"blank"===e?"":e};return Object.keys(t).forEach((e=>{const n=t[e];a[e]="string"==typeof n?x(n,s,i):n})),"default"in a||(a.default=a.name),a}function C(e){const a=JSON.parse(JSON.stringify(t));if("string"==typeof e){"?"===e[0]&&(e=e.substring(1));const t=e.split("&");e={},t.forEach((t=>{const i=t.split("=");e[i[0]]=i.length>1?i[1]:""}))}return e&&Object.keys(e).forEach((t=>{if("include"===t||"exclude"===t||t in a)a[t]=e[t];else{let n=[];r.single_operator.test(t)&&(n=t.replace(r.single_operator,"$1=$2").split("="),n.length>1&&(t=n[0],e[t]=n[1]));const l=r.component.exec(t),o={name:t.replace(r.greater,">").replace(r.less,"<"),component:"mean",operator:"=",value:r.number.test(e[t])?+e[t]:e[t],time_component:!1,check:()=>!1};if("object"==typeof e[t]&&("component"in e[t]&&(o.component=e[t].component),"operator"in e[t]&&(o.operator=e[t].operator),"value"in e[t]&&(o.value=e[t].value)),t=o.name,l)if(-1!==i.filter_components.indexOf(l[2]))o.component=l[2],o.name=l[1];else if(r.number.test(l[2])){const e=+l[2],t=e>0&&e<this.meta.overall.value.length?e:this.meta.overall.value.indexOf(e);-1!==t&&(o.time_component=!0,o.component=t,o.name=l[1])}if(r.operator_start.test(t)&&t[t.length-1]in k.checks&&(o.operator=t[t.length-1],n.length||(o.operator+="="),t===o.name&&(o.name=t.substring(0,t.length-1))),void 0===o.value||"-1"==o.value)return;if("="!==o.operator&&"!"!==o.operator||"string"!=typeof o.value||!r.comma.test(o.value)||(o.value=o.value.split(","),o.operator="="===o.operator?"includes":"excludes"),"time_range"===o.name){if(Array.isArray(o.value))a.time_range=[this.meta.overall.value.indexOf(+o.value[0]),this.meta.overall.value.indexOf(+o.value[1])];else{const e=this.meta.overall.value.indexOf(+o.value);a.time_range="="===o.operator?[e,e]:">"===o.operator?[e,this.meta.overall.value.length-1]:[0,e]}-1===a.time_range[0]&&(a.time_range[0]=0),-1===a.time_range[1]&&(a.time_range[1]=this.meta.overall.value.length?this.meta.overall.value.length-1:0)}else"dataset"===o.name?a.dataset=o:o.name in this.features?("id"!==o.name||o.value||(o.value=(o.value+"").split(",")),o.check=s[o.operator].bind(o.value),a.feature_conditions.push(o)):o.name in this.variables&&(o.check=(o.time_component?function(e,t){const i="number"!=typeof e,s="number"==typeof this.condition.component?this.condition.component-t:0;return i?this.check(e[s],this.condition.value):!s&&this.check(e,this.condition.value)}:function(e){return this.check(e[this.condition.component],this.condition.value)}).bind({check:k.checks[o.operator],condition:o}),-1===a.variables.filter_by.indexOf(o.name)&&a.variables.filter_by.push(o.name),a.variables.conditions.push(o))}})),"time_range"in a||(a.time_range=[0,this.meta.overall.value.length?this.meta.overall.value.length-1:0]),a}class k{constructor(t,i,s,a){this.hooks={},this.defaults={dataview:"default_view",time:"time"},this.settings={},this.metadata={datasets:[]},this.info={},this.sets={},this.dynamic_load=!1,this.all_data_ready=()=>!1,this.data_ready=new Promise((e=>{this.all_data_ready=e})),this.features={},this.variables={},this.variable_codes={},this.variable_info={},this.references={},this.entities={},this.entity_tree={},this.meta={times:{},variables:{},ranges:{},overall:{range:[1/0,-1/0],value:[]}},this.loaded={},this.inited={},this.inited_summary={},this.summary_ready={},this.entity_features={},this.data_maps={},this.data_queue={},this.data_promise={},this.data_processed={},this.load_requests={},this.retrieve=function(t,i){return e(this,void 0,void 0,(function*(){if(!this.load_requests[t]){this.load_requests[t]=i;const e=new window.XMLHttpRequest;e.onreadystatechange=()=>{if(4===e.readyState){if(200!==e.status)throw new Error("DataHandler.retrieve failed: "+e.responseText);this.ingest_data(JSON.parse(e.responseText),t)}},e.open("GET",i,!0),e.send()}}))},this.format_value=h,this.format_label=c,this.ingest_data=u,this.ingest_map=m,this.load_id_maps=p,this.init_summary=_,this.calculate_summary=g,this.map_variables=b,this.map_entities=y,this.parse_query=C,this.export=o,this.get_variable=function(t,i){return e(this,void 0,void 0,(function*(){return t in this.variables&&(yield this.calculate_summary(t,i,!0)),this.variables[t]}))},this.get_value=function(e){if(this.variables[e.variable].is_time)return e.entity.time.value;{const t=this.variables[e.variable].code;return t in e.entity.data?Array.isArray(e.entity.data[t])?e.entity.data[t]:[e.entity.data[t]]:[NaN]}},this.defaults=i||{},this.settings=t||{},this.metadata=this.settings.metadata||{datasets:[]},this.sets=s||{},this.hooks=a||{},this.get_value=this.get_value.bind(this),this.dynamic_load="dataviews"in this.settings&&this.settings.settings&&!!this.settings.settings.partial_init,this.settings.view_names=this.dynamic_load?Object.keys(this.settings.dataviews):["default_view"],"string"==typeof this.metadata.datasets&&(this.metadata.datasets=[this.metadata.datasets]);const n=()=>{if(this.metadata.datasets&&this.metadata.datasets.length||(this.metadata.datasets=Object.keys(this.info),this.metadata.datasets.length||(this.metadata.datasets=Object.keys(this.sets))),this.metadata.measure_info){const e=function(e){return Object.keys(e).forEach((t=>{if(E.any.test(t)){const i=e[t],s=Object.keys(i);if(i.categories||i.variants){const a=Array.isArray(i.categories)?{}:i.categories||{},n=Array.isArray(i.variants)?{}:i.variants||{},r=Array.isArray(i.categories)?i.categories:Object.keys(a);r.length||r.push("");const l=Array.isArray(i.variants)?i.variants:Object.keys(n);l.length||l.push(""),r.forEach((r=>{l.forEach((l=>{const o=w(r,a[r]||{},n[l]||{},E.variant),d=w(l,n[l]||{},a[r]||{},E.category),h=Object.assign(Object.assign({},o),d),c={};s.forEach((e=>{if("categories"!==e&&"variants"!==e){const t=i[e];c[e]="string"==typeof t?x(t,E.all,o,d,e):t}})),Object.keys(h).forEach((e=>{e in c||"default"===e||"name"===e||"description"===e&&(c.long_description||c.short_description)||(c[e]=h[e])})),e[x(t,E.all,o,d)]=c}))}))}}})),e}(this.metadata.measure_info);this.metadata.datasets.forEach((t=>{e._references&&(this.info[t]._references=e._references);this.info[t].schema.fields.forEach((t=>t.name in e?t.info=e[t.name]:""))}))}this.map_variables(),this.metadata.datasets.length?this.metadata.datasets.forEach((e=>{this.loaded[e]=e in this.sets,this.inited[e]=!1,this.data_processed[e]=new Promise((t=>{this.data_promise[e]=t})),e in this.info&&(this.info[e].site_file=(this.metadata.url?this.metadata.url+"/":"")+this.info[e].name+".json"),this.loaded[e]?this.ingest_data(this.sets[e],e):this.dynamic_load&&(!this.settings.settings||this.settings.settings.partial_init)&&this.defaults.dataset&&e!==this.defaults.dataset||this.retrieve(e,this.info[e].site_file)})):setTimeout((()=>{this.inited.first=!0,this.hooks.init&&this.hooks.init(),this.hooks.onload&&this.hooks.onload()}),0)};if(this.metadata.package&&!this.metadata.info)if("undefined"==typeof window)require("https").get(this.metadata.url+this.metadata.package,(e=>{const t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{this.info={};const e=JSON.parse(t.join(""));e.measure_info&&(this.metadata.measure_info=e.measure_info),e.resources.forEach((e=>this.info[e.name]=e)),n()}))})).end();else{const e=new window.XMLHttpRequest;e.onreadystatechange=()=>{if(4===e.readyState){if(200!==e.status)throw new Error("failed to load datapackage: "+e.responseText);{this.info={};const t=JSON.parse(e.responseText);t.measure_info&&(this.metadata.measure_info=t.measure_info),t.resources.forEach((e=>this.info[e.name]=e)),n()}}},e.open("GET",this.metadata.url+this.metadata.package),e.send()}else this.metadata.info&&(this.info=this.metadata.info),n()}}k.retrievers=d,k.checks={"!":function(e){return!e||-1==e},"":function(e){return!!e&&-1!=e},"=":function(e,t){return e===t},"!=":function(e,t){return e!=t},">":function(e,t){return e>t},"<":function(e,t){return e<t},">=":function(e,t){return e>=t},"<=":function(e,t){return e<=t},equals:function(e,t){return!e||-1==e||e===t},includes:function(e,t){return!e||!e.length||-1!==e.indexOf(t)},excludes:function(e,t){return!e||!e.length||-1===e.indexOf(t)}};const N={time:"time",dataview:"default_view",palette:"vik",background_highlight:"#adadad",border:"#7e7e7e",border_highlight_true:"#ffffff",border_highlight_false:"#000000",missing:"#00000000"};class T{constructor(e){this.registered={},this.selection={},this.entities=new Map,this.selected=[],this.select_ids={},this.filters=new Map,this.states={id_state:"initial",filter_state:"initial"},this.site=e}init(){this.times=this.site.data.meta.overall.value,this.dataview=this.site.dataviews[this.site.defaults.dataview].parsed}filter_state(e,t){const i=!e;return i&&(e=[]),this.filters.forEach((s=>{const a="selected"===s.component?this.times[void 0===t?this.dataview.time_agg:t]:s.time_component?this.times[s.component]:s.component;s.value&&e.push(s.variable+"["+a+"]"+s.operator+s.value+(i?s.active:""))})),e.join("&")}id_state(){return Object.keys(this.select_ids).join(",")}id_filter(){const e={};if(this.selected=[],this.select_ids=e,this.site.data.metadata.datasets){const t=this.site.page.modal.filter.entity_inputs;this.site.data.metadata.datasets.forEach((i=>{if(i in t){const s=t[i].value(),a=[];Array.isArray(s)&&(s.forEach((t=>{const i=this.site.data.entities[t];i&&(a.push(t),this.selected.push(t),e[t]=!0,i.relations&&(Object.keys(i.relations.parents).forEach((t=>e[t]=!0)),Object.keys(i.relations.children).forEach((t=>e[t]=!0))))})),t[i].source=a)}}))}}}const q={seps:/[\s,/._-]+/g,period:/\./,all_periods:/\./g,word_start:/\b(\w)/g,settings:/^settings?\./,features:/^features?\./,filter:/^filter\./,data:/^data\./,variables:/^variables?\./,properties:/prop/,palette:/^pal/,datasets:/^dat/,variable:/^var/,levels:/^lev/,ids:/^ids/,minmax:/^m[inax]{2}$/,int_types:/^(?:year|int|integer)$/,end_punct:/[.?!]$/,mustache:/\{([^}]+)\}/g,measure_name:/(?:^measure|_name)$/,http:/^https?:\/\//,bool:/^(?:true|false)$/,number:/^[\d-][\d.,]*$/,leading_zeros:/^0+/,url_spaces:/%20/g,hashes:/#/g,embed_setting:/^(?:hide_|navcolor|close_menus)/,median:/^med/i,location_string:/^[^?]*/,time_ref:/\{time\}/g,pre_colon:/^[^:]*:/,exclude_query:/^(?:features|time_range|id)$/,space:/\s+/,has_html:/<(?:math|a|br)[/\s>]/,href:/\\(?:href|url)\{([^}]+)\}(?:\{([^}]+)\})?/g,bracket_content:/(?:^|>)[^<]*(?:<|$)/,html_tags:/^(?:semantics|m|a|br)/,html_attributes:/^(?:xmlns|display|style|encoding|stretchy|alttext|scriptlevel|fence|math|separator|href|rel|target)/,id_escapes:/(?<=#[^\s]+)([.[\](){}?*-])/g,repo:/\.com[/:]([^\/]+\/[^\/]+)/,basename:/^.*\//},O={name:window.location.pathname||"default",perm:window.localStorage,copy:{},set:function(e,t){const i=JSON.parse(this.perm.getItem(this.name)||"{}");i[e]=t,this.perm.setItem(this.name,JSON.stringify(i))},get:function(e){const t=JSON.parse(this.perm.getItem(this.name)||"{}");return e?t[e]:t}};class L{constructor(e){this.site=e,this.subs={}}add(e,t){e in this.subs||(this.subs[e]=new Map),this.subs[e].set(t.id,t)}update(e,t,i){if(e in this.subs){const s=this.site.outputs[e];this.subs[e].forEach((e=>{t in e&&e[t](i,s)}))}}}const A={Enter:"select",NumpadEnter:"select",ArrowUp:"move",Home:"move",ArrowDown:"move",End:"move",Escape:"close",Tab:"close"},j={Time:["first","selected","last"],summary:["missing","min","q1","mean","median","q3","max"]};function S(e,t){t&&!e.e.classList.contains("locked")?(e.e.removeAttribute("disabled"),e.e.classList.remove("disabled"),"combobox"===e.type&&e.input_element.removeAttribute("disabled")):(e.e.setAttribute("disabled","true"),e.e.classList.add("disabled"),"combobox"===e.type&&e.input_element.setAttribute("disabled","true"))}function M(e,t,i,s){if(!(t in e.site.data.sets))return void(e.site.data.data_queue[t][e.id]=()=>{e.loader&&e.e.removeEventListener("click",e.loader),M(e,t,i,s),e.set_current(),e.current_set=t});i[t]={options:[],values:{},display:{}};const a=e.values,n=i[t].options,r=i[t].values,l=i[t].display,o="combobox"===e.type;let d=!e.sensitive&&!!e.current_set,h=0;e.settings.group&&(i[t].groups={e:[],by_name:{}},o&&e.settings.accordion&&(e.listbox.classList.add("accordion"),e.listbox.id=e.id+"-listbox"));const c=i[t].groups;Object.keys(e.site.data.entities).forEach((i=>{const s=e.site.data.entities[i];if(t===s.group)if(d&&!(i in a)&&(e.sensitive=!0,d=!1),c){let t=s.features[e.settings.group]||["No Group"];Array.isArray(t)||(t=[t]);for(let a=t.length;a--;){const n=t[a];if(!(n in c.by_name)){const t=document.createElement(o?"div":"optgroup");if(o){const i=e.id+"_"+n.replace(q.seps,"-");let s;e.settings.accordion?(t.setAttribute("data-group",n),t.className="combobox-group accordion-item combobox-component",t.appendChild(s=document.createElement("div")),s.className="accordion-header combobox-component",s.appendChild(s=document.createElement("button")),s.id=i+"-label",s.innerText=n,s.type="button",s.className="accordion-button combobox-component collapsed",s.setAttribute("data-bs-toggle","collapse"),s.setAttribute("data-bs-target","#"+i),s.setAttribute("aria-expanded","false"),s.setAttribute("aria-controls",i),t.appendChild(s=document.createElement("div")),s.id=i,s.className="combobox-component accordion-collapse collapse",s.setAttribute("data-bs-parent","#"+e.id+"-listbox"),s.appendChild(s=document.createElement("div")),s.className="accordion-body combobox-component",s.role="group",s.setAttribute("aria-labelledby",i+"-label")):(t.className="combobox-group combobox-component",t.id=i,t.role="group",t.appendChild(s=document.createElement("div")),s.appendChild(s=document.createElement("label")),s.dataset.for=i,s.innerText=n,s.id=i+"-label",s.className="combobox-group-label combobox-component")}else t.setAttribute("aria-label",n);c.by_name[n]=t,c.e.push(t)}const r=e.add(i,s.features.name,!0);r.setAttribute("data-group",n),o&&e.settings.accordion?c.by_name[n].lastElementChild.lastElementChild.appendChild(r):c.by_name[n].appendChild(r)}}else n.push(e.add(i,s.features.name)),r[i]=h,l[s.features.name]=h++})),e.settings.group&&(h=0,Object.keys(c.by_name).forEach((e=>{c.by_name[e].querySelectorAll(o?".combobox-option":"option").forEach((e=>{n.push(e),r[o?e.dataset.value:e.value]=h,l[e.innerText]=h++}))}))),s&&s()}function I(e,t,i,s){const a=e.site.data.variables[i].info[t],n="string"===a.type?"levels":"ids",r=a[n];if(r){const a=t+i;s[a]={options:[],values:{},display:{}};const n=e.values,l=s[a].options,o=s[a].values,d=s[a].display;let h=!e.sensitive&&!!e.current_set,c=0;Object.keys(r).forEach((t=>{const i=r[t];h&&!(t in n)&&(e.sensitive=!0,h=!1),l.push(e.add(i.id,i.name,!0)),o[i.id]=c,d[i.name]=c++}))}else"ids"===n&&(e.site.data.data_queue[t][e.id]=function(){return I(e,t,i,s)})}function R(){if(this.site.spec.settings.hide_tooltips||this.id===this.site.page.tooltip.showing)return;const e=this.site.page.tooltip;e.showing=this.id,e.e.firstElementChild.innerText=this.note,e.e.classList.remove("hidden");const t=this.wrapper.getBoundingClientRect(),i=e.e.getBoundingClientRect();e.e.style.left=Math.max(0,Math.min(t.x,t.x+t.width/2-i.width/2))+"px",e.e.style.top=t.y+(t.y<i.height?t.height+5:-i.height-5)+"px"}function B(e,t,i,s){t.classList.add("info-summary-wrapper");const a=document.createElement("table"),n=document.createElement("tr"),r=document.createElement("tr");return a.className="info-summary",a.appendChild(document.createElement("thead")),a.appendChild(document.createElement("tbody")),a.firstElementChild.appendChild(n),a.lastElementChild.appendChild(r),s&&Object.keys(s).forEach((e=>{const t=document.createElement("th"),i=document.createElement("td");n.appendChild(t),t.innerText=e,r.appendChild(i),i.innerText=s[e]})),["NAs","Min","Q1","Mean","Median","Q3","Max"].forEach((t=>{const s=t.toLowerCase();if(!i||s in i){const a=document.createElement("th"),l=document.createElement("td");n.appendChild(a),a.innerText=t,r.appendChild(l),l.innerText=i?e(i[s])+"":"NA"}})),t.appendChild(a),a}function z(e,t){const i=document.createElement(t?"tr":"div");let s=document.createElement("div"),a=document.createElement("a"),n=document.createElement("span"),r=document.createElement("td"),l=document.createElement("p");return t?(e.name&&(i.appendChild(r),e.url?(r.appendChild(a),a.target="_blank",a.rel="noreferrer",a.href=e.url,a.innerText=e.name):(r.appendChild(n),n.innerText=e.name)),e.date_accessed&&(i.appendChild(r=document.createElement("td")),r.appendChild(n=document.createElement("span")),n.innerText=e.date_accessed)):(i.className="card",e.name&&(i.appendChild(s),s.className="card-header",e.url?(s.appendChild(a),a.target="_blank",a.rel="noreferrer",a.href=e.url,a.innerText=e.name):(s.appendChild(n),n.innerText=e.name)),i.appendChild(document.createElement("div")),i.lastElementChild.className="card-body",e.location&&(i.lastElementChild.appendChild(l),l.appendChild(n=document.createElement("span")),n.innerText="Location: ",l.appendChild(n=document.createElement("span")),e.location_url?(n.appendChild(a=document.createElement("a")),a.target="_blank",a.rel="noreferrer",a.href=e.location_url,a.innerText=e.location):n.innerText=e.location),e.date_accessed&&(i.lastElementChild.appendChild(l=document.createElement("p")),l.appendChild(n=document.createElement("span")),n.innerText="Date Accessed: ",l.appendChild(n=document.createElement("span")),n.innerText=e.date_accessed)),i}var F=Object.freeze({__proto__:null,max:function(t,i){return e(this,void 0,void 0,(function*(){let e,s=i.value(),a=t.value(),n=this.dataviews[t.view||i.view];"string"==typeof s&&(s=this.patterns.minmax.test(s)?i.parsed.min:parseFloat(s)),n&&n.y&&(e=this.valueOf(n.y),e in this.data.variables&&(n.time_range.time.length||(yield this.conditionals.time_range(n,t,!0)),s=Math.min(n.time_range.time[1],s)),t.update()),t.e.max=(void 0===t.parsed.max?s:Math.min(t.parsed.max,s))+"",t.e.value?"number"==typeof a&&isFinite(a)&&a>s&&t.set(s):t.reset(),t.max_indicator&&(t.max_indicator.firstElementChild.innerText=s+"")}))},min:function(t,i){return e(this,void 0,void 0,(function*(){let e,s=i.value(),a=t.value(),n=this.dataviews[t.view||i.view];"string"==typeof s&&(s=this.patterns.minmax.test(s)?i.parsed.min:parseFloat(s)),n&&n.y&&(e=this.valueOf(n.y),e in this.data.variables&&(n.time_range.time.length||(yield this.conditionals.time_range(n,t,!0)),s=Math.max(n.time_range.time[0],s)),t.update()),t.e.min=(void 0===t.parsed.min?s:Math.max(t.parsed.min,s))+"",t.e.value?"number"==typeof a&&isFinite(a)&&a<s&&t.set(s):t.reset(),t.min_indicator&&(t.min_indicator.firstElementChild.innerText=s+"")}))},options:function(e){const t=!e.view||!this.dataviews[e.view].selection,i=this.valueOf(e.dataset||t||this.spec.dataviews[e.view].dataset)||this.defaults.dataset,s=this.valueOf(e.variable),a=i+(s||""),n="combobox"===e.type;if(a in e.option_sets||(this.patterns.variable.test(e.optionSource)?("number"==typeof e.default&&-1===e.default&&(e.default=this.defaults.variable),function(e,t,i){i[t]={options:[],values:{},display:{}};const s=e.values,a=i[t].options,n=i[t].values,r=i[t].display,l="combobox"===e.type;let o=!e.sensitive&&!!e.current_set,d=0;e.settings.group&&(i[t].groups={e:[],by_name:{}},l&&e.settings.accordion&&(e.listbox.classList.add("accordion"),e.listbox.id=e.id+"-listbox"));const h=e.site.url_options[e.id],c=i[t].groups;let u=!1;h&&!(h in e.site.data.variables)&&(e.site.url_options[e.id]=h.replace(q.pre_colon,""),h in e.site.data.variables||(u=!0)),e.site.data.info[t].schema.fields.forEach((t=>{const i=e.site.data.variables[t.name];if(i&&!i.is_time){const i=e.site.data.format_label(t.name);if(o&&!(t.name in s)&&(e.sensitive=!0,o=!1),c){let s=t.info&&t.info[e.settings.group]||["No Group"];Array.isArray(s)||(s=[s]);for(let a=s.length;a--;){const n=s[a];if(!(n in c.by_name)){const t=document.createElement(l?"div":"optgroup");if(l){const i=e.id+"_"+n.replace(q.seps,"-");let s;e.settings.accordion?(t.dataset.group=n,t.className="combobox-group accordion-item combobox-component",t.appendChild(s=document.createElement("div")),s.className="accordion-header combobox-component",s.appendChild(s=document.createElement("button")),s.id=i+"-label",s.innerText=n,s.type="button",s.className="accordion-button combobox-component collapsed",s.setAttribute("data-bs-toggle","collapse"),s.setAttribute("data-bs-target","#"+i),s.setAttribute("aria-expanded","false"),s.setAttribute("aria-controls",i),t.appendChild(s=document.createElement("div")),s.id=i,s.className="combobox-component accordion-collapse collapse",s.setAttribute("data-bs-parent","#"+e.id+"-listbox"),s.appendChild(s=document.createElement("div")),s.className="accordion-body combobox-component",s.role="group",s.setAttribute("aria-labelledby",i+"-label")):(t.className="combobox-group combobox-component",t.role="group",t.appendChild(s=document.createElement("div")),s.appendChild(s=document.createElement("label")),s.dataset.for=i,s.innerText=n,s.id=i,s.className="combobox-group-label combobox-component")}else t.setAttribute("aria-label",n);c.by_name[n]=t,c.e.push(t)}const r=e.add(t.name,i,!0,t);r.dataset.group=n,l&&e.settings.accordion?c.by_name[n].lastElementChild.lastElementChild.appendChild(r):c.by_name[n].appendChild(r)}}else a.push(e.add(t.name,i,!0,t)),a[d].id=e.id+"-option"+d,n[t.name]=d,r[i]=d++;u&&h===t.name.replace(q.pre_colon,"")&&(e.site.url_options[e.id]=t.name,u=!1)}})),e.settings.group&&(d=0,Object.keys(c.by_name).forEach((t=>{c.by_name[t].querySelectorAll(l?".combobox-option":"option").forEach((t=>{a.push(t),a[d].id=e.id+"-option"+d,n[l?t.dataset.value:t.value]=d,r[t.firstChild&&t.firstChild.textContent||t.innerText]=d++}))}))),e.settings.clearable||e.default in e.site.data.variables||(e.default=e.site.defaults.variable)}(e,i,e.option_sets)):this.patterns.levels.test(e.optionSource)?I(e,i,s,e.option_sets):this.patterns.ids.test(e.optionSource)&&M(e,i,e.option_sets)),a in e.option_sets){const i=a!==e.current_set&&(e.sensitive||!e.current_set),s=e[n?"listbox":"e"];if(i||e.filter||e.selection_subset){i&&(s.innerHTML="",e.option_sets[a].groups&&(e.groups=e.option_sets[a].groups),e.values=e.option_sets[a].values,e.display=e.option_sets[a].display,e.options=e.option_sets[a].options);let r=0;if("ID"===e.variable||this.patterns.ids.test(e.optionSource)){const a=e.value();let l=-1===a||""===a?e.subset:e.selection_subset,o={};if(!t)if(l in this.inputs&&(l=this.valueOf(l)),"siblings"===l){const e=this.data.entity_tree&&this.data.entity_tree[a];if(e){const t=Object.keys(e.parents);t.length&&(o={},t.forEach((e=>{o=Object.assign(Object.assign({},o),this.data.entity_tree[e].children)})))}}else o=this.dataviews[e.view].selection[l];e.options.forEach((a=>{i&&!e.groups&&s.appendChild(a),t||(n?a.dataset.value:a.value)in o?(a.classList.remove("hidden"),r++):a.classList.add("hidden")}))}else i?e.options.forEach((t=>{t.classList.remove("hidden"),e.groups||s.appendChild(t),r++})):r++;i&&e.groups&&e.groups.e.forEach((e=>s.appendChild(e))),S(e,!!r),e.current_set=a,i&&(n?e.source=[]:(e.e.selectedIndex=-1,e.source=""),e.id in this.url_options?e.set(this.url_options[e.id]):e.state in e.values?e.set(e.state):e.reset()),e.filter&&e.filter()}}},setting:function(e){this.spec.settings[e.setting];const t=e.value(),i=t?"dark":"light";t!==this.spec.settings[e.setting]&&(this.spec.settings[e.setting]=t,"theme_dark"===e.setting?(t?document.body.classList.replace("light-theme","dark-theme"):document.body.classList.replace("dark-theme","light-theme"),this.spec.plotly&&Object.keys(this.spec.plotly).forEach((e=>this.outputs[e].update_theme())),this.spec.map&&Object.keys(this.spec.map).forEach((e=>{const t=this.outputs[e];t&&i in t.tiles&&(Object.keys(t.tiles).forEach((e=>{i!==e&&t.tiles[e].removeFrom(t.map)})),t.tiles[i].addTo(t.map))}))):"hide_url_parameters"===e.setting?window.history.replaceState(Date.now(),"",this.spec.settings.hide_url_parameters?window.location.protocol+"//"+window.location.host+window.location.pathname:this.get_options_url()):"hide_tooltips"===e.setting?t?this.page.script_style.sheet.insertRule("button.has-note::after,.button-wrapper.has-note button::before,.has-note legend::before,.has-note label::before,.wrapper.has-note > div > label::before{display:none}",0):this.page.script_style.sheet.deleteRule(0):"map_overlay"===e.setting?Object.keys(this.spec.map).forEach((e=>{if("_"!==e[0]){const i=this.outputs[e];t?i.update():(i.overlay.clearLayers(),i.overlay_control.remove())}})):"tracking"===e.setting?(t&&this.spec.tag_id&&(this.gtag("js",new Date),this.gtag("config",this.spec.tag_id),this.gtag("consent","default",{analytics_storage:"denied"})),this.gtag("consent","update",{analytics_storage:t?"granted":"denied"})):this.global_update(),this.gtag("event","setting",{event_category:e.setting,event_label:t}),this.storage.set(e.setting,this.spec.settings[e.setting]))},time_filters:function(e){e.time_range.filtered[0]=1/0,e.time_range.filtered[1]=-1/0;const t=e.get.dataset(),i=this.data.meta.times[t],s=e.time_range.filtered_index+"";if(this.data.inited[t]){for(let t=i.n;t--;){let s=!1;if(t>=e.time_range.index[0]&&t<=e.time_range.index[1])for(let a=e.time_filters.length;a--;){const n={},r=e.time_filters[a];if(r.value in n||(n[r.value]=this.valueOf(r.value)),s=k.checks[r.type](i.value[t],n[r.value]),!s)break}e.times[t]=s,s&&(e.time_range.filtered[0]>i.value[t]&&(e.time_range.filtered[0]=i.value[t]),e.time_range.filtered[1]<i.value[t]&&(e.time_range.filtered[1]=i.value[t]))}if(e.time_range.filtered_index=[e.time_range.index[0]+e.time_range.filtered[0]-e.time_range.time[0],e.time_range.index[1]+e.time_range.filtered[1]-e.time_range.time[1]],s!==e.time_range.filtered_index+""){const t=this.dependencies[e.id+"_filter"];t&&t.forEach((t=>{"update"===t.type?t.id in this.inputs?this.inputs[t.id].update():this.outputs[t.id].update():t.type in this.conditionals&&this.conditionals[t.type](this.inputs[t.id],e)}))}}},time_range:function(t,i,s){return e(this,void 0,void 0,(function*(){const e=i&&"value"in i&&i.value(),a=t.get.dataset(),n=t.time?this.valueOf(t.time):this.defaults.time,r=n in this.data.variables?this.data.variables[n].info[a].min:1,l=this.dependencies[t.id+"_time"],o=e in this.data.variables?e:this.valueOf(t.y);let d=o&&(yield this.data.get_variable(o,t));if(d){const e=a+o!=t.time_range.dataset+t.time_range.variable,i=d.time_range[a];-1!==i[0]&&(t.time_range.dataset=a,t.time_range.variable=o,t.time_range.index[0]=i[0],t.time_range.time[0]=t.time_range.filtered[0]=r+i[0],t.time_range.index[1]=i[1],t.time_range.time[1]=t.time_range.filtered[1]=r+i[1]),!s&&l&&(l.forEach((i=>{const s=this.inputs[i.id],a=s.value();"min"===i.type?(e||isFinite(t.time_range.time[0])&&parseFloat(s.e.min)!==t.time_range.time[0])&&(s.e.min=t.time_range.time[0]+"",(e||!this.meta.retain_state||t.time_range.time[0]>a)&&(s.current_default=t.time_range.time[0],s.set(s.current_default))):"max"===i.type&&(e||isFinite(t.time_range.time[1])&&parseFloat(s.e.max)!==t.time_range.time[1])&&(s.e.max=t.time_range.time[1]+"",(e||!this.meta.retain_state||t.time_range.time[1]<a||a<t.time_range.time[0])&&(s.current_default=t.time_range.time[1],s.set(s.current_default)))})),this.conditionals.time_filters(t))}else t.time_range.dataset=a,t.time_range.index[0]=0,t.time_range.time[0]=t.time_range.filtered[0]=1,t.time_range.index[1]=0,t.time_range.time[1]=t.time_range.filtered[1]=1}))}});const D={rdylbu7:{name:"Red-Yellow-Blue (7)",type:"discrete",colors:["#d73027","#fc8d59","#fee090","#adadad","#e0f3f8","#91bfdb","#4575b4"]},orrd7:{name:"Orange-Red (7)",type:"discrete",colors:["#fef0d9","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#990000"]},gnbu7:{name:"Green-Blue (7)",type:"discrete",colors:["#a8ddb5","#ccebc5","#f0f9e8","#adadad","#4eb3d3","#2b8cbe","#08589e"]},brbg7:{name:"Brown-Teal (7)",type:"discrete",colors:["#8c510a","#d8b365","#f6e8c3","#adadad","#c7eae5","#5ab4ac","#01665e"]},puor7:{name:"Purple-Orange (7)",type:"discrete",colors:["#b35806","#f1a340","#fee0b6","#adadad","#d8daeb","#998ec3","#542788"]},prgn6:{name:"Purple-Green (6)",type:"discrete",colors:["#762a83","#af8dc3","#e7d4e8","#d9f0d3","#7fbf7b","#1b7837"]},reds5:{name:"Red (5)",type:"discrete",colors:["#f1eef6","#d7b5d8","#df65b0","#dd1c77","#980043"]},greens5:{name:"Green (5)",type:"discrete",colors:["#ffffcc","#c2e699","#78c679","#31a354","#006837"]},paired4:{name:"Blue-Green (4)",type:"discrete",colors:["#1f78b4","#a6cee3","#b2df8a","#33a02c"]},greys4:{name:"Grey (4)",type:"discrete",colors:["#f7f7f7","#cccccc","#969696","#525252"]},grey:{name:"Grey",type:"continuous",colors:[[[70,70,70],[80,80,80]],[150,150,150],[[230,230,230],[-80,-80,-80]]]},brown:{name:"Brown",type:"continuous",colors:[[[131,30,0],[62,85,95]],[193,115,95],[[255,200,190],[-62,-85,-95]]]},purple:{name:"Purple",type:"continuous",colors:[[[90,14,213],[52.5,89,16]],[142.5,103,229],[[195,192,245],[-52.5,-89,-16]]]},prgn:{name:"Purple-Green",type:"continuous-divergent",colors:[[[27,120,55],[207,107,168.5]],[234,227,223.5],[[118,42,131],[116,185,92.5]]]},puor:{name:"Purple-Orange",type:"continuous-divergent",colors:[[[179,88,6],[56,133,202.5]],[235,221,208.5],[[84,39,136],[151,182,72.5]]]},rdbu:{name:"Red-Blue",type:"continuous-divergent",colors:[[[69,117,180],[170,116.5,16]],[239,233.5,196],[[215,48,39],[24,185.5,157]]]},vik:{name:"vik",type:"continuous-polynomial",colors:[[97.031,18.4251,.4149],[461.7602,637.5326,244.4647],[-2434.798,-2838.5427,-5893.4695],[9665.3469,14405.823,44072.722],[-2575.9109,-25871.106,-109792.1319],[-42510.0569,8528.3288,120953.8594],[63342.3061,14006.291,-59644.4457],[-26045.0391,-8868.9621,10155.5667]]},lajolla:{name:"lajolla",type:"continuous-polynomial",colors:[[256.0016,255.9138,204.945],[-187.6735,-46.2889,-768.5655],[1022.785,-1057.5602,1782.0325],[-2032.382,1490.8271,-1785.9056],[966.8373,-617.1949,567.7715]]}};class P{constructor(e,t){if(this.input=!0,this.settings={},this.current_index=-1,this.previous="",this.state="initial",this.e=e,this.site=t,this.default=e.dataset.default,this.optionSource=e.dataset.optionsource,this.subset=e.dataset.subset||"all",this.selection_subset=e.dataset.selectionsubset||this.subset,this.depends=e.dataset.depends,this.variable=e.dataset.variable,this.dataset=e.dataset.dataset,this.view=e.dataset.view,this.id=e.id||this.optionSource||"ui"+t.page.elementCount++,this.note=e.getAttribute("aria-description")||"",this.type=e.dataset.autotype,this.type in t.spec){const e=t.spec[this.type];this.id in e&&(this.settings=e[this.id])}if(e.parentElement&&(this.wrapper=e.parentElement.classList.contains("wrapper")?e.parentElement:e.parentElement.parentElement),this.wrapper&&(this.note&&this.wrapper.classList.add("has-note"),this.wrapper.setAttribute("data-of",this.id),["div","span","label","fieldset","legend","input","button"].forEach((e=>{const t=this.wrapper.querySelectorAll(e);t.length&&t.forEach((e=>e.setAttribute("data-of",this.id)))}))),this.note){const t=R.bind(this);this.wrapper.addEventListener("mouseover",t);const i="DIV"!==e.tagName?e:e.querySelector("input");i&&(i.addEventListener("focus",t),i.addEventListener("blur",this.site.page.tooltip_clear))}t.patterns.number.test(this.default)&&(this.default=+this.default)}value(){if(Array.isArray(this.source))return this.source;const e=this.site.valueOf(this.source);return void 0===e?this.site.valueOf(this.default):e}set(e){this.source=e}reset(){this.set(this.site.valueOf(this.default))}}function H(){if(this.settings.filters){Object.keys(this.settings.filters).forEach((e=>{this.current_filter[e]=this.site.valueOf(this.settings.filters[e])}));let e="";Object.keys(this.values).forEach(((t,i)=>{let s=!1;if(t in this.site.data.variables&&"meta"in this.site.data.variables[t]){const e=this.site.data.variables[t].meta;for(const t in this.current_filter)if(t in e&&(s=e[t]===this.current_filter[t],!s))break}s&&!e&&(e=t),this.options[i].classList[s?"remove":"add"]("hidden")})),this.current_index=this.values[this.value()],e&&(-1===this.current_index||this.options[this.current_index].classList.contains("hidden"))&&this.set(e)}}function J(){const e=this.option_sets[this.dataset];this.values=e.values,this.display=e.display,this.options=e.options,this.groups=e.groups,this.source="",this.id in this.site.url_options?this.set(this.site.url_options[this.id]):this.state in this.values?this.set(this.state):this.reset()}function U(){this.e.classList.contains("locked")||(this.deferred=!1,this.e.removeEventListener("click",this.loader),this.site.request_queue(!1,this.id))}const G={number:function(e){return this-e.range[0]},first:function(e){return 0},selected:function(e,t){return t.time_agg-e.range[0]},last:function(e){return e.range[1]-e.range[0]}};function V(e,t){return"string"==typeof t&&q.number.test(t)&&-1===(t=e.indexOf(+t))?function(){return NaN}:"number"==typeof t?G.number.bind(t):t in G?G[t]:function(){return NaN}}class X{constructor(e,t,i){this.time_range={dataset:"",variable:"",filtered:[-1/0,1/0],filtered_index:[-1/0,1/0],index:[-1/0,1/0],time:[-1/0,1/0]},this.state="initial",this.valid={},this.parsed={dataset:"",ids:!1,features:"",variables:"",time_filters:"",time_agg:0,id_source:"",palette:"",variable_values:new Map,feature_values:{}},this.selection={ids:{},children:{},features:{},variables:{},dataset:{},filtered:{},full_filter:{},all:{}},this.n_selected={ids:0,children:0,features:0,variables:0,dataset:0,filtered:0,full_filter:0,all:0},this.site=e,this.id=t,this.update=this.update.bind(this),e.dataviews[t]=this,i&&Object.keys(i).forEach((e=>{this[e]=i[e]})),"string"==typeof this.palette&&this.palette in this.site.inputs&&this.site.add_dependency(this.palette,{type:"dataview",id:t}),"string"==typeof this.dataset&&this.dataset in this.site.inputs&&this.site.add_dependency(this.dataset,{type:"dataview",id:t}),"string"==typeof this.ids&&this.ids in this.site.inputs&&this.site.add_dependency(this.ids,{type:"dataview",id:t}),this.site.add_dependency(t,{type:"time_range",id:t}),this.site.add_dependency("view.filter",{type:"dataview",id:t}),this.site.add_dependency("view.id",{type:"dataview",id:t}),this.x in this.site.inputs&&this.site.add_dependency(this.x,{type:"time_range",id:t}),this.y in this.site.inputs&&this.site.add_dependency(this.y,{type:"time_range",id:t}),this.features&&Object.keys(this.features).forEach((e=>{const i=this.features[e];"string"==typeof i&&i in this.site.inputs&&this.site.add_dependency(i,{type:"dataview",id:t})})),this.variables&&this.variables.forEach((e=>{e.variable in this.site.inputs&&this.site.add_dependency(e.variable,{type:"dataview",id:t}),"type"in e||(e.type="="),e.type in this.site.inputs&&this.site.add_dependency(e.type,{type:"dataview",id:t}),"value"in e||(e.value=0),"string"==typeof e.value&&e.value in this.site.inputs&&this.site.add_dependency(e.value,{type:"dataview",id:t})})),this.compile()}value(){if(this.get)return this.reparse(),""+this.parsed.dataset+this.site.view.entities.size+this.site.data.inited[this.parsed.dataset]+this.parsed.id_source+Object.keys(this.parsed.ids)+this.parsed.features+this.parsed.variables+this.parsed.palette+this.site.spec.settings.summary_selection}update(){this.value()!==this.state&&this.site.view.registered[this.parsed.dataset]&&(this.site.data.inited[this.parsed.dataset]?(this.valid[this.parsed.dataset]=!0,this.n_selected.ids=0,this.n_selected.children=0,this.n_selected.features=0,this.n_selected.variables=0,this.n_selected.dataset=0,this.n_selected.filtered=0,this.n_selected.full_filter=0,this.n_selected.all=0,this.selection.ids={},this.selection.children={},this.selection.features={},this.selection.variables={},this.selection.dataset={},this.selection.filtered={},this.selection.full_filter={},this.selection.all={},this.site.view.filters.forEach((e=>{e.passed=0,e.failed=0})),this.site.view.entities.forEach((e=>{const t=this.check(e),i=e.features.id;t.ids&&(this.selection.ids[i]=e,this.n_selected.ids++,t.all++),t.features&&(this.selection.features[i]=e,this.n_selected.features++,t.all++),t.variables&&(this.selection.variables[i]=e,this.n_selected.variables++,t.all++),t.dataset&&(this.selection.dataset[i]=e,this.n_selected.dataset++,t.all++),t.dataset&&t.ids&&(this.selection.children[i]=e,this.n_selected.children++),t.features&&t.variables&&(this.selection.full_filter[i]=e,this.n_selected.full_filter++),t.variables&&t.features&&t.ids&&(this.selection.filtered[i]=e,this.n_selected.filtered++),4===t.all&&(this.selection.all[i]=e,this.n_selected.all++)})),this.site.request_queue(this.id)):(this.valid[this.parsed.dataset]=!1,this.site.data.data_queue[this.parsed.dataset][this.id]=this.update))}compile(){this.times=[],this.time_filters&&(this.time_filters=[{variable:this.site.defaults.time,type:">=",value:"filter.time_min"},{variable:this.site.defaults.time,type:"<=",value:"filter.time_max"}],this.site.add_dependency(this.id+"_time",{type:"min",id:"filter.time_min"}),this.site.add_dependency(this.id+"_time",{type:"max",id:"filter.time_max"}),this.time_filters.forEach((e=>{"string"==typeof e.value&&e.value in this.site.inputs&&this.site.add_dependency(e.value,{type:"time_filters",id:this.id})}))),this.get={dataset:()=>{let e=this.site.defaults.dataset;return"string"==typeof this.dataset&&this.dataset in this.site.inputs?(e=this.site.valueOf(this.site.inputs[this.dataset].value()),e in this.site.data.data_queue||(e=this.site.defaults.dataset,this.site.inputs[this.dataset].set(e))):e=this.site.valueOf(this.dataset),e in this.site.data.data_queue?e:this.site.defaults.dataset},single_id:()=>{const e=this.site.valueOf("string"==typeof this.ids&&this.ids in this.site.inputs?this.site.inputs[this.ids].value():this.ids);return"string"==typeof e?e:""},ids:()=>{const e=this.site.valueOf("string"==typeof this.ids&&this.ids in this.site.inputs?this.site.inputs[this.ids].value():this.ids);if("string"==typeof e&&""!==e&&"-1"!==e){const t={},i=this.site.data.entities[e];return t[e]=!0,i&&i.relations&&Object.keys(i.relations.children).forEach((e=>t[e]=!0)),t}return!!this.site.view.selected.length&&this.site.view.select_ids},features:()=>{let e="";return this.features&&Object.keys(this.features).forEach((t=>{e+=t+this.site.valueOf(this.features[t])})),e},variables:()=>{if(this.variables||this.site.view.filters.size){this.parsed.variable_values.size||this.reparse();let e="";return this.parsed.variable_values.forEach((t=>{t.filter.summary.update(),e+=t.name+t.operator+t.component+t.value+t.active})),e}return""},time_filters:()=>{let e="";return this.time_filters&&this.time_filters.forEach((t=>{e+=t.value in this.site.inputs?this.site.valueOf(t.value):t.value})),e}},this.checks={dataset:e=>this.parsed.dataset===e.group,ids:e=>e.features&&this.ids_check(this.parsed.ids,e.features.id),features:e=>{if(e.features){let t,i,s=!0;for(t in this.parsed.feature_values)if(t in this.parsed.feature_values&&(i=this.parsed.feature_values[t],s=k.checks[i.operator](i.value,this.site.valueOf(e.features[t])),!s))break;return s}return!0},variables:e=>{if(e.data){let t=!0;return this.parsed.variable_values.forEach((i=>{if(i.active&&!isNaN(+i.value)){const s=e.get_value(i.name,i.comp_fun(i,this.parsed)),a=!isNaN(s)&&k.checks[i.operator](s,i.value);i.filter[a?"passed":"failed"]++,t&&!a&&(t=!1)}else i.filter.failed++})),t}return!0}}}ids_check(e,t){return!e||t in e}check(e){return{ids:!this.ids||this.checks.ids(e),features:!this.features||this.checks.features(e),variables:!this.variables&&!this.site.view.filters.size||this.checks.variables(e),dataset:!this.dataset||this.checks.dataset(e),all:0}}reparse(){if(this.parsed.dataset=this.get.dataset(),this.parsed.ids=this.get.ids(),this.parsed.time_filters=this.get.time_filters(),this.parsed.time_agg=this.parsed.dataset in this.site.data.meta.times?this.site.valueOf(this.time_agg)-this.site.data.meta.times[this.parsed.dataset].range[0]:0,"string"==typeof this.ids){const e=this.site.inputs[this.ids];this.ids in this.site.inputs&&("virtual"===e.type&&e.source in this.site.inputs||"depends"in e&&e.depends in this.site.inputs)&&(this.parsed.id_source="virtual"===e.type?this.site.valueOf(this.site.inputs[e.source].dataset):this.site.inputs[e.depends].value())}this.palette&&(this.parsed.palette=this.site.valueOf(this.palette)),this.features?(this.parsed.feature_values={},Object.keys(this.features).forEach((e=>{const t=this.site.valueOf(this.features[e]);this.parsed.feature_values[e]={value:t,operator:"string"==typeof t?"equals":"includes"}})),this.parsed.features=this.get.features()):this.parsed.features="",this.parsed.variable_values.clear(),this.site.view.filters.size&&this.site.view.filters.forEach((e=>{this.parsed.variable_values.set(e.id,{filter:e,name:e.variable,range:this.site.data.variables[e.variable].info[this.parsed.dataset].time_range,operator:e.operator,value:e.value?+e.value:NaN,value_type:"number",component:e.component,active:e.active,comp_fun:V(this.site.data.meta.overall.value,e.component)})})),this.variables||this.parsed.variable_values.size?(this.variables&&this.variables.forEach((e=>{const t=this.site.valueOf(e.value);this.parsed.variable_values.set(this.parsed.variable_values.size+"",{name:e.variable,operator:e.operator,value:t,component:e.component,active:!0,comp_fun:V(this.site.data.meta.overall.value,e.component)})})),this.parsed.variables=this.get.variables()):this.parsed.variables=""}}class Q extends P{constructor(e,t){if(super(e,t),this.type="combobox",this.hover_index=-1,this.cleared_selection="",this.expanded=!1,this.container=document.createElement("div"),this.current_filter={},this.values={},this.display={},this.options=[],this.option_sets={},this.current_set="",this.sensitive=!1,this.filter=H,this.reformat_label=!1,this.set_current=J,this.set=this.set.bind(this),this.reset=this.reset.bind(this),this.resize=this.resize.bind(this),this.toggle=this.toggle.bind(this),this.highlight=this.highlight.bind(this),this.filterer=this.filterer.bind(this),this.close=this.close.bind(this),this.set_selected=this.set_selected.bind(this),this.settings.use_display=this.settings.search||this.settings.multi,this.listbox=this.e.parentElement.children[1],this.options=[...this.listbox.querySelectorAll(".combobox-option")],this.optionSource&&this.site.patterns.ids.test(this.optionSource)&&(this.loader=U.bind(this),e.addEventListener("click",this.loader),this.deferred=!0),this.options.length){this.reformat_label=!0,this.options.forEach(((e,t)=>{this.values[e.dataset.value]=t,this.reformat_label&&(this.reformat_label=e.dataset.value===e.innerText)}));const e=this.listbox.querySelectorAll(".combobox-group");e.length&&(this.groups={e:[],by_name:{}},e.forEach((e=>{const t=e.dataset.group;this.groups.e.push(e),this.groups.by_name[t]=e})))}this.container.className="combobox-options-container combobox-component hidden",this.site.page.overlay.appendChild(this.container),this.container.appendChild(this.listbox),this.selection=this.e.firstElementChild.firstElementChild,this.input_element=this.e.firstElementChild.lastElementChild,2===this.e.childElementCount&&this.e.lastElementChild.addEventListener("click",function(){this.e.classList.contains("locked")||(this.cleared_selection="",this.set([]),this.input_element.focus())}.bind(this)),this.input_element.addEventListener("focus",function(){this.classList.add("focused")}.bind(this.e)),this.input_element.addEventListener("blur",function(){this.classList.remove("focused")}.bind(this.e)),this.listbox.addEventListener("click",this.set),window.addEventListener("resize",this.resize),this.e.addEventListener("mousedown",this.toggle),this.listbox.addEventListener("mouseover",this.highlight),this.settings.accordion&&this.listbox.addEventListener("show.bs.collapse",(e=>{const t=-1===this.hover_index?"":this.options[this.hover_index].dataset.group,i=e.target;t!==i.dataset.group&&(i.firstElementChild.firstElementChild.dispatchEvent(new MouseEvent("mouseover")),this.input_element.focus())})),this.settings.search&&this.input_element.addEventListener("keyup",this.filterer),this.input_element.addEventListener("keydown",function(e){const t=A[e.code];if(t){if("close"===t)this.close();else if("select"===t){if(!this.expanded)return this.toggle(void 0,this.input_element);this.set(e)}else if("move"===t){const t=this.input_element.value;this.settings.strict||this.expanded&&""===t?(e.preventDefault(),"ArrowUp"===e.code?this.filter_index&&this.filter_index.length?(this.hover_index=this.filter_index.indexOf(this.hover_index)-1,this.hover_index=this.filter_index[0>this.hover_index?0:this.hover_index]):this.hover_index=Math.max(0,this.hover_index-1):"ArrowDown"===e.code?this.filter_index&&this.filter_index.length?(this.hover_index=this.filter_index.indexOf(this.hover_index)+1,this.hover_index=this.filter_index[this.filter_index.length-1<this.hover_index?this.filter_index.length-1:this.hover_index]):this.hover_index=Math.min(this.options.length-1,this.hover_index+1):"Home"===e.code?this.hover_index=0:"End"===e.code&&(this.hover_index=this.options.length-1),this.expanded?this.highlight():this.set(this.hover_index)):this.site.patterns.number.test(t)&&this.set(+t+("ArrowUp"===e.code?1:-1))}}else this.expanded?this.clear_highlight():this.toggle(void 0,this.input_element)}.bind(this))}init(){this.options.forEach(((e,t)=>{this.reformat_label&&(e.innerText=this.site.data.format_label(e.dataset.value)),this.display[e.innerText]=t}))}filterer(){const e=this.input_element.value.toLowerCase();""===e?this.filter_reset():(this.filter_index=[],this.groups&&this.groups.e.forEach((e=>e.firstElementChild.firstElementChild.classList.add("hidden"))),this.options.forEach(((t,i)=>{if(!t.classList.contains("hidden")&&t.innerText.toLowerCase().includes(e)){t.classList.remove("filter-hidden"),this.filter_index.push(i);const e=t.dataset.group;if(e&&(this.groups.by_name[e].firstElementChild.firstElementChild.classList.remove("hidden"),this.settings.accordion)){const t=this.groups.by_name[e];t.firstElementChild.nextElementSibling.classList.add("show"),t.firstElementChild.firstElementChild.classList.remove("collapsed"),t.firstElementChild.firstElementChild.setAttribute("aria-expanded","true")}}else t.classList.add("filter-hidden")})))}highlight(e,t){if(e&&!t&&(t=e.target),!t||t.dataset.value in this.values){this.groups||(this.settings.accordion=!1),t&&t.dataset.value?this.hover_index=this.values[t.dataset.value]:-1===this.hover_index&&Array.isArray(this.source)&&(this.hover_index=this.values[this.source[0]]),void 0===this.hover_index&&(this.hover_index=-1);const i=this.options[this.hover_index];if(i){const s=this.listbox.querySelector(".highlighted");if(s&&s.classList.remove("highlighted"),e&&"mouseover"===e.type)t.classList.add("highlighted");else{if(i.classList.add("highlighted"),this.settings.accordion){const e=i.parentElement.parentElement;e.classList.contains("show")||(e.classList.add("show"),e.previousElementSibling.firstElementChild.classList.remove("collapsed"),e.previousElementSibling.firstElementChild.setAttribute("aria-expanded","true"))}this.input_element.setAttribute("aria-activedescendant",i.id);const e=this.container.getBoundingClientRect(),t=i.getBoundingClientRect();let s=e.top;this.groups&&i.dataset.group&&(s+=this.groups.by_name[i.dataset.group].firstElementChild.getBoundingClientRect().height),s>t.top?this.container.scrollTo(0,this.container.scrollTop+t.top-s):e.bottom<t.bottom&&this.container.scrollTo(0,this.container.scrollTop+t.bottom-e.bottom)}}}}toggle(e,t){e&&!t&&(t=e.target),!t||e&&e.button||this.e.classList.contains("disabled")||"BUTTON"===t.tagName||(this.expanded?t!==this.input_element&&this.close():(this.site.spec.combobox&&Object.keys(this.site.spec.combobox).forEach((e=>{if(e!==this.id){const t=this.site.inputs[e];t.expanded&&t.close()}})),this.container.classList.remove("hidden"),""!==this.selection.innerText&&(this.cleared_selection=this.selection.innerText),this.cleared_selection in this.display&&this.highlight(void 0,this.options[this.display[this.cleared_selection]]),this.settings.use_display&&(this.selection.innerText=""),window.addEventListener("click",this.close),this.e.setAttribute("aria-expanded","true"),e&&e.target===this.input_element||setTimeout((()=>this.input_element.focus()),0),this.resize(),this.expanded=!0))}value(){return this.source?this.settings.multi?this.source:Array.isArray(this.source)&&this.source.length?this.source[0]:"":this.site.valueOf(this.default)}close(e){!this.expanded||e&&e.target.classList&&e.target.classList.contains("combobox-component")||(this.settings.use_display&&""===this.selection.innerText&&Array.isArray(this.source)&&this.source.length&&(this.selection.innerText=this.cleared_selection),""!==this.input_element.value&&setTimeout(this.set,0),this.e.setAttribute("aria-expanded","false"),this.expanded=!1,this.container.classList.add("hidden"),window.removeEventListener("click",this.close))}resize(){const e=this.e.getBoundingClientRect();this.container.style.left=e.x+"px",this.container.style.width=e.width+"px",window.screen.height/2>e.y?(this.container.style.top=e.y+e.height+"px",this.container.style.bottom=""):(this.container.style.top="",this.container.style.bottom=-e.y+"px")}clear_highlight(){-1!==this.hover_index&&(this.options[this.hover_index].classList.remove("highlighted"),this.hover_index=-1)}filter_reset(){this.groups&&this.groups.e.forEach((e=>{(this.settings.accordion?e.firstElementChild.firstElementChild:e).classList.remove("hidden")})),this.input_element.value="",this.filter_index=[],this.options.forEach(((e,t)=>{e.classList.contains("hidden")||this.filter_index.push(t)})),this.listbox.querySelectorAll(".filter-hidden").forEach((e=>e.classList.remove("filter-hidden")))}set_selected(e){if(e in this.values){const t=this.options[this.values[e]];t.classList.add("selected"),t.setAttribute("aria-selected","true")}}static create(e,t,i,s,a){a=a||"created_combobox_"+ ++e.page.elementCount;const n=document.createElement("div");let r=document.createElement("div"),l=document.createElement("div"),o=document.createElement("input"),d=document.createElement("label");if(s&&(e.spec.combobox||(e.spec.combobox={}),e.spec.combobox[a]=s),r.className="wrapper combobox-wrapper",s&&s.floating&&(r.appendChild(l),l.className="form-floating",l.dataset.of=a,r=l),r.appendChild(n),n.id=a,n.dataset.autotype="combobox",n.className="auto-input form-select combobox combobox-component",n.role="combobox",n.appendChild(l=document.createElement("div")),l.className="combobox-selection combobox-component",l.appendChild(document.createElement("span")),l.lastElementChild.className="combobox-component",l.lastElementChild.setAttribute("aria-live","assertive"),l.lastElementChild.setAttribute("aria-atomic","true"),l.lastElementChild.role="log",l.appendChild(o),o.setAttribute("aria-haspopup","listbox"),o.setAttribute("aria-expanded","false"),o.setAttribute("aria-controls",a+"-listbox"),o.className="combobox-input combobox-component",o.type="text",o.role="combobox",o.id=a+"-input",o.autocomplete="off",s&&s.clearable){const e=document.createElement("button");r.firstElementChild.appendChild(e),e.type="button",e.className="btn-close",e.title="clear selection"}r.appendChild(l=document.createElement("div")),l.className="combobox-options combobox-component",l.setAttribute("aria-labelledby",a+"-label"),l.role="listbox",l.tabIndex=-1,l.id=a+"-listbox",r.appendChild(d),d.id=a+"-label",d.innerText=t,d.setAttribute("for",a+"-input");const h=new Q(n,e);e.inputs[a]=h;let c=0;return i&&(Array.isArray(i)?i.forEach((t=>{const i=e.data.format_label(t);h.display[i]=c,h.values[t]=c++,h.add(t,i)})):(h.groups={e:[],by_name:{}},Object.keys(i).forEach((e=>{const t=i[e],s=document.createElement("div"),a=h.id+"_group_"+e.replace(q.seps,"-");s.dataset.group=e,s.className="combobox-group combobox-component",s.setAttribute("aria-labelledby",a),s.appendChild(d=document.createElement("label")),d.dataset.for=a,d.innerText=e,d.id=a,d.className="combobox-group-label combobox-component",h.groups.by_name[e]=s,h.groups.e.push(s),t.forEach((e=>s.appendChild(h.add(e,e,!0)))),h.listbox.appendChild(s)})),Object.keys(h.groups.by_name).forEach((e=>{h.groups.by_name[e].querySelectorAll(".combobox-option").forEach((t=>{h.options.push(t),t.dataset.group=e,h.values[t.dataset.value]=c,h.display[t.innerText]=c++}))})))),h}get(){const e=[];this.listbox.querySelectorAll(".selected").forEach((t=>e.push(t.dataset.value))),this.source=e,this.site.request_queue(!1,this.id)}set(e,t){"number"==typeof e||e||(e=this.input_element.value);let i=!1,s=-1;if(!Array.isArray(e)&&"object"==typeof e){const i=e.target;if((this.settings.accordion?"BUTTON":"LABEL")===i.tagName)return;s=this.hover_index,-1!==s&&(this.options[s].classList.contains("hidden")||this.options[s].classList.contains("filter-hidden"))&&(s=-1),e=-1===s?"INPUT"===i.tagName?this.input_element.value:i.dataset.value||i.innerText:this.options[s].dataset.value||this.options[s].innerText,t=this.settings.multi}if(this.filter_reset(),Array.isArray(e)&&(this.settings.multi?(this.listbox.querySelectorAll(".selected").forEach((e=>{e.classList.remove("selected"),e.setAttribute("aria-selected","false")})),this.source=-1===e[0]?[]:e,e.forEach(this.set_selected),i=!0):e=e[0]),Array.isArray(this.source)||(this.source=[]),!Array.isArray(e))if(this.settings.strict&&"string"==typeof e&&!(e in this.values)&&this.site.patterns.number.test(e)&&(e=+e),"number"!==this.value_type&&"number"==typeof e&&this.options[e]&&(e=this.options[e].dataset.value),"string"==typeof e&&e in this.display&&(e=this.options[this.display[e]].dataset.value),this.settings.strict&&!(e in this.values)&&(e=this.default),s=this.source.indexOf(e),-1===s){if(i=!0,-1===e||""===e?this.source=[]:this.settings.multi?this.source.push(e):this.source[0]=e,e in this.values){if(!this.settings.multi){const e=this.listbox.querySelector(".selected");e&&(e.classList.remove("selected"),e.setAttribute("aria-selected","false"))}this.set_selected(e)}}else if(t&&(i=!0,this.source.splice(s,1),e in this.values)){const t=this.options[this.values[e]];t.classList.remove("selected"),t.setAttribute("aria-selected","false")}!this.settings.multi&&this.expanded&&(this.input_element.focus(),this.close(),this.filter_reset());let a=this.source.length?this.settings.multi?this.source.length+" of "+this.options.length+" selected":this.source[0]in this.values?this.options[this.values[this.source[0]]]:this.settings.strict||-1===this.source[0]?"":this.source[0]+"":"";"string"!=typeof a&&(a=a.firstChild?a.firstChild.textContent:a.innerText),this.settings.use_display?this.selection.innerText=a:this.input_element.value=a,this.onchange&&this.onchange(),i&&this.site.request_queue(!1,this.id)}add(e,t,i,s){const a=document.createElement("div");return a.id=this.id+"_"+e,a.role="option",a.setAttribute("aria-selected","false"),a.tabIndex=0,a.className="combobox-option combobox-component",a.dataset.value=e,a.innerText=t||this.site.data.format_label(e),s&&s.info&&(a.appendChild(document.createElement("p")),a.lastElementChild.className="combobox-option-description combobox-component",a.lastElementChild.innerText=s.info.description||s.info.short_description||""),i||(this.listbox.appendChild(a),this.options.push(a)),a}}class Y{constructor(e,t,i){this.container=document.createElement("div"),this.backdrop=document.createElement("div"),this.highlight=document.createElement("div"),this.menu=document.createElement("div"),this.frame=document.createElement("div"),this.header=document.createElement("p"),this.dialog=document.createElement("p"),this.timer=document.createElement("div"),this.progress=document.createElement("div"),this.continue=document.createElement("button"),this.in_progress="",this.waiting=!1,this.current_step=0,this.current_time=0,this.tutorials=e,this.site_elements=t||{},this.site_reset=i||(()=>{}),this.start_tutorial=this.start_tutorial.bind(this),this.progress_tutorial=this.progress_tutorial.bind(this),this.execute_step=this.execute_step.bind(this),this.end_tutorial=this.end_tutorial.bind(this),document.body.appendChild(this.menu),this.menu.id="community_tutorials_menu",this.menu.className="modal fade",this.menu.tabIndex=-1;let s=document.createElement("div");this.menu.appendChild(s),s.className="modal-dialog modal-dialog-scrollable",s.appendChild(s=document.createElement("div")),s.className="modal-content",s.appendChild(s=document.createElement("div")),s.className="modal-header",s.appendChild(s=document.createElement("p")),s.className="modal-title h5",s.innerText="Tutorials";let a=document.createElement("button");s.insertAdjacentElement("afterend",a),a.type="button",a.className="btn-close",a.setAttribute("data-bs-dismiss","modal"),a.setAttribute("aria-label","Close");const n=document.createElement("div");this.menu.lastElementChild.lastElementChild.appendChild(n),n.className="modal-body",Object.keys(e).forEach((t=>{const i=e[t],s=document.createElement("div"),a=document.createElement("div"),r=document.createElement("button");i.manager=this,i.n_steps=i.steps.length;let l=document.createElement("div");if(n.appendChild(s),s.className="tutorial-listing card",s.appendChild(l),l.className="card-header",l.innerText=i.title||t,s.appendChild(l=document.createElement("div")),l.className="card-body",l.appendChild(a),a.appendChild(document.createElement("p")),a.firstElementChild.innerText=i.description||"",i.steps.length&&i.steps[0].before&&!Array.isArray(i.steps[0].before)){const e=i.steps[0].before,t=document.createElement("div"),s=document.createElement("span");t.className="tutorial-initial-settings",t.appendChild(s),s.innerText="Initial Settings",s.className="h6",Object.keys(i.steps[0].before).forEach(((i,s)=>{const a=document.createElement("p");let n=document.createElement("span");n.className="syntax-variable",n.innerText=i.replace(q.settings,""),a.appendChild(n),n=document.createElement("span"),n.className="syntax-operator",n.innerText=" = ",a.appendChild(n),n=document.createElement("span"),n.className="syntax-value",n.innerText=e[i],a.appendChild(n),t.appendChild(a)})),a.appendChild(t)}l.appendChild(r),r.type="button",r.className="btn",r.innerText="Start",r.dataset.name=t,r.addEventListener("click",this.start_tutorial)})),document.body.appendChild(this.container),this.container.appendChild(this.backdrop),this.container.className="tutorial-container hidden",this.container.addEventListener("keyup",this.progress_tutorial),this.backdrop.addEventListener("click",this.progress_tutorial),this.backdrop.className="tutorial-backdrop",this.container.appendChild(this.highlight),this.highlight.className="tutorial-highlight",this.highlight.addEventListener("click",this.progress_tutorial),this.container.appendChild(this.frame),this.frame.className="tutorial-frame",this.frame.style.left="50%",this.frame.tabIndex=-1,this.frame.appendChild(s=document.createElement("div")),this.frame.id="community_tutorial_frame",this.frame.role="dialog",this.frame.setAttribute("aria-labelledby","community_tutorial_description"),s.className="tutorial-step card",s.appendChild(s=document.createElement("div")),s.className="card-header",s.appendChild(this.header),this.header.className="card-title",this.header.id="community_tutorial_title",a=document.createElement("button"),s.appendChild(a),a.type="button",a.className="btn-close",a.setAttribute("aria-label","Close Tutorial"),a.addEventListener("click",this.end_tutorial),this.frame.firstElementChild.appendChild(s=document.createElement("div")),s.className="card-body",s.appendChild(this.dialog),this.dialog.role="status",this.dialog.id="community_tutorial_description",this.dialog.setAttribute("aria-labelledby","community_tutorial_progress"),this.dialog.setAttribute("aria-live","polite"),s.lastElementChild.className="card-text",this.frame.firstElementChild.appendChild(s=document.createElement("div")),s.className="tutorial-footer card-footer",s.appendChild(this.progress),this.progress.role="progressbar",this.progress.id="community_tutorial_progress",s.appendChild(this.timer),this.timer.role="timer",s.appendChild(this.continue),this.continue.addEventListener("click",this.progress_tutorial),this.continue.type="button",this.continue.className="btn",this.continue.innerText="Next",this.continue.setAttribute("aria-controls","community_tutorial_frame")}retrieve_element(e){let t;if(e in this.site_elements)this.current_site_element=this.site_elements[e],t=this.current_site_element.e;else if("nav:"===e.substring(0,4).toLowerCase()){const i=e.replace(q.pre_colon,"");document.querySelectorAll(".nav-item button").forEach((e=>{i===e.innerText&&(t=e)}))}else try{t=document.querySelector(e.replace(q.id_escapes,"\\$1"))}catch(e){}return t}start_tutorial(e,t){if(this.end_tutorial(),document.querySelectorAll("[data-bs-dismiss]").forEach((e=>e.click())),this.in_progress=t||e.target.dataset.name,!(this.in_progress in this.tutorials))return console.error("tutorial does not exist:",this.in_progress),void(this.in_progress="");this.container.classList.remove("hidden"),this.header.innerText=this.tutorials[this.in_progress].title||this.in_progress,this.current_step=0,this.current_time=0,this.dialog.innerText="Starting tutorial "+this.header.innerText,this.timer.innerText="",this.continue.innerText="Next",this.tutorials[this.in_progress].reset&&this.site_reset(),this.progress_tutorial()}progress_tutorial(e){const t=!e||!e.code;if(t||"Escape"!==e.code||this.end_tutorial(),this.in_progress&&!this.waiting&&(t||"Enter"===e.code||"ArrowRight"===e.code)){this.waiting=!0,clearTimeout(this.focuser),clearInterval(this.running_timer);const e=this.tutorials[this.in_progress];let t;const i=e=>{Object.keys(e).forEach((t=>{q.number.test(t)?a(e[t]):t in this.site_elements&&this.site_elements[t].set&&this.site_elements[t].set(e[t])}))},s=e=>{if(this.current_site_element&&this.current_site_element.set)this.current_site_element.set(e);else{const t="value"in this.current_element?this.current_element:this.current_element.querySelector("input");t&&(t.value=e,t.dispatchEvent(new Event("change")),t.dispatchEvent(new KeyboardEvent("keydown",{code:"Enter"})))}},a=e=>{if("set"===e)"option"in t&&s(t.option);else if("click"===e){const t=this.current_site_element;t?e===t.id&&"toggle"in t?t.expanded||t.toggle(void 0,t.e):t.e.click():this.current_element&&this.current_element.click()}else if("close"===e)document.querySelectorAll("[data-bs-dismiss]").forEach((e=>e.click()));else if("value"===e.substring(0,5))s(e.replace(q.pre_colon,"").trimStart());else{const t=this.retrieve_element(e);t&&t.click()}};this.current_step>0&&(t=e.steps[this.current_step-1],"after"in t&&(Array.isArray(t.after)?t.after.forEach(a):i(t.after))),this.current_step>=e.n_steps?this.end_tutorial():(this.current_site_element=void 0,t=e.steps[this.current_step],this.current_element=this.retrieve_element(t.focus),"before"in t&&(Array.isArray(t.before)?t.before.forEach(a):i(t.before)),this.current_step===e.n_steps-1&&(this.continue.innerText="Finish"),this.current_element&&this.current_element.scrollIntoView&&this.current_element.scrollIntoView(),setTimeout(this.execute_step,"wait"in t?t.wait:400))}}execute_step(){if(this.in_progress){const e=this.tutorials[this.in_progress],t=e.steps[this.current_step];if(!this.current_element){const e=this.retrieve_element(t.focus);return e?(this.current_element=e,e.scrollIntoView&&e.scrollIntoView(),void setTimeout(this.execute_step,0)):(console.error("failed to retrieve element",t.focus),this.end_tutorial())}this.continue.disabled=!!t.disable_continue;const i=this.current_element.getBoundingClientRect(),s=this.frame.getBoundingClientRect();this.highlight.style.top=i.top+"px",this.highlight.style.left=i.left+"px",this.highlight.style.width=i.width+"px",this.highlight.style.height=i.height+"px",this.frame.style.top=(i.y<screen.availHeight/2?i.y+i.height+10:i.y-s.height-10)+"px",this.frame.style.marginLeft=-s.width/2+"px",t.time?(this.current_time=t.time,this.timer.innerText=t.time+"",this.running_timer=setInterval((()=>{this.current_time--,this.timer.innerText=this.current_time+"",this.current_time<=0&&(clearInterval(this.running_timer),this.progress_tutorial())}),1e3)):this.timer.innerText="",this.progress.innerText="Step "+(this.current_step+1)+" of "+e.n_steps,this.dialog.innerText=t.description,this.current_step++,this.waiting=!1,this.focuser=setTimeout((()=>this.continue.focus()),0)}}end_tutorial(){this.in_progress="",this.current_step=0,this.container.classList.add("hidden"),this.waiting=!1,clearTimeout(this.focuser)}}function K(e){Array.isArray(e.author)||(e.author=[e.author]);const t=document.createElement("li"),i=e.author.length;let s="",a=1===i?"":2===i?" & ":", & ",n=document.createElement("span");for(let t=i;t--;){const i=e.author[t];s=(t?a:"")+("string"==typeof i?i:i.family+(i.given?", "+i.given.substring(0,1)+".":""))+s,a=", "}if(t.innerText=s+" ("+e.year+"). "+e.title+".",e.journal&&(t.appendChild(n),n.innerText=e.journal+(e.volume?", "+e.volume:""),n.style.fontStyle="italic",t.appendChild(n=document.createElement("span")),n.innerText=(e.page?", "+e.page:"")+"."),e.version&&(t.appendChild(n=document.createElement("span")),n.innerText=" Version "+e.version+"."),e.doi||e.url){t.appendChild(n=document.createElement("span")),n.innerText=e.doi?" doi: ":" url: ";const i=document.createElement("a");t.appendChild(i),i.rel="noreferrer",i.target="_blank",i.href=e.doi?"https://doi.org/"+e.doi:e.url,i.innerText=e.doi||e.url.replace(q.http,"")}return t}class W{constructor(e,t){this.timeout=-1,this.e=e,this.wrapper=e.parentElement,this.page=t,this.hide=this.hide.bind(this),this.toggle=this.toggle.bind(this);const i="BUTTON"===e.lastElementChild.tagName;i&&(this.toggler=e.lastElementChild),e.classList.contains("menu-top")?(this.side="top",t.top_menu=this,e.style.left=t.content_bounds.left+"px",e.style.right=t.content_bounds.right+"px",i&&(this.toggler.addEventListener("click",this.toggle),this.toggler.style.top=t.content_bounds.top+"px")):e.classList.contains("menu-right")?(this.side="right",t.right_menu=this,e.style.right=t.content_bounds.right+"px",i&&(this.toggler.addEventListener("click",this.toggle),this.toggler.style.top=t.content_bounds.top+"px")):e.classList.contains("menu-bottom")?(this.side="bottom",t.bottom_menu=this,t.content_bounds.bottom=40,t.bottom_menu.e.style.left=t.content_bounds.left+"px",t.bottom_menu.e.style.right=t.content_bounds.right+"px",i&&this.toggler.addEventListener("click",this.toggle)):e.classList.contains("menu-left")&&(this.side="left",t.left_menu=this,e.style.left=t.content_bounds.left+"px",i&&(this.toggler.addEventListener("click",this.toggle),this.toggler.style.top=t.content_bounds.top+"px"))}hide(){this.timeout=-1,this.e.firstElementChild.classList.add("hidden"),this.page.resize()}toggle(){if(-1!==this.timeout&&clearTimeout(this.timeout),this.timeout=-1,"closed"===this.e.dataset.state)this.e.dataset.state="open",this.e.firstElementChild.classList.remove("hidden"),this.e.style[this.side]="0px",this.page.content.style[this.side]=this.e.getBoundingClientRect()["left"===this.side||"right"===this.side?"width":"height"]+"px","top"!==this.side&&"bottom"!==this.side||(this.toggler.style[this.side]=this.page.content_bounds[this.side]+"px"),setTimeout(this.page.trigger_resize,300);else{if(this.e.dataset.state="closed","left"===this.side||"right"===this.side)this.e.style[this.side]=-this.e.getBoundingClientRect().width+"px",this.page.content.style[this.side]=this.page.content_bounds[this.side]+"px";else{const e=this.e.getBoundingClientRect();this.page.content.style[this.side]=this.page.content_bounds[this.side]+("top"===this.side?40:0)+"px",this.e.style[this.side]=-e.height+("top"===this.side?this.page.content_bounds.top:0)+"px","top"!==this.side&&"bottom"!==this.side||(this.toggler.style[this.side]=e.height+"px")}this.timeout=setTimeout(this.hide,300)}}}class Z{constructor(e){this.menus=[],this.overlay=document.createElement("div"),this.selection=document.createElement("span"),this.script_style=document.createElement("style"),this.modal={info:{init:!1,e:document.createElement("div"),header:document.createElement("div"),body:document.createElement("div"),title:document.createElement("div"),description:document.createElement("div"),name:document.createElement("tr"),type:document.createElement("tr"),sources:document.createElement("div"),references:document.createElement("div"),origin:document.createElement("div"),source_file:document.createElement("div")},filter:{init:!1,e:document.createElement("div"),header:document.createElement("div"),body:document.createElement("div"),conditions:document.createElement("table"),variable_filters:document.createElement("div"),entity_filters:document.createElement("div"),entity_inputs:{},time_range:document.createElement("div")}},this.tooltip={showing:"",e:document.createElement("div")},this.content_bounds={top:0,right:0,bottom:0,left:0,outer_right:0},this.elementCount=0,this.site=e,this.render_credits=this.render_credits.bind(this),this.show_variable_info=this.show_variable_info.bind(this),this.tooltip_clear=this.tooltip_clear.bind(this),this.site.page=this,this.load_screen=document.getElementById("load_screen")||document.createElement("div"),this.wrap=document.getElementById("site_wrap")||document.createElement("div");const t=document.querySelector(".navbar");if(t){if(this.navbar=t.getBoundingClientRect(),t.querySelectorAll("button").forEach((e=>{const t=document.querySelector(e.getAttribute("data-bs-target"));t&&"false"===t.getAttribute("data-bs-backdrop")&&(t.addEventListener("show.bs.offcanvas",function(){this.content_bounds.outer_right=t.getBoundingClientRect().width,this.resize(!0),setTimeout(this.trigger_resize,200)}.bind(this)),t.addEventListener("hide.bs.offcanvas",function(){this.content_bounds.outer_right=0,this.resize(!0),setTimeout(this.trigger_resize,200)}.bind(this)))})),"navcolor"in e.url_options&&(""===e.url_options.navcolor&&(e.url_options.navcolor=window.location.hash),t.style.backgroundColor=e.url_options.navcolor.replace("%23","#")),e.url_options.hide_logo&&e.url_options.hide_title&&e.url_options.hide_navcontent)t.classList.add("hidden");else{const t=document.querySelector(".navbar-brand");if(t&&(e.url_options.hide_logo&&"IMG"===t.firstElementChild.tagName&&t.firstElementChild.classList.add("hidden"),e.url_options.hide_title&&"IMG"!==t.lastElementChild.tagName&&t.lastElementChild.classList.add("hidden")),e.url_options.hide_navcontent){document.querySelector(".navbar-toggler").classList.add("hidden");const e=document.querySelector(".navbar-nav");e&&e.classList.add("hidden")}}e.url_options.hide_panels&&this.panels.length&&this.panels.forEach((e=>e.classList.add("hidden")))}else this.navbar={height:0};this.content=document.querySelector(".content")||document.createElement("div"),this.panels=document.querySelectorAll(".panel"),this.init_panel=this.init_panel.bind(this),this.resize=this.resize.bind(this),window.addEventListener("resize",this.resize),this.tooltip.e.className="tooltip hidden",this.tooltip.e.appendChild(document.createElement("p")),document.head.appendChild(this.script_style),document.body.appendChild(this.tooltip.e),document.body.addEventListener("mouseover",this.tooltip_clear),this.overlay.className="content-overlay",document.body.appendChild(this.overlay),document.body.className=this.site.storage.get("theme_dark")||this.site.spec.settings.theme_dark?"dark-theme":"light-theme",this.content_bounds.top=this.navbar.height,this.init_variable_info(),this.init_filter(),document.querySelectorAll("[data-autotype=credits]").forEach(this.render_credits),e.spec.tutorials&&(this.tutorials=new Y(e.spec.tutorials,e.inputs,e.global_reset),this.overlay.appendChild(this.tutorials.container))}init(){this.panels.length&&this.panels.forEach(this.init_panel),document.querySelectorAll(".menu-wrapper").forEach((e=>{const t=new W(e,this);this.menus.push(t),this.site.url_options.close_menus&&"open"===t.wrapper.dataset.state&&t.toggler.click()})),this.content&&(this.content.style.top=(this.top_menu?this.top_menu.e.getBoundingClientRect().height:this.navbar.height)+"px"),Object.keys(this.site.data.loaded).reverse().forEach((e=>{const t=Q.create(this.site,e,void 0,{search:!0,multi:!0,clearable:!0},"filter."+e),i=document.createElement("div");this.modal.filter.entity_inputs[e]=t,this.modal.filter.entity_filters.lastElementChild.appendChild(i),i.className="col-sm",i.appendChild(t.e.parentElement),t.e.parentElement.classList.add("form-floating"),t.listbox.classList.add("multi"),t.dataset=e,t.loader=()=>{t.site.data.retrieve(t.dataset,t.site.data.info[t.dataset].site_file),t.e.removeEventListener("click",t.loader)},t.site.data.loaded[e]||t.e.addEventListener("click",t.loader),t.onchange=()=>{this.site.view.id_filter(),this.site.request_queue("view.id")},M(t,e,t.option_sets,function(){this.set_current(),S(t,!!this.options.length),Object.keys(this.values).forEach((e=>{this.site.view.entities.set(e,this.site.data.entities[e])})),this.site.view.registered[e]=!0,this.set(this.id in this.site.url_options?this.site.url_options[this.id].split(","):-1)}.bind(t)),S(t,!!t.options.length),this.site.registered_inputs.set(t.id,t),this.site.inputs[t.id]=t}))}init_panel(e){const t=e.classList.contains("panel-left")?"left":"right";this.content_bounds[t]=e.getBoundingClientRect().width,e.style.marginTop=this.content_bounds.top+"px",e.lastElementChild.addEventListener("click",(()=>{const i=e.getBoundingClientRect().width,s=e.lastElementChild.getBoundingClientRect().width;"true"===e.lastElementChild.getAttribute("aria-expanded")?(this.content_bounds[t]=s,this.top_menu&&(this.top_menu.e.style[t]=s+"px"),this.bottom_menu&&(this.bottom_menu.e.style[t]=s+"px"),e.style[t]=-i+s+"px",e.lastElementChild.setAttribute("aria-expanded","false")):(this.content_bounds[t]=i,this.top_menu&&(this.top_menu.e.style[t]=i+"px"),this.bottom_menu&&(this.bottom_menu.e.style[t]=i+"px"),e.style[t]="0px",e.lastElementChild.setAttribute("aria-expanded","true")),this.resize(),setTimeout(this.trigger_resize,200)}))}init_variable_info(){const e=this.modal.info,t=document.createElement("button"),i=document.createElement("a");let s=document.createElement("th"),a=document.createElement("p"),n=document.createElement("div"),r=document.createElement("ul");document.body.appendChild(e.e),this.modal.info.init=!0,e.e.id="variable_info_display",e.e.className="modal fade",e.e.setAttribute("tabindex","-1"),e.e.setAttribute("aria-labelledby","variable_info_title"),e.e.setAttribute("aria-hidden","true"),e.e.appendChild(n),n.className="modal-dialog modal-dialog-scrollable",n.appendChild(n=document.createElement("div")),n.className="modal-content",n.appendChild(e.header),e.header.className="modal-header",e.header.appendChild(document.createElement("p")),e.header.firstElementChild.className="h5 modal-title",e.header.firstElementChild.id="variable_info_title",e.header.appendChild(t),t.type="button",t.className="btn-close",t.setAttribute("data-bs-dismiss","modal"),t.title="close",e.header.insertAdjacentElement("afterend",e.body),e.body.className="modal-body",e.body.appendChild(e.title=document.createElement("p")),e.title.className="h4",e.body.appendChild(e.description=document.createElement("p")),e.body.appendChild(document.createElement("table")),e.body.lastElementChild.className="info-feature-table",e.body.lastElementChild.appendChild(e.name=document.createElement("tr")),e.name.appendChild(s),s.innerText="Name",e.name.appendChild(document.createElement("td")),e.body.lastElementChild.appendChild(e.type=document.createElement("tr")),e.type.appendChild(s=document.createElement("th")),s.innerText="Type",e.type.appendChild(document.createElement("td")),e.body.appendChild(e.sources),e.sources.appendChild(a),a.innerText="Sources",a.className="h3",e.sources.appendChild(n=document.createElement("div")),n.className="sources-cards",e.body.appendChild(e.references),e.references.appendChild(a=document.createElement("p")),a.className="h3",a.innerText="References",e.references.appendChild(r),r.className="reference-list",e.body.appendChild(e.origin),e.origin.appendChild(a=document.createElement("p")),a.className="h3",a.innerText="Origin",e.origin.appendChild(r=document.createElement("ul")),r.className="origin-list",e.body.appendChild(e.source_file),e.source_file.className="info-source-file",e.source_file.appendChild(i),i.innerText="source",i.target="_blank",i.rel="noreferrer"}show_variable_info(e){const t=this.site.dataviews[this.site.defaults.dataview],i=this.site.valueOf(e.target&&e.target.dataset.variable||t.y),s=this.site.data.variable_info[i];if(this.modal.info.header.firstElementChild.innerText=s.short_name,this.modal.info.title.innerText=s.long_name,function(e,t){let i=t.long_description||t.description||t.short_description||"";const s=new Map;for(let e;e=q.href.exec(i);)s.set(e[0],'<a href="'+e[1]+'" target="_blank" rel="noreferrer">'+(e.length>2?e[2]:e[1])+"</a>");s.size&&s.forEach(((e,t)=>{i=i.replace(t,e)}));let a=q.has_html.test(i);if(a){const e=i.split(q.bracket_content);for(let t=e.length;t--;){const i=e[t];if(i&&"/"!==i.substring(0,1)){const e=i.split(q.space),t=e.length;if(a=q.html_tags.test(e[0]),!a)break;for(let i=1;i<t&&(a=q.html_attributes.test(e[i]),a);i++);if(!a)break}}}e[a?"innerHTML":"innerText"]=i}(this.modal.info.description,s),this.modal.info.name.lastElementChild.innerText=i,this.modal.info.type.lastElementChild.innerText=s.unit||s.aggregation_method||s.type||"",s.sources&&s.sources.length?(this.modal.info.sources.lastElementChild.innerHTML="",this.modal.info.sources.classList.remove("hidden"),s.sources.forEach((e=>{this.modal.info.sources.lastElementChild.appendChild(z(e))}))):this.modal.info.sources.classList.add("hidden"),s.citations&&s.citations.length){if(this.modal.info.references.lastElementChild.innerHTML="",this.modal.info.references.classList.remove("hidden"),"string"==typeof s.citations&&(s.citations=[s.citations]),"references"in this.site.data&&(delete this.site.data.variable_info._references,delete this.site.data.references),!("_references"in this.site.data.variable_info)){const e={};this.site.data.variable_info._references_parsed=e,Object.keys(this.site.data.info).forEach((t=>{const i=this.site.data.info[t];"_references"in i&&Object.keys(i._references).forEach((t=>{t in e||(e[t]={reference:i._references[t],element:K(i._references[t])})}))}))}const e=this.site.data.variable_info._references_parsed;s.citations.forEach((t=>{t in e&&this.modal.info.references.lastElementChild.appendChild(e[t].element)}))}else this.modal.info.references.classList.add("hidden");if("origin"in s){this.modal.info.origin.classList.remove("hidden");const e=this.modal.info.origin.lastElementChild;e.innerHTML="","string"==typeof s.origin&&(s.origin=[s.origin]),s.origin.forEach((t=>{const i=document.createElement("li"),s=q.repo.exec(t)[1];let a=document.createElement("a");a.href="https://github.com/"+s,a.target="_blank",a.rel="noreferrer",a.innerText=s,i.appendChild(a),i.appendChild(document.createElement("span")),i.lastElementChild.innerText=" / ",a=document.createElement("a"),a.href=t,a.target="_blank",a.rel="noreferrer",a.innerText=t.replace(q.basename,""),i.appendChild(a),e.appendChild(i)}))}else this.modal.info.origin.classList.add("hidden");s.source_file?(this.modal.info.source_file.classList.remove("hidden"),this.modal.info.source_file.firstElementChild.href=s.source_file):this.modal.info.source_file.classList.add("hidden")}init_filter(){const e=this.modal.filter,t=document.createElement("button");let i=document.createElement("p"),s=document.createElement("div"),a=document.createElement("input"),n=document.createElement("label"),r=document.createElement("span"),l=document.createElement("tr");document.body.appendChild(e.e),this.modal.filter.init=!0,e.e.id="filter_display",e.e.className="modal fade",e.e.setAttribute("aria-labelledby","filter_title"),e.e.setAttribute("aria-hidden","true"),e.e.appendChild(s),s.className="modal-dialog",s.appendChild(s=document.createElement("div")),s.className="modal-content",s.appendChild(e.header),e.header.className="modal-header",e.header.appendChild(i),i.className="h5 modal-title",i.id="filter_title",i.innerText="Filter",e.header.appendChild(t),t.type="button",t.className="btn-close",t.setAttribute("data-bs-dismiss","modal"),t.title="close",e.header.insertAdjacentElement("afterend",e.body),e.body.className="filter-dialog",e.body.appendChild(i=document.createElement("p")),i.className="h6",i.innerText="Time Range",e.body.appendChild(e.time_range),e.time_range.className="row",e.time_range.appendChild(s=document.createElement("div")),s.className="col",s.appendChild(s=document.createElement("div")),s.className="form-floating text-wrapper wrapper",s.appendChild(a),a.className="form-control auto-input",a.setAttribute("data-autoType","number"),a.setAttribute("data-default","min"),a.max="filter.time_max",a.type="number",a.id="filter.time_min",s.appendChild(n),n.innerText="First Time",n.setAttribute("for","filter.time_min"),e.time_range.appendChild(s=document.createElement("div")),s.className="col",s.appendChild(s=document.createElement("div")),s.className="form-floating text-wrapper wrapper",s.appendChild(a=document.createElement("input")),a.className="form-control auto-input",a.setAttribute("data-autoType","number"),a.setAttribute("data-default","max"),a.min="filter.time_min",a.type="number",a.id="filter.time_max",s.appendChild(n=document.createElement("label")),n.innerText="Last Time",n.setAttribute("for","filter.time_max"),e.body.appendChild(e.entity_filters),e.entity_filters.appendChild(i=document.createElement("p")),i.className="h6",i.innerText="Select Entities",r.className="note",r.innerText="(click disabled selectors to load)",i.appendChild(r),e.entity_filters.appendChild(s=document.createElement("div")),s.className="row",e.entity_inputs={},e.body.appendChild(e.variable_filters),e.variable_filters.appendChild(i=document.createElement("p")),i.className="h6",i.innerText="Variable Conditions",e.variable_filters.appendChild(s=document.createElement("div")),s.className="row",s.appendChild(s=document.createElement("div")),s.className="col",s.appendChild(s=document.createElement("div"));const o=Q.create(this.site,"Add Variable Condition",void 0,{strict:!0,search:!0,clearable:!0,floating:!0,accordion:!0},"filter_variable_dropdown");o.input=!1,o.settings.filter_table=document.querySelector(".filter-body"),o.onchange=()=>{const e=o.value();if(e in this.site.data.variables){this.add_filter_condition(e),o.selection.innerText="";const t=document.querySelectorAll(".filter-body .combobox-input");t&&t.length&&t[t.length-1].focus()}},o.view=this.site.defaults.dataview,o.optionSource="variables",this.site.add_dependency(this.site.defaults.dataview,{type:"options",id:o.id}),s.appendChild(o.e.parentElement),e.variable_filters.appendChild(s=document.createElement("div")),s.className="hidden",s.appendChild(e.conditions),e.conditions.className="filter-conditions-table table",e.conditions.appendChild(document.createElement("thead")),e.conditions.lastElementChild.className="filter-header",e.conditions.appendChild(document.createElement("tbody")),e.conditions.lastElementChild.className="filter-body",e.conditions.firstElementChild.appendChild(l),["Variable","Result","Active","Component","Operator","Value","Remove"].forEach((e=>{const t=document.createElement("th");if(l.appendChild(t),"Component"===e||"Result"===e){const i={id:"",note:"",site:this.site,wrapper:document.createElement("label")};"Component"===e?(i.id="filter_component_header",i.note="Component refers to which single value to filter on for each entity; select a dynamic time reference, or enter a time."):(i.id="filter_result_header",i.note="Passing / total entities across loaded datasets."),t.appendChild(i.wrapper),t.className="has-note",i.wrapper.innerText=e,i.wrapper.id=i.id,i.wrapper.setAttribute("data-of",i.id),i.wrapper.setAttribute("aria-description",i.note),t.addEventListener("mouseover",R.bind(i))}else t.innerText=e})),e.variable_filters.lastElementChild.appendChild(i=document.createElement("p")),i.className="note",i.innerText="Summaries are across time within each unfiltered dataset."}resize(e){const t=e&&"boolean"==typeof e,i=this[t?"wrap":"content"];t||(i.style.top=(this.top_menu&&"open"===this.top_menu.e.dataset.state?this.top_menu.e.getBoundingClientRect().height:this.content_bounds.top+(!this.top_menu&&!this.left_menu&&!this.right_menu||this.right_menu&&"open"===this.right_menu.e.dataset.state||this.left_menu&&"open"===this.left_menu.e.dataset.state?0:40))+"px",i.style.bottom=this.content_bounds.bottom+(this.bottom_menu&&"closed"!==this.bottom_menu.e.dataset.state?this.bottom_menu.e.getBoundingClientRect().height:0)+"px",i.style.left=this.content_bounds.left+(this.left_menu&&"closed"!==this.left_menu.e.dataset.state?this.left_menu.e.getBoundingClientRect().width:0)+"px"),i.style.right=this.content_bounds[t?"outer_right":"right"]+(this.right_menu&&"closed"!==this.right_menu.e.dataset.state?this.right_menu.e.getBoundingClientRect().width:0)+"px"}tooltip_clear(e){const t=e.target;!this.tooltip.showing||"blur"!==e.type&&this.tooltip.showing===(t.dataset.of||t.id)||(this.tooltip.showing="",this.tooltip.e.classList.add("hidden"))}add_filter_condition(t,i){i=i||{operator:">=",value:0};let s=document.createElement("tr"),a=document.createElement("td"),n=document.createElement("p"),r=document.createElement("label"),l=document.createElement("div"),o=document.createElement("input"),d=document.createElement("select"),h=document.createElement("button");const c={e:s,variable:t,component:i.component||"last",operator:i.operator||">=",value:i.value||0,active:!0,id:t+"_"+Date.now(),passed:0,failed:0,info:this.site.data.variables[t].info,view:this.site.dataviews[this.site.defaults.dataview]},u=c.view.get.dataset(),p=c.info[u].time_range,m=this.site.data.meta.overall.value,f=this.site.data.format_value.bind(this.site.data);this.site.view.filters.set(c.id,c),"number"==typeof c.component&&(c.component=m[c.component]+""),s.appendChild(a),a.appendChild(n),n.id=c.id,n.className="cell-text",n.innerText=c.info[u].info.short_name,a.appendChild(n),a.appendChild(n=document.createElement("p")),c.summary={f:c,update:function(){const e=c.view.get.dataset(),t=c.info[e].time_range;if(e!==this.add.Dataset){this.add.Dataset=e,this.add.First=this.times[t[0]]+""||"NA",this.add.Last=this.times[t[1]]+""||"NA";const i=this.f.info[e],s=this.table.firstElementChild.firstElementChild.children,a=this.table.lastElementChild.firstElementChild.children;for(let e=a.length;e--;){const t=s[e].innerText,n=t.toLowerCase();a[e].innerText=n in i?this.format(i[n])+"":this.add[t]}}},add:{Dataset:u,First:m[p[0]]+""||"NA",Last:m[p[1]]+""||"NA"},times:this.site.data.meta.overall.value,format:f},c.summary.table=B(f,n,c.info[u],c.summary.add),s.appendChild(a=document.createElement("td")),a.appendChild(n=document.createElement("p")),n.setAttribute("aria-describedby",c.id),n.className="cell-text",n.innerText="0/0",s.appendChild(a=document.createElement("td")),a.appendChild(r),r.innerText="Active",r.className="filter-label",r.id=c.id+"_switch",a.appendChild(l),l.className="form-check form-switch filter-form-input",l.appendChild(o),o.className="form-check-input",o.type="checkbox",o.role="switch",o.setAttribute("aria-labelledby",c.id+"_switch"),o.setAttribute("aria-describedby",c.id),o.checked=!0,o.addEventListener("change",(()=>{c.active=!c.active,this.site.request_queue("view.filter")})),s.appendChild(a=document.createElement("td")),a.appendChild(r=document.createElement("label")),r.innerText="Component",r.className="filter-label",r.id=c.id+"_component";const _=Q.create(this.site,"component",j.Time);_.default=c.component,_.set(c.component),s.lastElementChild.appendChild(_.e.parentElement),_.e.parentElement.removeChild(_.e.parentElement.lastElementChild),_.e.parentElement.classList.add("filter-form-input"),_.e.setAttribute("aria-labelledby",c.id+"_component"),_.input_element.setAttribute("aria-labelledby",c.id+"_component"),_.input_element.setAttribute("aria-describedby",c.id),_.listbox.setAttribute("aria-labelledby",c.id+"_component"),_.onchange=()=>{c.component=_.value(),this.site.request_queue("view.filter")},s.appendChild(a=document.createElement("td")),a.appendChild(r=document.createElement("label")),r.innerText="Operator",r.className="filter-label",r.id=c.id+"_operator",s.lastElementChild.appendChild(d),d.className="form-select filter-form-input",d.setAttribute("aria-labelledby",c.id+"_operator"),d.setAttribute("aria-describedby",c.id),d.addEventListener("change",(e=>{c.operator=e.target.selectedOptions[0].value,this.site.request_queue("view.filter")})),[">=","=","!=","<="].forEach((e=>{const t=document.createElement("option");d.appendChild(t),t.value=t.innerText=e,e===c.operator&&(t.selected=!0)})),s.appendChild(a=document.createElement("td")),a.appendChild(r=document.createElement("label")),r.innerText="Value",r.className="filter-label",r.id=c.id+"_value";const v=Q.create(this.site,"component",["min","q1","median","mean","q3","max"]);v.value_type="number",v.default=c.value,v.set(c.value),a.appendChild(v.e.parentElement),v.e.parentElement.removeChild(v.e.parentElement.lastElementChild),v.e.parentElement.classList.add("filter-form-input"),v.e.setAttribute("aria-labelledby",c.id+"_value"),v.input_element.setAttribute("aria-labelledby",c.id+"_value"),v.input_element.setAttribute("aria-describedby",c.id),v.listbox.setAttribute("aria-labelledby",c.id+"_value"),v.onchange=function(t){return e(this,void 0,void 0,(function*(){if(t.value=this.value(),this.site.patterns.number.test(t.value+""))t.value=+t.value,t.value_source="";else{t.view.reparse();const e=yield this.site.data.get_variable(t.variable,t.view),i=e&&e.views[t.view.id].summaries[t.view.parsed.dataset];if(i&&t.value in i){const e=t.view.parsed.variable_values.get(t.id),s=t.value,a=e.comp_fun(e,t.view.parsed);t.value_source=t.value,t.value=i[s][a]}}this.site.request_queue("view.filter")}))}.bind(v,c),s.appendChild(a=document.createElement("td")),a.appendChild(r=document.createElement("label")),r.innerText="Remove",r.className="filter-label",r.id=c.id+"_remove",a.appendChild(h),h.className="btn-close filter-form-input",h.type="button",h.setAttribute("aria-labelledby",c.id+"_remove"),h.setAttribute("aria-describedby",c.id),h.addEventListener("mouseup",function(e){e.button||(this.filter.e.parentElement.removeChild(this.filter.e),this.site.view.filters.delete(this.filter.id),this.site.view.filters.size||this.site.page.modal.filter.variable_filters.lastElementChild.classList.add("hidden"),this.site.request_queue("view.filter"))}.bind({filter:c,site:this.site})),this.site.request_queue("view.filter"),this.modal.filter.conditions.lastElementChild.appendChild(s),this.modal.filter.variable_filters.lastElementChild.classList.remove("hidden")}trigger_resize(){window.dispatchEvent(new Event("resize"))}render_credits(e){const t=this.site.spec.credit_output&&this.site.spec.credit_output[e.id],i=t&&t.exclude||[],s=t&&t.add||{},a=Object.assign(Object.assign({},this.site.spec.credits),s);e.appendChild(document.createElement("ul")),Object.keys(a).forEach((t=>{if(-1===i.indexOf(t)){const i=a[t],s=document.createElement("li");if(e.lastElementChild.appendChild(s),"url"in i){const e=document.createElement("a");s.appendChild(e),e.href=i.url,e.target="_blank",e.rel="noreferrer",e.innerText=i.name}else s.innerText=i.name;if("version"in i){const e=document.createElement("span");s.appendChild(e),e.className="version-tag",e.innerText=i.version}if("description"in i){const e=document.createElement("p");s.parentElement.appendChild(e),e.innerText=i.description}}}))}}class ee extends P{constructor(e,t){const i=document.createElement("input");i.id=e.id,super(i,t),this.type="virtual",this.states=[],this.values=[],this.source=this.default=e.default,this.source&&this.values.push(this.source),e.states&&(this.states=e.states),e.display&&(this.display=e.display);const s={};this.states.forEach((e=>{this.values.push(e.value),e.condition.forEach((e=>{s[e.id]={type:"update",id:this.id},this.site.add_dependency(e.id,s[e.id])}))})),this.update()}init(){this.values.forEach((e=>{"string"==typeof e&&e in this.site.inputs&&this.site.add_dependency(e,{type:"update",id:this.id})}))}update(){this.source=void 0;for(let e,t=this.states.length;t--;){e=!0;for(let i=this.states[t].condition.length;i--;){const s=this.states[t].condition[i];if(k.checks[s.type](this.site.valueOf(s.id),this.site.valueOf(s.value))){if(s.any){e=!0;break}}else e=!1}if(e){this.source=this.states[t].value;break}}if(this.source||(this.source=this.default),this.source!==this.previous)this.previous=this.source,this.site.request_queue(this.id);else if(this.source in this.site.inputs){const e=this.site.inputs[this.source].value();e!==this.previous&&(this.previous=e,this.site.request_queue(this.id))}}value(){return this.site.valueOf(this.source)}set(e){if(-1!==this.values.indexOf(e))this.previous=this.source,this.source=e;else if(this.source in this.site.inputs){const t=this.site.inputs[this.source];"values"in t&&(Array.isArray(t.values)?-1!==t.values.indexOf(e):e in t.values||"display"in t&&e in t.display)&&t.set(e)}this.site.request_queue(this.id)}}const te={percent:function(e){return e+"%"},minute:function(e){return e+" minutes"},minutes:function(e){return e+" minutes"},dollars:function(e){return"$"+e},"Mb/s":function(e){return e+" Mbps"}};class ie{constructor(e,t){if(this.input=!1,this.spec={},this.deferred=!1,this.e=e,this.tab="tabpanel"===e.parentElement.getAttribute("role")?e.parentElement:void 0,this.site=t,this.view=e.dataset.view||t.defaults.dataview,this.id=e.id||"ui"+t.page.elementCount++,this.note=e.getAttribute("aria-description")||"",this.type=e.dataset.autotype,this.type in t.spec){const e=t.spec[this.type];this.id in e&&(this.spec=e[this.id])}}}class se{constructor(e,t){if(this.parsed={},this.ref=!0,this.selection=!1,this.parent=e,this.text=t,"value"===t)this.parsed.data=e.spec.variable;else if("summary"===t)e.spec.show_summary=!0;else if("filter"===t){const e=document.createElement("table");e.className="info-filter",this.parsed.filter=e}const i=e.site.patterns;i.features.test(t)?this.parsed.features=t.replace(i.features,""):e.site.patterns.data.test(t)?this.parsed.data=t.replace(i.data,""):i.variables.test(t)?this.parsed.variables=t.replace(i.variables,""):this.ref=!1}get(e,t){if(this.ref&&this.parent.site.data){if(e){if("features"in this.parsed)return e.features[this.parsed.features];if("data"in this.parsed){if("value"===this.text?this.parsed.data=this.parent.site.valueOf(this.parent.spec.variable||t&&(t.color||t.y)||this.parent.site.dataviews[this.parent.view].y):this.text in this.parent.site.inputs&&(this.parsed.data=this.parent.site.valueOf(this.text)),!(this.parsed.data in this.parent.site.data.variables))return this.parsed.data;const i=this.parent.site.data.variables[this.parsed.data],s=this.parent.site.data.format_value(e.get_value(this.parsed.data,this.parent.time),i&&i.info[e.group]&&"integer"===i.info[e.group].type);let a=i.meta.unit||i.meta.type;return i.meta.aggregation_method&&!(a in te)&&(a=i.meta.aggregation_method),(!isNaN(s)&&a in te?te[a](s):s)+""}}const i=this.parent.site.data.variable_info;if("data"in this.parsed)return this.parent.site.data.meta.times[this.parent.dataset].value[this.parent.time_agg]+"";if("variables"in this.parsed&&(this.value_source||this.parent.v in i)){const e=i[this.parent.site.valueOf(this.value_source||this.parent.v)];return this.parsed.variables in e?e[this.parsed.variables]:this.text}return this.text}return this.text}}const ae={dataset:"Overall",filtered:"Filtered",children:"Unfiltered selection",all:"Selection"};const ne={button:class extends P{constructor(e,t){super(e,t),this.type="button",this.update=this.update.bind(this),this.target=this.e.dataset.target,"copy"===this.target&&(this.settings.endpoint=t.spec.endpoint),"filter"===this.target?(e.setAttribute("data-bs-toggle","modal"),e.setAttribute("data-bs-target","#filter_display"),this.notification=document.createElement("span"),this.notification.className="filter-notification hidden",e.parentElement.appendChild(this.notification),t.add_dependency("view.filter",{type:"update",id:this.id}),t.add_dependency("view.id",{type:"update",id:this.id}),t.data&&this.update()):e.addEventListener("click",this.settings.effects?"export"===this.target||"copy"===this.target?()=>{const i={},s=this.settings,a=t.dataviews[s.dataview],n=a&&a.parsed.dataset;if(Object.keys(s.query).forEach((e=>i[e]=t.valueOf(s.query[e]))),a&&(!("include"in i)&&a.y&&(i.include=t.valueOf(a.y)),!("id"in i)&&a.ids&&(i.id=t.valueOf(a.ids))),"copy"===this.target||this.api){let r=[];"id"in i&&""!==i.id&&-1!=i.id?r.push("id="+i.id):t.view.selected.length&&r.push("id="+t.view.selected.join(",")),a&&(i.time_range||a.time_range.filtered_index+""==a.time_range.index+""||r.push("time_range="+t.data.meta.times[n].value[a.time_range.filtered_index[0]]+","+t.data.meta.times[n].value[a.time_range.filtered_index[1]]),a.features||(a.features={}),Object.keys(a.features).forEach((e=>{if(!(e in i)){let s=t.valueOf(a.features[e]);Array.isArray(s)&&(s=s.join(",")),i[e]=s,r.push(e+"="+s)}})),t.view.filters.size&&t.view.filter_state(r,a.parsed.time_agg)),Object.keys(i).forEach((e=>{q.exclude_query.test(e)||e in a.features||r.push(e+"="+i[e])}));const l=s.endpoint+(r.length?"?"+r.join("&"):"");this.api?window.location.href=l:navigator.clipboard.writeText(l).then((()=>{"Copied!"!==e.innerText&&(this.text=e.innerText,e.innerText="Copied!",setTimeout((()=>{e.innerText=this.text}),500),t.gtag("event","export",{event_category:"api link"}))}),(e=>{e!==this.e.innerText&&(this.text=this.e.innerText,this.e.innerText=e,setTimeout((()=>{this.e.innerText=this.text}),1500))}))}else a&&"selection"in a?(i.time_range||(i.time_range=t.data.meta.times[n].value[a.time_range.filtered_index[0]]+","+t.data.meta.times[n].value[a.time_range.filtered_index[1]]),t.data.export(i,a.selection.all,!0)):t.data.export(i,t.data.entities,!0,!0),t.gtag("event","export",{event_category:"download"})}:()=>{Object.keys(this.settings.effects).forEach((e=>{""===this.settings.effects[e]||-1==this.settings.effects[e]?t.inputs[e].reset():t.inputs[e].set(this.settings.effects[e])}))}:"refresh"===this.target?t.global_update:"reset_selection"===this.target?t.global_reset:"reset_storage"===this.target?t.clear_storage:()=>{this.target in t.inputs&&t.inputs[this.target].reset()})}update(){let e=+(0!==this.site.view.selected.length);this.site.view.filters.forEach((t=>e+=+t.active)),e?(this.notification.innerText=e+"",this.notification.classList.remove("hidden")):this.notification.classList.add("hidden")}},buttongroup:class extends P{constructor(e,t){super(e,t),this.type="buttongroup",this.values=[],this.listen=this.listen.bind(this),e.addEventListener("click",this.listen),this.options=e.querySelectorAll("input")}get(){for(let e=this.options.length;e--;)if(this.options[e].checked){this.set(e);break}}set(e){this.previous=this.value(),this.current_index="string"==typeof e?this.values.indexOf(e):e,-1!==this.current_index?(this.source=this.values[this.current_index]in this.site.inputs?this.site.valueOf(this.values[this.current_index]):this.values[this.current_index],this.options[this.current_index].checked=!0):this.source=void 0,this.site.request_queue(this.id)}listen(e){this.set(e.target.value)}add(e,t,i){const s=document.createElement("input"),a=document.createElement("label");return s.autocomplete="off",s.className="btn-check",s.type="radio",s.name=this.e.id+"_options",s.id=this.e.id+"_option"+this.e.childElementCount,s.value=e,a.innerText=t||this.site.data.format_label(e),a.className="btn btn-primary",a.dataset.for=this.e.firstElementChild.id,i||(this.e.appendChild(s),this.e.appendChild(a)),s}},combobox:Q,select:class extends P{constructor(e,t){if(super(e,t),this.type="select",this.current_filter={},this.values={},this.display={},this.option_sets={},this.current_set="",this.sensitive=!1,this.filter=H,this.reformat_label=!1,this.set_current=J,this.listen=this.listen.bind(this),e.addEventListener("change",this.listen),this.options=[...e.querySelectorAll("option")],this.optionSource&&this.site.patterns.ids.test(this.optionSource)?(this.loader=U.bind(this),e.addEventListener("click",this.loader),this.deferred=!0):"number"==typeof this.default&&this.default>-1&&this.options.length&&this.default<this.options.length&&(this.default=this.options[this.default].value||this.options[this.default].dataset.value),this.options.length){this.reformat_label=!0,this.options.forEach(((e,t)=>{e.dataset.value=e.value,this.values[e.value]=t,this.reformat_label&&(this.reformat_label=e.value===e.innerText)}));const t=e.querySelectorAll("optgroup");t.length&&(this.groups={e:[],by_name:{}},t.forEach((e=>{const t=e.dataset.group;this.groups.e.push(e),this.groups.by_name[t]=e})))}}init(){this.options.forEach(((e,t)=>{this.reformat_label&&(e.innerText=this.site.data.format_label(e.value)),this.display[e.innerText]=t}))}get(){this.set(this.e.selectedIndex)}set(e){"string"==typeof e&&!(e in this.values)&&this.site.patterns.number.test(e)&&(e=+e),"number"==typeof e&&(e=this.options[e]?this.options[e].value:e),!(e in this.values)&&e in this.display&&(e=this.options[this.display[e]].value),e!==this.source&&(this.e.selectedIndex=e in this.values?this.values[e]:-1,this.source=e,this.site.request_queue(this.id))}listen(e){this.set(e.target.selectedIndex)}add(e,t,i,s){const a=document.createElement("option");return a.value=e,a.innerText=t||this.site.data.format_label(e),s&&s.info&&(a.title=s.info.description||s.info.short_description),i||this.e.appendChild(a),this.values[e]=this.display[a.innerText]=this.options.length,this.options.push(a),a}},number:class extends P{constructor(e,t){super(e,t),this.type="number",this.parsed={min:-1/0,max:1/0},this.listen=this.listen.bind(this),e.addEventListener("change",this.listen),this.update=this.update.bind(this);const i=e.parentElement.parentElement.querySelector(".number-up"),s=e.parentElement.parentElement.querySelector(".number-down");s&&s.addEventListener("click",(()=>{this.set(Math.max(this.parsed.min,this.value()-1))})),i&&i.addEventListener("click",(()=>{this.set(Math.min(this.parsed.max,this.value()+1))}))}get(){this.set(this.e.value)}set(e,t){e||(e=null),"string"==typeof e&&(e=parseFloat(e)),isFinite(e)&&e!==this.source&&(this.previous=parseFloat(this.e.value),t&&(isFinite(this.parsed.min)&&e<this.parsed.min?e=this.parsed.min:isFinite(this.parsed.max)&&e>this.parsed.max&&(e=this.parsed.max)),this.off_default=e!==this.current_default,this.source=e,this.e.value=e+"",this.current_index=e-this.parsed.min,"range"===this.e.type&&(this.e.nextElementSibling.firstElementChild.innerText=this.e.value),this.site.request_queue(this.id))}listen(){this.set(this.e.value,!0)}update(){return e(this,void 0,void 0,(function*(){const e=this.site.dataviews[this.view],t=this.site.valueOf(this.variable||e.y);let i=e.get?e.get.dataset():this.site.valueOf(this.dataset),s=this.site.valueOf(this.min)||e.time,a=this.site.valueOf(this.max)||e.time;"string"==typeof s&&this.site.patterns.minmax.test(s)&&(s=this.site.inputs[this.min].min),"string"==typeof a&&this.site.patterns.minmax.test(a)&&(a=this.site.inputs[this.max].max),this.parsed.min=isNaN(this.min_ref)?void 0===s?e.time_range.time[0]:"number"==typeof s?s:s in this.site.data.variables?this.site.data.variables[s].info[i||this.site.data.variables[s].datasets[0]].min:parseFloat(s):this.min_ref,this.parsed.max=isNaN(this.max_ref)?void 0===a?e.time_range.time[1]:"number"==typeof a?a:a in this.site.data.variables?this.site.data.variables[a].info[i||this.site.data.variables[a].datasets[0]].max:parseFloat(a):this.min_ref,this.default_min?this.current_default=this.parsed.min:this.default_max&&(this.current_default=this.parsed.max),this.ref&&t in this.site.data.variables?(this.range[0]=isNaN(this.min_ref)?Math.max(e.time_range.time[0],this.parsed.min):this.min_ref,this.e.min=this.range[0]+"",this.range[1]=isNaN(this.max_ref)?Math.min(e.time_range.time[1],this.parsed.max):this.max_ref,this.e.max=this.range[1]+"",this.depends[e.y]||(this.depends[e.y]=!0,this.site.add_dependency(e.y,{type:"update",id:this.id})),(this.source>this.parsed.max||this.source<this.parsed.min)&&this.reset()):(this.e.min=this.parsed.min+"",(this.parsed.min>this.source||!this.source&&this.default_min)&&this.set(this.parsed.min),this.e.max=this.parsed.max+"",(this.parsed.max<this.source||!this.source&&this.default_max)&&this.set(this.parsed.max))}))}},radio:class extends P{constructor(e,t){super(e,t),this.type="radio",this.values=[],this.listen=this.listen.bind(this),this.options=e.querySelectorAll("input"),this.options.forEach((e=>{this.values.push(e.value),e.addEventListener("click",this.listen)})),"number"==typeof this.default&&this.options[this.default]&&(this.default=this.values[this.default])}get(){for(let e=this.options.length;e--;)if(this.options[e].checked){this.set(e);break}}set(e){this.current_index="string"==typeof e?this.values.indexOf(e):e,-1!==this.current_index?(this.source=this.values[this.current_index]in this.site.inputs?this.site.valueOf(this.values[this.current_index]):this.values[this.current_index],this.options[this.current_index].checked=!0):this.source=void 0,this.site.request_queue(this.id)}listen(e){this.set(e.target.value)}add(e,t,i){const s=document.createElement("div"),a="TRUE"===this.e.dataset.switch,n=document.createElement("input"),r=document.createElement("label");return s.className="form-check"+(a?" form-switch":""),s.appendChild(n),s.appendChild(r),n.autocomplete="off",n.className="form-check-input",a&&(n.role="switch"),n.type="radio",n.name=this.e.id+"_options",n.id=this.e.id+"_option"+this.e.childElementCount,n.value=e,r.innerText=t||this.site.data.format_label(e),r.className="form-check-label",r.setAttribute("for",s.firstElementChild.id),i||this.e.appendChild(s),n}},switch:class extends P{constructor(e,t){super(e,t),this.type="switch",this.listen=this.listen.bind(this),e.addEventListener("change",this.listen)}get(){this.set(this.e.checked)}set(e){"string"==typeof e&&(e="on"===e||"true"===e),e!==this.source&&(this.previous=this.e.checked,this.e.checked=this.source=e,this.site.request_queue(this.id))}listen(e){this.set(this.e.checked)}},checkbox:class extends P{constructor(e,t){super(e,t),this.type="checkbox",this.values=[],this.listen=this.listen.bind(this),this.options=e.querySelectorAll("input"),this.options.forEach((e=>{this.values.push(e.value),e.addEventListener("click",this.listen)})),"string"==typeof this.default&&(this.default=this.default.split(",")),this.get()}get(){this.source=[],this.current_index=[],this.off_default=!1,this.options.forEach(((e,t)=>{e.checked?(this.source.push(this.values[t]),this.current_index.push(t)):this.off_default=!0})),this.site.request_queue(this.id)}set(e){if(Array.isArray(e))this.source=[],this.current_index=[],this.off_default=!1,this.values.forEach(((t,i)=>{-1!==e.indexOf(t)?(this.source.push(t),this.current_index.push(i),this.options[i].checked=!0):(this.off_default=!0,this.options[i].checked=!1)}));else{if("string"==typeof e)return void this.set(""===e?this.values:e.split(","));-1!==e&&(this.options[e].checked=!0,this.off_default=!1,this.options.forEach((e=>{e.checked||(this.off_default=!0)})))}this.site.request_queue(this.id)}listen(e){const t=e.target;if(t.checked)this.source.push(t.value),this.current_index.push(this.values.indexOf(t.value)),this.off_default=!1,this.options.forEach((e=>{e.checked||(this.off_default=!0)}));else{let e=this.source.indexOf(t.value);-1!==e&&(this.off_default=!0,this.source.splice(e,1),this.current_index.splice(e,1))}this.site.request_queue(this.id)}add(e,t,i){const s=document.createElement("div"),a="TRUE"===this.e.dataset.switch,n=document.createElement("input"),r=document.createElement("label");return s.className="form-check"+(a?" form-switch":""),s.appendChild(n),s.appendChild(r),n.autocomplete="off",n.className="form-check-input",a&&(n.role="switch"),n.type="checkbox",n.name=this.e.id+"_options",n.id=this.e.id+"_option"+this.e.childElementCount,n.value=e,r.innerText=t||this.site.data.format_label(e),r.className="form-check-label",r.setAttribute("for",s.firstElementChild.id),i||this.e.appendChild(s),n}},text:class extends P{constructor(e,t){super(e,t),this.type="text",this.listen=this.listen.bind(this),e.addEventListener("change",this.listen)}get(){this.set(this.e.value)}set(e){this.previous=this.e.checked,this.e.value=this.source=e,this.site.request_queue(this.id)}listen(e){this.set(this.e.value)}}},re={info:class extends ie{constructor(e,t){if(super(e,t),this.type="info",this.showing=!1,this.has_default=!1,this.selection=!1,this.processed=!1,this.depends={},this.parts={},this.update=this.update.bind(this),this.has_default=this.spec.default&&(!!this.spec.default.title||!!this.spec.default.body),this.site.subs.add(this.view,this),this.spec.floating&&(document.body.appendChild(this.e),this.e.classList.add("hidden"),document.addEventListener("mousemove",function(e){if(this.showing){const t=this.site.page.content.getBoundingClientRect();this.e.style.top=(e.y>t.height/2?e.y-this.e.getBoundingClientRect().height-10:e.y+10)+"px",this.e.style.left=(e.x>t.width/2?e.x-this.e.getBoundingClientRect().width-10:e.x+10)+"px"}}.bind(this))),this.spec.title&&(this.parts.title=new se(this,this.spec.title),this.spec.variable_info&&"variables"in this.parts.title.parsed&&this.site.patterns.measure_name.test(this.parts.title.parsed.variables)?(this.parts.title.base=document.createElement("button"),this.parts.title.base.type="button",this.parts.title.base.setAttribute("data-bs-toggle","modal"),this.parts.title.base.setAttribute("data-bs-target","#variable_info_display"),this.parts.title.base.addEventListener("click",this.site.page.show_variable_info)):this.parts.title.base=document.createElement("p"),this.parts.title.base.appendChild(document.createElement("span")),this.parts.title.temp=document.createElement("p"),this.parts.title.default=document.createElement("p"),this.parts.title.temp.className=this.parts.title.base.className=this.parts.title.default.className="info-title hidden",this.has_default&&this.spec.default.title&&(this.e.appendChild(this.parts.title.default),this.parts.title.default.innerText=this.spec.default.title),this.parts.title.ref||(this.parts.title.base.firstElementChild.innerText=this.parts.title.get()),this.e.appendChild(this.parts.title.base),this.e.appendChild(this.parts.title.temp),this.parts.title.base.classList.add("hidden"),this.parts.title.temp.classList.add("hidden")),this.spec.body||this.has_default&&this.spec.default.body){this.parts.body={base:document.createElement("div"),temp:document.createElement("div"),default:document.createElement("div"),rows:[]},this.parts.body.temp.className=this.parts.body.base.className=this.parts.body.default.className="info-body hidden",this.has_default&&this.spec.default.body&&(this.parts.body.default.innerText=this.spec.default.body);let e=0;this.spec.body&&this.spec.body.forEach(((t,i)=>{const s={name:new se(this,t.name),value:new se(this,t.value),base:document.createElement("div"),temp:document.createElement("div")},a=document.createElement("div"),n=document.createElement("div");this.parts.body.rows[i]=s,this.parts.body.base.appendChild(s.base),this.parts.body.temp.appendChild(s.temp),s.temp.className=s.base.className="info-body-row-"+t.style,e+=24+("stack"===t.style?24:0),s.name&&(this.spec.variable_info&&"variables"in s.name.parsed&&this.site.patterns.measure_name.test(s.name.parsed.variables)?(s.base.appendChild(document.createElement("button")),s.base.lastElementChild.role="button",s.base.lastElementChild.setAttribute("data-bs-toggle","modal"),s.base.lastElementChild.setAttribute("data-bs-target","#variable_info_display"),s.base.lastElementChild.addEventListener("click",this.site.page.show_variable_info)):s.base.appendChild(a),s.temp.appendChild(n),a.className=n.className="info-body-row-name",a.innerText=n.innerText=s.name.get()),s.value&&(s.base.appendChild(document.createElement("div")),s.temp.appendChild(document.createElement("div")))})),this.e.style.minHeight=e+"px",this.e.appendChild(this.parts.body.base),this.e.appendChild(this.parts.body.default),this.e.appendChild(this.parts.body.temp)}}init(){this.spec.title&&"summary"===this.spec.title&&(this.parts.title.parsed.summary=B(this.site.data.format_value,this.e)),this.parts.body&&this.parts.body.rows&&this.parts.body.rows.forEach((e=>{if(e.name&&"summary"===e.name.text&&(e.name.parsed.summary=B(this.site.data.format_value,this.e)),e.value)if("summary"===e.value.text)e.value.parsed.summary=B(this.site.data.format_value,this.e),e.base.lastElementChild.appendChild(e.value.parsed.summary);else if("filter"in e.value.parsed)e.base.lastElementChild.appendChild(e.value.parsed.filter);else{const t=e.base.lastElementChild,i=e.temp.lastElementChild;i.className=t.className="info-body-row-value"+("statement"===e.value.parsed.variables?" statement":""),e.name.ref&&"value"===e.value.text&&(e.value.ref=!0),e.value.ref||(i.innerText=t.innerText=e.value.get())}})),this.update()}show(e,t){this.update(e,t),this.showing=!0,this.spec.floating&&this.e.classList.remove("hidden"),this.parts.title&&(this.selection?this.parts.title.base.classList.add("hidden"):this.parts.title.default.classList.add("hidden"),this.parts.title.temp.classList.remove("hidden")),this.parts.body&&(this.selection?this.parts.body.base.classList.add("hidden"):this.parts.body.default.classList.add("hidden"),this.parts.body.temp.classList.remove("hidden"))}revert(){this.showing=!1,this.spec.floating?this.e.classList.add("hidden"):(this.parts.title&&(this.selection?this.parts.title.base.classList.remove("hidden"):this.has_default&&this.parts.title.default.classList.remove("hidden"),this.parts.title.temp.classList.add("hidden")),this.parts.body&&(this.selection?this.parts.body.base.classList.remove("hidden"):this.has_default&&this.parts.body.default.classList.remove("hidden"),this.parts.body.temp.classList.add("hidden")))}update(t,i,s){return e(this,void 0,void 0,(function*(){const e=this.site.dataviews[this.view];if(!e)return;const a=this.site.inputs[e.time_agg];if(this.v=this.site.valueOf(this.spec.variable||i&&(i.color||i.y)||e.y),this.dataset=e.get.dataset(),a&&!(this.dataset in this.site.data.meta.times))return void(this.id in this.site.data.data_queue[this.dataset]||(this.site.data.data_queue[this.dataset][this.id]=this.update));this.time_agg=a?a.value()-this.site.data.meta.times[this.dataset].range[0]:0;const n=this.v in this.site.data.variables&&this.site.data.variables[this.v].time_range[this.dataset];this.time=n?this.time_agg-n[0]:0,this.spec.show_summary&&(this.var=this.v&&(yield this.site.data.get_variable(this.v,this.site.dataviews[this.view])),this.summary=this.view in this.var.views&&this.var.views[this.view].summaries[this.dataset]),this.processed||(this.processed=!0,this.spec.floating||(this.site.add_dependency(this.view,{type:"update",id:this.id}),e.y in this.site.inputs&&this.site.add_dependency(e.y,{type:"update",id:this.id}),a&&this.site.add_dependency(e.time_agg,{type:"update",id:this.id}),this.spec.variable in this.site.inputs&&this.site.add_dependency(this.spec.variable,{type:"update",id:this.id})),this.parts.body&&this.parts.body.rows.forEach((e=>{!e.value.ref&&e.value.text in this.site.inputs&&"variables"in e.name.parsed&&(e.name.value_source=e.value.value_source=e.value.text,e.value.ref=!0,e.value.parsed.data="")}))),t?(this.parts.title&&(this.parts.title.temp.innerText=this.parts.title.get(t,i)),this.parts.body&&this.parts.body.rows.forEach((e=>{if(e.name.ref){e.name.value_source&&(e.name.value_source=e.value.text);const s=e.name.get(t,i);"object"!=typeof s&&(e.temp.firstElementChild.innerText=this.parse_variables(s,e.value.parsed.variables,t))}if(e.value.ref){e.value.value_source&&(e.value.value_source=e.value.text);const s=e.value.get(t,i);"object"!=typeof s&&(e.temp.lastElementChild.innerText=this.parse_variables(s,e.value.parsed.variables,t))}}))):this.spec.floating||(this.queue>0&&clearTimeout(this.queue),this.queue=-1,s?((t=this.site.data.entities[e.get.single_id()])?(this.selection=!0,this.parts.title&&(this.parts.title.base.classList.remove("hidden"),this.parts.title.default.classList.add("hidden")),this.parts.body&&this.has_default&&this.parts.body.default.classList.add("hidden")):(this.selection=!1,this.parts.title&&(this.has_default?(this.parts.title.base.classList.add("hidden"),this.parts.title.default.classList.remove("hidden")):this.parts.title.ref&&"features"in this.parts.title.parsed||this.parts.title.base.classList.remove("hidden")),this.parts.body&&(this.parts.body.base.classList.add("hidden"),this.has_default&&this.parts.body.default.classList.remove("hidden"))),this.parts.title&&(this.parts.title.base.firstElementChild.innerText=this.parts.title.get(t,i)),this.parts.body&&(this.spec.subto||this.parts.body.base.classList.remove("hidden"),this.parts.body.rows.forEach((s=>{if("summary"in s.value.parsed)this.fill_summary_table(s.value.parsed.summary,this.summary,this.time);else if("filter"in s.value.parsed){const e=s.value.parsed.filter;let t=0;if(e.innerHTML="",this.site.view.selected.length){t++;const i=document.createElement("tr");i.className="filter-display";let s=document.createElement("td"),a=document.createElement("span");i.appendChild(s),s.appendChild(a),a.className="syntax-variable",a.innerText="Select Entities",i.appendChild(s=document.createElement("td")),s.appendChild(a=document.createElement("span")),a.className="syntax-operator",a.innerText=":",i.appendChild(s=document.createElement("td")),s.setAttribute("colspan","2"),s.appendChild(a=document.createElement("span")),a.className="syntax-value";let n="";this.site.view.selected.forEach((e=>{const t=this.site.data.entities[e];n+=(n?", ":"")+(t&&t.features?t.features.name:e)})),a.innerText=n,e.appendChild(i)}this.site.view.filters.forEach((i=>{const s=i.passed+i.failed;if(i.active&&s){const a=i.passed+"/"+s;i.e.children[1].lastElementChild.innerText=a,t++;const n=document.createElement("tr"),r=this.site.data.variable_info[i.variable];n.className="filter-display";let l=document.createElement("td"),o=document.createElement("span");n.appendChild(l),l.appendChild(o),o.className="syntax-variable",o.title=i.variable,o.innerText=r.short_name,l.appendChild(o=document.createElement("span")),o.innerText=" (",l.appendChild(o=document.createElement("span")),o.className="syntax-component",o.innerText=i.component,l.appendChild(o=document.createElement("span")),o.innerText=")",l=document.createElement("td"),n.appendChild(l),l.appendChild(o=document.createElement("span")),o.className="syntax-operator",o.innerText=i.operator,l=document.createElement("td"),n.appendChild(l),l.appendChild(o=document.createElement("span")),o.className="syntax-value",o.innerText="number"==typeof i.value?this.site.data.format_value(i.value):i.value,l=document.createElement("td"),n.appendChild(l),l.appendChild(o=document.createElement("span")),o.innerText="("+(i.value_source?i.value_source+"; ":"")+a+")",e.appendChild(n)}})),this.e.classList[t?"remove":"add"]("hidden")}if(!("variables"in s.value.parsed)&&!("summary"in s.value.parsed)||e.y in this.depends?"filter"in s.value.parsed&&!("viewFilter"in this.depends)&&(this.depends.viewFilter=!0,this.site.add_dependency("view.filter",{type:"update",id:this.id})):(this.depends[e.y]=!0,this.site.add_dependency(e.y,{type:"update",id:this.id})),s.name.ref){s.name.value_source&&(s.name.value_source=s.value.text);const e=s.name.get(t,i);"object"!=typeof e&&(s.base.firstElementChild.innerText=e)}if(s.value.ref){const e=s.value.get(t,i);Array.isArray(e)?"sources"===s.value.parsed.variables&&(s.base.innerHTML="",s.base.appendChild(document.createElement("table")),s.base.lastElementChild.className="source-table",s.base.firstElementChild.appendChild(document.createElement("thead")),s.base.firstElementChild.firstElementChild.appendChild(document.createElement("tr")),s.base.firstElementChild.firstElementChild.firstElementChild.appendChild(document.createElement("th")),s.base.firstElementChild.firstElementChild.firstElementChild.appendChild(document.createElement("th")),s.base.firstElementChild.firstElementChild.firstElementChild.firstElementChild.innerText="Source",s.base.firstElementChild.firstElementChild.firstElementChild.lastElementChild.innerText="Accessed",s.base.firstElementChild.appendChild(document.createElement("tbody")),e.forEach((e=>{s.base.firstElementChild.lastElementChild.appendChild(z(e,!0))}))):s.base.lastElementChild.innerText=this.parse_variables(e,s.value.parsed.variables,t)}})))):this.tab&&!this.tab.classList.contains("show")||(this.queue=setTimeout((()=>this.update(void 0,void 0,!0)),50))),this.revert()}))}parse_variables(e,t,i){if("statement"===t){const t=this.site.patterns;for(let s,a;s=t.mustache.exec(e);)if("value"===s[1]){a=i?this.site.data.format_value(i.get_value(this.v,this.time),this.dataset in this.site.data.variables[this.v].info&&"integer"===this.site.data.variables[this.v].info[this.dataset].type):NaN;const n=this.site.data.variable_info[this.v];let r=n.unit||n.type;n.aggregation_method&&!(r in te)&&(r=n.aggregation_method),e=e.replace(s[0],!isNaN(a)&&r in te?te[r](a):a),t.mustache.lastIndex=0}else i&&("region_name"===s[1]?(e=e.replace(s[0],i.features.name),t.mustache.lastIndex=0):t.features.test(s[1])?(e=e.replace(s[0],i.features[s[1].replace(t.features,"")]),t.mustache.lastIndex=0):t.variables.test(s[1])?(e=e.replace(s[0],i.variables[this.v][s[1].replace(t.variables,"")]),t.mustache.lastIndex=0):t.data.test(s[1])&&(e=e.replace(s[0],i.get_value(s[1].replace(t.data,""),this.time)),t.mustache.lastIndex=0))}return e}fill_summary_table(e,t,i){const s=e.lastElementChild.firstElementChild.children;j.summary.forEach(((e,a)=>{s[a].innerText=this.site.data.format_value(t[e][i],0===a)}))}},map:class extends ie{constructor(e,t){super(e,t),this.type="map",this.parsed={},this.layers={},this.overlays=[],this.tiles={},this.fresh_shapes=!1,this.has_time=!1,this.by_time=[],this.triggers={},this.vstate="",this.cstate="",this.reference_options={},this.queue_init=this.queue_init.bind(this),this.mouseover=this.mouseover.bind(this),this.mouseout=this.mouseout.bind(this),this.click=this.click.bind(this),this.show_overlay=this.show_overlay.bind(this),this.color=this.e.dataset.color,this.options=this.spec.options,Object.keys(this.options).forEach((e=>{const i=this.options[e];"string"==typeof i&&i in t.inputs&&(this.reference_options[e]=i)})),this.e.style.height||(this.e.style.height=this.options.height?this.options.height:"400px")}init(){const e={type:"update",id:this.id},t=this.site.dataviews[this.view];t?(t.time_agg in this.site.inputs&&this.site.add_dependency(t.time_agg,e),t.y&&this.site.add_dependency(t.y,e)):this.view=this.site.defaults.dataview,this.site.add_dependency(this.view,e),this.color in this.site.inputs&&this.site.add_dependency(this.color,e),this.time&&this.site.add_dependency(this.time,e);const i=this.e.dataset.click;i in this.site.inputs&&(this.clickto=this.site.inputs[i]),this.options.overlays_from_measures&&this.site.data.variable_info&&(Array.isArray(this.spec.overlays)&&(this.overlays=this.spec.overlays),Object.keys(this.site.data.variable_info).forEach((e=>{const t=this.site.data.variable_info[e];if(t.layer&&t.layer.source){const i=[],s={variable:e,source:i};if("string"==typeof t.layer.source&&this.site.patterns.time_ref.test(t.layer.source)){const s=t.layer.source;for(let t,a=this.site.data.meta.ranges[e],n=a[0],r=a[1]+1;n<r;n++)t=this.site.data.meta.overall.value[n],i.push({url:s.replace(this.site.patterns.time_ref,t+""),time:t})}this.site.patterns.time_ref.lastIndex=0,t.layer.filter&&(Array.isArray(t.layer.filter)||"feature"in t.layer.filter)&&(s.filter=t.layer.filter),this.overlays.push(s)}}))),this.queue_init()}queue_init(){const e=this.site.spec.settings.theme_dark?"dark":"light",t=this.deferred||!this.tab||this.tab.classList.contains("show");if(t&&window.L){this.map=window.L.map(this.e,this.options),this.overlay=window.L.featureGroup().addTo(this.map),this.displaying=window.L.featureGroup().addTo(this.map),this.overlay_control=window.L.control.layers().setPosition("topleft").addOverlay(this.overlay,"Overlay").addTo(this.map);const t=this.spec.tiles;t&&("url"in t?(this.tiles[e]=window.L.tileLayer(t.url,t.options),this.tiles[e].addTo(this.map)):Object.keys(t).forEach((i=>{this.tiles[i]=window.L.tileLayer(t[i].url,t[i].options),e===i&&this.tiles[i].addTo(this.map)})));const i=this.site.data.meta.overall.value[this.site.dataviews[this.view].parsed.time_agg];this.spec.shapes.forEach(((e,t)=>{const s="time"in e;s&&(this.has_time||(this.has_time=!0,this.site.add_dependency(this.view,{type:"update",id:this.id})),this.by_time.push(+e.time));let a=e.name;a||(e.name=a=this.site.spec.metadata.datasets[t<this.site.spec.metadata.datasets.length?t:0]);const n=a+(s?e.time:"");n in this.site.maps.queue||(this.site.maps.queue[n]=e),this.site.data.inited[n+this.id]=!1,(this.site.data.loaded[a]||a===this.site.spec.settings.background_shapes)&&(a===n||i&&this.by_time.length&&e.time==this.match_time(i))&&this.retrieve_layer(e)})),this.has_time&&this.by_time.sort(),Array.isArray(this.overlays)&&this.overlays.forEach((e=>{"string"==typeof e.source&&(e.source=[{url:e.source}]);const t=e.source;t.forEach((e=>{e.processed=!1,e.property_summaries={},this.site.maps.queue[e.url]=e})),this.triggers[e.variable]={source:t};const i=e.filter;if(i){const t=Array.isArray(i)?i:[i];this.triggers[e.variable].filter=t,t.forEach((e=>{e.check=k.checks[e.operator]}))}})),this.update()}else this.deferred=!0,setTimeout(this.queue_init,t?0:2e3)}match_time(e){let t=this.by_time.length;for(;t--&&(t&&!(this.by_time[t]<=e)););return this.by_time[t]}show(e){if(e.layer&&e.layer[this.id]){const t={color:"var(--border-highlight)",weight:this.site.spec.settings.polygon_outline+1,fillOpacity:1},i=e.layer[this.id];if("has_time"in i){if(!this.site.data.inited[this.parsed.dataset+this.id]){const e=this.match_time(this.site.data.meta.overall.value[this.site.data.variables[this.parsed.color].time_range[this.parsed.dataset][0]+this.parsed.time]);i[e]&&i[e].setStyle(t)}}else i.setStyle&&i.setStyle(t)}}revert(e){if(e.layer&&e.layer[this.id]){const t={color:"var(--border)",weight:this.site.spec.settings.polygon_outline,fillOpacity:.7},i=e.layer[this.id];if("has_time"in i){if(!this.site.data.inited[this.parsed.dataset+this.id]){const e=this.match_time(this.site.data.meta.overall.value[this.site.data.variables[this.parsed.color].time_range[this.parsed.dataset][0]+this.parsed.time]);i[e]&&i[e].setStyle(t)}}else i.setStyle(t)}}mouseover(e){e.target.setStyle({color:"var(--border-highlight)"}),this.site.subs.update(this.id,"show",this.site.data.entities[e.target.feature.properties[e.target.source.id_property]])}mouseout(e){this.site.subs.update(this.id,"revert",this.site.data.entities[e.target.feature.properties[e.target.source.id_property]]),e.target.setStyle({color:"var(--border)"})}click(e){this.clickto&&this.clickto.set(e.target.feature.properties[e.target.source.id_property])}update(t,i,s){return e(this,void 0,void 0,(function*(){if(this.queue>0&&clearTimeout(this.queue),this.queue=-1,s){if(this.view&&this.displaying){const e=this.parsed,t=this.site.dataviews[this.view],i=t.get.dataset(),s=this.site.valueOf(t.time_agg),a=this.has_time?this.match_time(s):"",n=i+a+this.id in this.site.data.inited,r=n?i+a:i;if(this.site.maps.queue&&r in this.site.maps.queue&&!this.site.data.inited[r+this.id])return void(n&&null===s||this.retrieve_layer(this.site.maps.queue[r],(()=>this.update(void 0,void 0,!0))));!t.valid[i]&&this.site.data.inited[i]&&(t.state="",t.update()),e.view=t,e.dataset=i;const l=t.value()+r+this.site.spec.settings.background_shapes+this.site.spec.settings.background_top+this.site.spec.settings.background_polygon_outline+this.site.data.inited[this.options.background_shapes],o=t.selection.all,d=t.selection[this.site.spec.settings.background_shapes&&this.options.background_shapes?"ids":"all"],h=this.site.valueOf(this.color||t.y);if(this.site.spec.settings.map_overlay&&h in this.triggers?this.show_overlay(this.triggers[h],this.site.data.meta.overall.value[t.parsed.time_agg]):(this.overlay_control.remove(),this.overlay.clearLayers()),this.site.data.inited[r+this.id]&&t.valid[i]){const s=this.time?this.site.inputs[this.time]:t.time_agg?t.time_agg in this.site.inputs?this.site.inputs[t.time_agg]:parseInt(t.time_agg):0,n="number"!=typeof s;e.palette=this.site.valueOf(t.palette)||this.site.spec.settings.palette,e.palette in D||(e.palette=this.site.defaults.palette);const r=yield this.site.data.get_variable(h,this.site.dataviews[this.view]),c=r.views[this.view].summaries[i],u=(n&&s.parsed?s.value()-this.site.data.meta.times[i].range[0]:0)-r.time_range[i][0];e.summary=c,e.time=u,e.color=h;const p=n||c.n[s]!==t.n_selected.dataset?"subset_rank":"rank";if(l!==this.vstate){this.map._zoomAnimated="none"!==this.site.spec.settings.map_animations,Object.keys(this.reference_options).forEach((e=>{this.options[e]=this.site.valueOf(this.reference_options[e]),"zoomAnimation"===e&&(this.map._zoomAnimated=this.options[e])})),this.displaying.clearLayers(),this.fresh_shapes=!0,this.vstate="";let e=0;Object.keys(d).forEach((t=>{const i=d[t].layer&&d[t].layer[this.id];if(i){const s=t in o,n="has_time"in i?i[a]:i;n&&(s||this.options.background_shapes===this.site.data.entities[t].group)&&(e++,n.options.interactive=s,n.addTo(this.displaying),s?this.site.spec.settings.background_top&&n.bringToBack():(this.site.spec.settings.background_top||n.bringToBack(),n.setStyle({fillOpacity:0,color:"var(--border-highlight)",weight:this.site.spec.settings.background_polygon_outline})),this.vstate||(this.vstate=l))}})),this.overlay.bringToFront(),e&&("fly"===this.site.spec.settings.map_animations?setTimeout((()=>this.map.flyToBounds(this.displaying.getBounds())),400):this.map.fitBounds(this.displaying.getBounds()))}const m=h+this.vstate+e.palette+u+this.site.spec.settings.polygon_outline+this.site.spec.settings.color_by_order+this.site.spec.settings.color_scale_center;if(m!==this.cstate){this.cstate=m;const t=this.displaying._layers,s=c.n[u];Object.keys(t).forEach((a=>{const n=t[a];if(i===n.entity.group){const t=o[n.entity.features.id],i=t&&t.views[this.view][p];n.setStyle({fillOpacity:.7,color:"var(--border)",fillColor:t&&h in i?this.site.get_color(t.get_value(h,u),e.palette,c,u,i[h][u],s):this.site.defaults.missing,weight:this.site.spec.settings.polygon_outline})}}))}}}}else this.tab&&!this.tab.classList.contains("show")||(this.queue=setTimeout((()=>this.update(void 0,void 0,!0)),50))}))}retrieve_layer(t,i){return e(this,void 0,void 0,(function*(){const e=t.name?t.name+(t.time||""):t.url;if("_raw"in this.site.spec.map||(this.site.spec.map._raw={}),t.url in this.site.spec.map._raw)this.process_layer(t),this.site.maps.queue[e].retrieved=!0,i&&i();else if(this.site.maps.queue[e]&&"retrieved"in this.site.maps.queue[e])i&&(this.site.maps.queue[e].callbacks||(this.site.maps.queue[e].callbacks=[]),this.site.maps.queue[e].callbacks.push(i));else{this.site.maps.queue[e].retrieved=!1;const s=new window.XMLHttpRequest;s.onreadystatechange=()=>{4===s.readyState&&200===s.status&&(this.site.spec.map._raw[t.url]=s.responseText,t.name&&(this.site.maps.queue[e].retrieved=!0),this.site.maps.queue[e].callbacks?(i&&this.site.maps.queue[e].callbacks.push(i),this.site.maps.queue[e].callbacks.forEach((e=>e()))):i&&i())},s.open("GET",t.url,!0),s.send()}}))}process_layer(e){const t="time"in e,i=e.name+(t?e.time:"");if(this.layers[i]=window.L.geoJSON(JSON.parse(this.site.spec.map._raw[e.url]),{onEachFeature:(i,s)=>{s.on({mouseover:this.mouseover,mouseout:this.mouseout,click:this.click}),s.setStyle({weight:0,fillOpacity:0}),s.source=e;const a=s.feature.properties;let n=a[e.id_property];!(n in this.site.data.entities)&&this.site.patterns.leading_zeros.test(n)&&(n=a[e.id_property]=n.replace(this.site.patterns.leading_zeros,"")),n in this.site.data.entities||(this.site.data.entities[n]={layer:{},features:{id:n}});const r=this.site.data.entities[n];"layer"in r||(r.layer={}),t?(this.id in r.layer||(r.layer[this.id]={has_time:!0}),r.layer[this.id][e.time]=s):r.layer[this.id]=s,s.entity=r,r.features&&Object.keys(a).forEach((e=>{e in r.features||("name"!==e.toLowerCase()||"name"in r.features&&r.features.id!==r.features.name?r.features[e]=a[e]:r.features[e.toLowerCase()]=a[e])}))}}),this.site.data.inited[i+this.id]=!0,this.site.maps.waiting&&this.site.maps.waiting[e.name])for(let t=this.site.maps.waiting[e.name].length;t--;)this.site.request_queue(this.site.maps.waiting[e.name][t])}show_overlay(e,t){let i=0,s="";if("string"==typeof e.source)s=e.source;else for(i=e.source.length;i--;)if(!e.source[i].time||t===e.source[i].time){e.source[i].name&&delete e.source[i].name,s=e.source[i].url;break}if(s){if(!(s in this.site.spec.map._raw))return this.retrieve_layer(e.source[i],(()=>this.show_overlay(e,t)));{if(!(s in this.layers)){const e={};this.site.maps.queue[s].processed||(this.site.maps.queue[s].property_summaries=e),this.layers[s]=window.L.geoJSON(JSON.parse(this.site.spec.map._raw[s]),{pointToLayer:(e,t)=>window.L.circleMarker(t),onEachFeature:t=>{const i=t.properties;i&&Object.keys(i).forEach((t=>{const s=i[t];"number"==typeof s&&(t in e||(e[t]=[1/0,-1/0,0]),s<e[t][0]&&(e[t][0]=s),s>e[t][1]&&(e[t][1]=s))}))}}).on("mouseover",(e=>{const t=e.propagatedFrom;if(t&&!t._tooltip){const e=t.feature&&t.feature.properties;if(e){const i=document.createElement("table");Object.keys(e).forEach((t=>{const s=e[t],a=document.createElement("tr");let n=document.createElement("td");a.appendChild(n),n.innerText=t,a.appendChild(n=document.createElement("td")),n.innerText=s,i.appendChild(a)})),t.bindTooltip(i),t.openTooltip()}}})),Object.keys(e).forEach((t=>{e[t][2]=e[t][1]-e[t][0],e[t][2]||delete e[t]})),this.site.maps.overlay_property_selectors.forEach((e=>{s in e.option_sets||(!function(e,t,i){i[t]={options:[],values:{},display:{}};const s=e.values,a=i[t].options,n=i[t].values,r=i[t].display;e.type;let l=!e.sensitive&&!!e.current_set,o=0;Object.keys(e.site.maps.queue[t].property_summaries).forEach((t=>{const i=e.site.data.format_label(t);l&&!(i in s)&&(e.sensitive=!0,l=!1),a.push(e.add(t,i)),a[o].id=e.id+"-option"+o,n[t]=o,r[i]=o++}))}(e,s,e.option_sets),e.dataset=s,e.variable="")}))}this.site.maps.overlay_property_selectors.forEach((e=>{e.dataset=s,this.site.conditionals.options(e)})),this.overlay.clearLayers();let t=0;const i=this.site.spec.settings.circle_property&&this.site.maps.queue[s].property_summaries,a=i&&i[this.site.spec.settings.circle_property];this.layers[s].eachLayer((i=>{if(e.filter)for(let t=e.filter.length;t--;)if(!e.filter[t].check(i.feature.properties[e.filter[t].feature],e.filter[t].value))return;t++,i.setRadius(a?((i.feature.properties[this.site.spec.settings.circle_property]-a[0])/a[2]+.5)*this.site.spec.settings.circle_radius:this.site.spec.settings.circle_radius).setStyle({weight:this.site.spec.settings.polygon_outline,color:"white",opacity:.5,fillOpacity:.5,fillColor:"black"}),i.addTo(this.overlay)})),t&&this.overlay_control.addTo(this.map)}}}},plotly:class extends ie{constructor(e,t){super(e,t),this.type="plotly",this.previous_span=1,this.traces={},this.parsed={},this.queue=-1,this.state="",this.reference_options={},this.queue_init=this.queue_init.bind(this),this.mouseover=this.mouseover.bind(this),this.mouseout=this.mouseout.bind(this),this.click=this.click.bind(this),this.x=e.dataset.x,this.y=e.dataset.y,this.color=e.dataset.color,this.time=e.dataset.colorTime,Object.keys(this.spec).forEach((e=>{const i=this.spec[e];"string"==typeof i&&i in t.inputs&&(this.reference_options[e]=i)})),this.tab&&document.getElementById(e.parentElement.getAttribute("aria-labelledby")).addEventListener("click",function(){this.e.parentElement.classList.contains("active")||(setTimeout(this.update,155),setTimeout(this.site.page.trigger_resize,155))}.bind(this))}init(){this.x&&!(this.x in this.site.data.variables)&&this.site.add_dependency(this.x,{type:"update",id:this.id}),this.y&&!(this.y in this.site.data.variables)&&this.site.add_dependency(this.y,{type:"update",id:this.id}),this.color&&!(this.color in this.site.data.variables)&&this.site.add_dependency(this.color,{type:"update",id:this.id}),this.time in this.site.inputs&&this.site.add_dependency(this.time,{type:"update",id:this.id}),this.view?(this.site.add_dependency(this.view,{type:"update",id:this.id}),this.site.add_dependency(this.view+"_filter",{type:"update",id:this.id}),this.site.dataviews[this.view].time_agg in this.site.dataviews&&this.site.add_dependency(this.site.dataviews[this.view].time_agg,{type:"update",id:this.id})):this.view=this.site.defaults.dataview,this.spec.data.forEach(((e,t)=>{Object.keys(e).forEach((t=>{if(this.site.patterns.period.test(t)){const i=t.split("."),s=i.length-1;let a;i.forEach(((i,n)=>{a=a?a[i]=n===s?e[t]:{}:e[i]={}}))}})),"textfont"in e||(e.textfont={}),"color"in e.textfont||(e.textfont.color=this.site.defaults.background_highlight),"line"in e||(e.line={}),"color"in e.line||(e.line.color=this.site.defaults.background_highlight),"marker"in e||(e.marker={}),e.marker.size=8,"color"in e.marker||(e.marker.color=this.site.defaults.background_highlight),"line"in e.marker||(e.marker.line={}),"color"in e.marker.line||(e.marker.line.color=this.site.defaults.background_highlight),"text"in e||(e.text=[]),"x"in e||(e.x=[]),"box"===e.type?e.hoverinfo="none":"y"in e||(e.y=[]),this.traces[e.type]=JSON.stringify(e),t||(this.base_trace=e.type,this.base_trace in this.site.inputs&&this.site.add_dependency(this.base_trace,{type:"update",id:this.id}))}));const e=this.e.dataset.click;e in this.site.inputs&&(this.clickto=this.site.inputs[e]),this.queue_init()}show(e){this.revert();let t=this.make_data_entry(e,0,0,"hover_line",this.site.defaults["border_highlight_"+this.site.spec.settings.theme_dark]);t&&(t.line.width=4,t.marker.size=12,Plotly.addTraces(this.e,t,this.e.data.length))}revert(){const e=this.e.data;e.length&&"hover_line"===e[e.length-1].name&&Plotly.deleteTraces(this.e,e.length-1)}queue_init(){const e=this.deferred||!this.tab||this.tab.classList.contains("show");e&&"Plotly"in window?(Plotly.newPlot(this.e,this.spec.data,this.spec.layout,this.spec.config),this.e.on("plotly_hover",this.mouseover),this.e.on("plotly_unhover",this.mouseout),this.e.on("plotly_click",this.click),this.update_theme(),this.update()):(this.deferred=!0,setTimeout(this.queue_init,e?0:2e3))}mouseover(e){e.points&&1===e.points.length&&this.e.data[e.points[0].fullData.index]&&(Plotly.restyle(this.e,{"line.width":5},e.points[0].fullData.index),this.site.subs.update(this.id,"show",this.site.data.entities[e.points[0].data.id]))}mouseout(e){e.points&&1===e.points.length&&this.e.data[e.points[0].fullData.index]&&(Plotly.restyle(this.e,{"line.width":2},e.points[0].fullData.index),this.site.subs.update(this.id,"revert",this.site.data.entities[e.points[0].data.id]))}click(e){this.clickto&&this.clickto.set(e.points[0].data.id)}update(t){return e(this,void 0,void 0,(function*(){if(this.queue>0&&clearTimeout(this.queue),this.queue=-1,t){if(this.e.layout){const e=this.site.dataviews[this.view],t=e.selection&&e.selection.all,i=e.get.dataset(),s=this.site.inputs[this.time||e.time_agg],a=this.parsed;if(this.site.data.inited[i]&&e.valid[i]&&e.time_range.filtered.length){a.base_trace=this.site.valueOf(this.base_trace),a.x=this.site.valueOf(this.x),a.y=this.site.valueOf(this.y),a.color=this.site.valueOf(this.color||e.y||a.y);const n=yield this.site.data.get_variable(a.x,e),r=yield this.site.data.get_variable(a.y,e),l=yield this.site.data.get_variable(a.color,e);a.x_range=n.time_range[i],a.y_range=r.time_range[i],a.view=e,a.dataset=i,a.palette=this.site.valueOf(e.palette)||this.site.spec.settings.palette,a.palette in this.site.palettes||(a.palette=this.site.defaults.palette),a.time=(s?s.value()-this.site.data.meta.times[i].range[0]:0)-l.time_range[i][0],a.summary=l.views[this.view].summaries[i];const o=a.summary.n,d=o[a.time]?a.time:0,h=r.views[this.view].summaries[i],c=o[d],u=c!==e.n_selected.dataset,p=u?"subset_rank":"rank",m=u?l.views[this.view].order[i][d]:l.info[i].order[d],f=[];let _,v,g,b=a.summary.missing[d],y=m?m.length:0,E=this.site.spec.settings,x=E.trace_limit||0,w=e.value()+e.get.time_filters()+i+a.x+a.y+a.time+a.palette+a.color+E.summary_selection+E.color_scale_center+E.color_by_order+E.trace_limit+E.show_empty_times;for(x=g=x&&x<c?Math.ceil(Math.min(x/2,c/2)):0,Object.keys(this.reference_options).forEach((e=>this.spec[e]=this.site.valueOf(this.reference_options[e])));b<y;b++)if(m[b][0]in t){_=m[b][0];const e=t[_];if(w+=_,f.push(this.make_data_entry(e,e.views[this.view][p][a.color][a.time],c)),x&&! --g)break}if(x&&b<y)for(g=b,b=y-1;b>g;b--)if(m[b][0]in t){_=m[b][0];const e=t[_];if(w+=_,f.push(this.make_data_entry(e,e.views[this.view][p][a.color][a.time],c)),! --x)break}if(w+=f.length&&f[0].type,E.boxplots&&"box"in this.traces&&t[_])if(w+="box"+E.iqr_box,v=JSON.parse(this.traces.box),f.push(v),v.line.color=this.site.defaults.border,v.median=h.median,v.q3=h.q3,v.q1=h.q1,E.iqr_box?(v.upperfence=[],v.lowerfence=[],v.q1.forEach(((e,t)=>{isNaN(v.median[t])&&(v.median[t]=0);const i=1.5*(v.q3[t]-e),s=v.median[t];v.q3[t]=isNaN(v.q3[t])?s:Math.max(s,v.q3[t]),v.upperfence[t]=v.q3[t]+i,v.q1[t]=isNaN(v.q1[t])?s:Math.min(s,e),v.lowerfence[t]=e-i}))):(v.upperfence=h.max,v.lowerfence=h.min),E.show_empty_times)v.x=v.q1.map(((e,i)=>t[_].get_value(a.x,i+a.y_range[0])));else for(v.x=[],b=v.q1.length;b--;)o[b]&&(v.x[b]=t[_].get_value(a.x,b+a.y_range[0]));if(w!==this.state){"boolean"!=typeof this.e.layout.yaxis.title&&(this.e.layout.yaxis.title=this.site.data.format_label(a.y)+(E.trace_limit<e.n_selected.all?" ("+E.trace_limit+" extremes)":"")),"boolean"!=typeof this.e.layout.xaxis.title&&(this.e.layout.xaxis.title=this.site.data.format_label(a.x)),this.e.layout.yaxis.autorange=!1,this.e.layout.yaxis.range=[1/0,-1/0],v||(v={upperfence:h.max,lowerfence:h.min});let t=!1;h.min.forEach(((e,i)=>{if(E.show_empty_times||o[i]){const t=Math.min(v.lowerfence[i],e),s=Math.max(v.upperfence[i],h.max[i]);this.e.layout.yaxis.range[0]>t&&(this.e.layout.yaxis.range[0]=t),this.e.layout.yaxis.range[1]<s&&(this.e.layout.yaxis.range[1]=s)}else t=!0}));const s=(this.e.layout.yaxis.range[1]-this.e.layout.yaxis.range[0])/10;if(this.e.layout.yaxis.range[0]-=s,this.e.layout.yaxis.range[1]+=s,this.e.layout.yaxis.range[1]>100){const e=r.info[i].info;e&&"percent"===(e.aggregation_method||e.type)&&(this.e.layout.yaxis.range[1]=100)}if(this.site.data.variables[a.x].is_time){const i=e.time_range.filtered[0],s=e.time_range.filtered[1],a=t&&s>i?Math.log(s-i):.5;this.e.layout.xaxis.autorange?(this.e.layout.xaxis.autorange=!1,this.e.layout.xaxis.type="linear",this.e.layout.xaxis.dtick=1,this.e.layout.xaxis.range=[i-a,s+a]):(this.e.layout.xaxis.range[0]=i-a,this.e.layout.xaxis.range[1]=s+a)}v.lowerfence.length<this.previous_span?(Plotly.newPlot(this.e,f,this.e.layout,this.e.config),this.e.on("plotly_hover",this.mouseover).on("plotly_unhover",this.mouseout).on("plotly_click",this.click)):Plotly.react(this.e,f,this.e.layout,this.e.config),setTimeout(this.site.page.trigger_resize,300),this.previous_span=v.lowerfence.length,this.state=w}}}}else this.tab&&!this.tab.classList.contains("show")||(this.queue=setTimeout((()=>this.update(!0)),50))}))}make_data_entry(e,t,i,s,a){const n=this.site.data;if(e.data&&this.parsed.x in n.variables){const r=n.get_value({variable:this.parsed.x,entity:e}),l=n.get_value({variable:this.parsed.y,entity:e}),o=JSON.parse(this.traces[this.base_trace]),d=n.variables[this.parsed.y].time_range[this.parsed.dataset],h=n.variables[this.parsed.x].time_range[this.parsed.dataset],c=Math.min(d[1],h[1])+1,u=this.parsed.summary.n;for(let t=Math.max(d[0],h[0]);t<c;t++)(this.site.spec.settings.show_empty_times||u[t-this.parsed.y_range[0]])&&(o.text.push(e.features.name),o.x.push(this.parsed.x_range[0]<=t&&t<=this.parsed.x_range[1]?r[t-this.parsed.x_range[0]]:NaN),o.y.push(this.parsed.y_range[0]<=t&&t<=this.parsed.y_range[1]?l[t-this.parsed.y_range[0]]:NaN));return o.type=this.parsed.base_trace,o.color=o.line.color=o.marker.color=o.textfont.color=a||this.site.get_color(e.get_value(this.parsed.color,this.parsed.time),this.parsed.palette,this.parsed.summary,this.parsed.time,t,i)||this.site.defaults.border,"bar"===o.type&&(o.marker.line.width=0),o.name=s||e.features.name,o.id=e.features.id,o}}update_theme(){if(this.dark_theme!==this.site.spec.settings.theme_dark){this.dark_theme=this.site.spec.settings.theme_dark;const e=getComputedStyle(document.body);"style"in this||(this.style=this.spec.layout,"font"in this.style||(this.style.font={}),"modebar"in this.style||(this.style.modebar={})),this.style.paper_bgcolor=e.backgroundColor,this.style.plot_bgcolor=e.backgroundColor,this.style.font.color=e.color,this.style.modebar.bgcolor=e.backgroundColor,this.style.modebar.color=e.color,this.e._fullLayout.xaxis.showgrid&&(this.style.xaxis.gridcolor=e.borderColor),this.e._fullLayout.yaxis.showgrid&&(this.style.yaxis.gridcolor=e.borderColor),Plotly.relayout(this.e,this.spec.layout)}}},datatable:class extends ie{constructor(e,t){super(e,t),this.type="datatable",this.parsed={time:0,color:"",time_index:{}},this.queue=-1,this.pending=-1,this.state="",this.reference_options={},this.header=[],this.rows={},this.rowIds={},this.variable_header=!1,this.current_filter={},this.queue_init=this.queue_init.bind(this),this.mouseover=this.mouseover.bind(this),this.mouseout=this.mouseout.bind(this),this.click=this.click.bind(this),e.appendChild(document.createElement("thead")),e.appendChild(document.createElement("tbody")),this.style=document.head.appendChild(document.createElement("style")),e.addEventListener("mouseover",this.mouseover),e.addEventListener("mouseout",this.mouseout),Object.keys(this.spec).forEach((e=>{const i=this.spec[e];"string"==typeof i&&i in t.inputs&&(this.reference_options[e]=i)})),"string"==typeof this.spec.variables&&(this.spec.variable_source=this.spec.variables),this.tab&&document.getElementById(e.parentElement.getAttribute("aria-labelledby")).addEventListener("click",function(){this.e.parentElement.classList.contains("active")||(setTimeout(this.update,155),setTimeout(this.site.page.trigger_resize,155))}.bind(this))}init(){if(this.parsed.dataset=this.site.dataviews[this.view].get.dataset(),this.spec.variables?"string"==typeof this.spec.variables&&(this.spec.variables in this.site.inputs?(this.site.add_dependency(this.spec.variables,{type:"update",id:this.id}),this.spec.variables=this.site.valueOf(this.spec.variables),this.spec.single_variable="string"==typeof this.spec.variables):this.spec.single_variable||(this.spec.variables=[{name:this.spec.variables}])):this.spec.variables=Object.keys(this.site.data.variables),Array.isArray(this.spec.variables)){const e=this.spec.variables;e.length&&"string"==typeof e[0]&&(this.variables=e.map((e=>({name:e}))))}else"string"==typeof this.spec.variables&&(this.variables={name:this.spec.variables});const t=this.site.data.meta.times[this.parsed.dataset];if(this.spec.single_variable){const e=this.variables;this.header.push({title:"Name",data:"entity.features.name"}),t&&t.is_single&&(this.variable_header=!0);const i=e.name in this.site.data.variables&&this.site.data.variables[e.name].time_range[this.parsed.dataset];if(i)for(let s=i[1]-i[0]+1;s--;)this.header[s+1]={title:this.variable_header?e.title||this.site.data.format_label(e.name):t.value[s+i[0]]+"",data:this.site.data.get_value,render:k.retrievers.row_time.bind({i:s,o:i[0],format_value:this.site.data.format_value.bind(this.site.data)})};this.spec.order=[[this.header.length-1,"dsc"]]}else if(this.spec.wide){this.spec.features&&("string"==typeof this.spec.features&&(this.spec.features=[{name:this.spec.features}]),this.spec.features.forEach((e=>{this.header.push({title:e.title||e.name,data:"entity.features."+e.name.replace(this.site.patterns.all_periods,"\\.")})})));const t=this.variables;for(let i=t.length;i--;){const s=t[i];s.source||(s.source=s.name in this.site.data.variables?"data":"features"),this.header.push("features"===s.source?{title:s.title||this.site.data.format_label(s.name),data:"entity.features."+s.name.toLowerCase().replace(this.site.patterns.all_periods,"\\.")}:{title:s.title||this.site.data.format_label(s.name),render:function(t,i,s){return e(this,void 0,void 0,(function*(){if("data"===this.c.source){if(this.c.name in this.o.site.data.variables){const e=yield this.o.site.data.get_variable(this.c.name,this.o.site.dataviews[this.o.view]),t=s.time-e.time_range[this.o.parsed.dataset][0];return t<0?NaN:s.entity.get_value(this.c.name,t)}return NaN}return this.c.source in s.entity&&this.c.name in s.entity[this.c.source]?s.entity[this.c.source][this.c.name]:NaN}))}.bind({o:this,c:s})})}}else t.is_single||this.header.push({title:"Year",data:"entity.time.value",render:function(e,t,i){const s=i.time+i.offset;return e&&s>=0&&s<e.length?e[s]:NaN}}),this.spec.features&&("string"==typeof this.spec.features&&(this.spec.features=[{name:this.spec.features}]),this.spec.features.forEach((e=>{this.header.splice(0,0,{title:e.title||e.name,data:"entity.features."+e.name.replace(this.site.patterns.all_periods,"\\.")})}))),this.header.push({title:"Variable",data:function(e){return e.variable in e.entity.variables?e.entity.variables[e.variable].meta.short_name:e.variable}}),this.header.push({title:"Value",data:this.site.data.get_value,render:(e,t,i)=>e?"number"==typeof e[i.time]?this.site.data.format_value(e[i.time],i.int):e[i.time]:""});this.view?(this.site.add_dependency(this.view,{type:"update",id:this.id}),this.site.add_dependency(this.view+"_filter",{type:"update",id:this.id}),this.site.add_dependency(this.site.dataviews[this.view].time_agg,{type:"update",id:this.id})):this.view=this.site.defaults.dataview;const i=this.e.dataset.click;i in this.site.inputs&&(this.clickto=this.site.inputs[i],this.e.addEventListener("click",this.click)),this.queue_init()}show(e){if(e.features&&e.features.id in this.rows){this.site.spec.settings.table_autoscroll&&this.rows[e.features.id].scrollTo("smooth"===this.site.spec.settings.table_scroll_behavior),this.pending>0&&clearTimeout(this.pending),this.pending=-1;const t=this.rows[e.features.id].node();t?t.classList.add("highlighted"):this.pending=setTimeout(function(){const e=this.node();e&&e.classList.add("highlighted")}.bind(this.rows[e.features.id]),0)}}revert(){this.pending>0&&clearTimeout(this.pending),this.e.querySelectorAll("tr.highlighted").forEach((e=>e.classList.remove("highlighted")))}queue_init(){const e=this.deferred||!this.tab||this.tab.classList.contains("show");e&&"jQuery"in window&&"DataTable"in window&&"get"in this.site.dataviews[this.view]?(this.spec.columns=this.header,this.table=$(this.e).DataTable(this.spec),this.update()):(this.deferred=!0,setTimeout(this.queue_init,e?0:2e3))}update(t){return e(this,void 0,void 0,(function*(){if(this.queue>0&&clearTimeout(this.queue),this.queue=-1,t){if(this.table){let e=this.spec.variable_source&&this.site.valueOf(this.spec.variable_source).replace(this.site.patterns.all_periods,"\\.");const i=this.site.dataviews[this.view],s=i.get.dataset();if(!this.site.data.inited[s])return;const a=this.site.spec.settings,n=this.site.data.meta.times[s],r=s+i.value()+i.get.time_filters()+a.digits+e+a.theme_dark+a.show_empty_times,l=r!==this.state,o=this.site.valueOf(i.time_agg),d=yield this.site.data.get_variable(e,i);if(this.parsed.time_range=d?d.time_range[s]:n.info.time_range[s],this.parsed.time=("number"==typeof o?o-n.range[0]:0)-this.parsed.time_range[0],l){if(this.rows={},this.rowIds={},this.table.clear(),i.valid[s]){if(this.state=r,Object.keys(this.reference_options).forEach((e=>this.spec[e]=this.site.valueOf(this.reference_options[e]))),!Array.isArray(this.variables)){if(this.parsed.time_index={},this.parsed.dataset=s,this.parsed.color=e,this.parsed.summary=this.view in d.views?d.views[this.view].summaries[s]:void 0,this.parsed.order=this.view in d.views?d.views[this.view].order[s][this.parsed.time]:void 0,this.header.length<2||s!==this.header[1].dataset||e!==this.header[1].variable){if(this.table.destroy(),$(this.e).empty(),this.header=[{title:"Name",data:"entity.features.name",type:"string"}],-1!==this.parsed.time_range[0])for(let t=this.parsed.time_range[2];t--;)this.header[t+1]={dataset:s,variable:e,type:"string"===d.type?"string":"num",title:this.variable_header?this.variables.title||this.site.data.format_label(e):n.value[t+this.parsed.time_range[0]]+"",data:this.site.data.get_value,render:k.retrievers.row_time.bind({i:t,o:this.parsed.time_range[0],format_value:this.site.data.format_value.bind(this.site.data)})};else this.state="";this.spec.order[0][0]=this.header.length-1,this.spec.columns=this.header,this.table=$(this.e).DataTable(this.spec)}const t=this.header.length,r=this.parsed.summary.n;let l;for(let e=1,s=!1,o=0;e<t;e++)s=i.times[e-1+this.parsed.time_range[0]]&&(a.show_empty_times||!!r[e-1]),this.table.column(e).visible(s,!1),s&&(this.parsed.time_index[n.value[e-1+this.parsed.time_range[0]]]=++o,l=!1);l&&(this.state="")}if(this.spec.wide)Object.keys(i.selection.all).forEach((t=>{if(e)e in i.selection.all[t].views[this.view].summary&&(this.rows[t]=this.table.row.add({dataset:s,variable:e,offset:this.parsed.time_range[0],entity:i.selection.all[t],int:s in this.site.data.variables[e].info&&"integer"===this.site.data.variables[e].info[s].type}),this.rowIds[this.rows[t].selector.rows]=t);else for(let e=n.n;e--;)this.rows[t]=this.table.row.add({time:e,entity:i.selection.all[t]}),this.rowIds[this.rows[t].selector.rows]=t}));else if(Array.isArray(this.variables)){this.spec.filters&&Object.keys(this.spec.filters).forEach((e=>{this.current_filter[e]=this.site.valueOf(e)}));const n=[];let r=""+this.parsed.dataset+i.get.single_id()+i.get.features()+a.digits;for(let a=this.variables.length;a--;){e=this.variables[a].name,t=!this.spec.filters;const l=yield this.site.data.get_variable(e,i);if(e in this.site.data.variables&&"meta"in l)if(this.spec.filters){for(const e in this.current_filter)if(e in l.meta&&!(t=l.meta[e]===this.current_filter[e]))break}else t=!0;t&&(r+=e,n.push({variable:e,int:this.site.patterns.int_types.test(this.site.data.variables[e].type),time_range:l.time_range[s],renderer:function(e,t){const i=t.features.id,a=this.time_range,n=a[1];for(let r=a[0];r<=n;r++)e.rows[i]=e.table.row.add({offset:this.time_range[0],time:r-this.time_range[0],dataset:s,variable:this.variable,entity:t,int:this.int}),e.rowIds[e.rows[i].selector.rows]=i}}))}if(r===this.varstate)return;this.varstate=r,Object.keys(i.selection.all).forEach((t=>{const a=i.selection.all[t];this.spec.single_variable?e in a.views[this.view].summary&&d.code in a.data&&(this.rows[t]=this.table.row.add({offset:this.parsed.time_range[0],dataset:s,variable:e,entity:a,int:this.site.patterns.int_types.test(this.site.data.variables[e].type)}),this.rowIds[this.rows[t].selector.rows]=t):n.forEach((e=>{this.site.data.variables[e.variable].code in a.data&&e.renderer(this,a)}))}))}}this.table.draw()}if(this.parsed.time>-1&&this.header.length>1&&i.time_range.filtered_index&&(this.style.sheet.cssRules.length&&this.style.sheet.deleteRule(0),this.parsed.time_index[o]&&this.style.sheet.insertRule("#"+this.id+" td:nth-child("+(this.parsed.time_index[o]+1)+"){background-color: var(--background-highlight)}",0),!l&&this.site.spec.settings.table_autosort&&this.table.order([this.parsed.time+1,"dsc"]).draw(),this.site.spec.settings.table_autoscroll)){const e=this.e.parentElement.getBoundingClientRect().width,t=this.table.column(this.parsed.time+1).header().getBoundingClientRect();t&&this.e.parentElement.scroll({left:t.x-this.e.getBoundingClientRect().x+t.width+16-e,behavior:this.site.spec.settings.table_scroll_behavior||"smooth"})}}}else this.tab&&!this.tab.classList.contains("show")||(this.queue=setTimeout((()=>this.update(!0)),50))}))}mouseover(e){if(e.target._DT_CellIndex&&e.target._DT_CellIndex.row in this.rowIds){const t=this.rowIds[e.target._DT_CellIndex.row],i=this.rows[t].node();i&&i.classList.add("highlighted"),t in this.site.data.entities&&this.site.subs.update(this.id,"show",this.site.data.entities[t])}}mouseout(e){if(e.target._DT_CellIndex&&e.target._DT_CellIndex.row in this.rowIds){const t=this.rowIds[e.target._DT_CellIndex.row],i=this.rows[t].node();i&&i.classList.remove("highlighted"),t in this.site.data.entities&&this.site.subs.update(this.id,"revert",this.site.data.entities[t])}}click(e){if(this.clickto&&e.target._DT_CellIndex&&e.target._DT_CellIndex.row in this.rowIds){const t=this.rowIds[e.target._DT_CellIndex.row];t in this.site.data.entities&&this.clickto.set(t)}}},table:class extends ie{constructor(e,t){super(e,t),this.type="table",this.parsed={},this.queue=-1,this.state="",this.reference_options={},this.header=[],this.rows={},this.parts={head:document.createElement("thead"),body:document.createElement("tbody")},this.current_variable="",this.mouseover=this.mouseover.bind(this),this.mouseout=this.mouseout.bind(this),this.click=this.click.bind(this),this.parts.head.appendChild(document.createElement("tr")),e.appendChild(this.parts.head),e.appendChild(this.parts.body),Object.keys(this.spec).forEach((e=>{const i=this.spec[e];"string"==typeof i&&i in t.inputs&&(this.reference_options[e]=i)})),"string"==typeof this.spec.variables&&(this.spec.variable_source=this.spec.variables),e.addEventListener("mouseover",this.mouseover),e.addEventListener("mouseout",this.mouseout),this.tab&&document.getElementById(e.parentElement.getAttribute("aria-labelledby")).addEventListener("click",function(){e.parentElement.classList.contains("active")||(setTimeout(this.update,155),setTimeout(this.site.page.trigger_resize,155))}.bind(this))}init(){this.spec.variable_source in this.site.inputs&&this.site.add_dependency(this.spec.variable_source,{type:"update",id:this.id}),this.view?(this.site.add_dependency(this.view,{type:"update",id:this.id}),this.site.add_dependency(this.view+"_filter",{type:"update",id:this.id}),this.site.add_dependency(this.site.dataviews[this.view].time_agg,{type:"update",id:this.id})):this.view=this.site.defaults.dataview;const e=this.e.dataset.click;e in this.site.inputs&&(this.e.dataset.click&&this.e.classList.add("interactive"),this.clickto=this.site.inputs[e],this.e.addEventListener("click",this.click)),this.update()}show(e){if(e.features){const t=this.rows[e.features.id];if(t&&t.parentElement&&(t.classList.add("highlighted"),this.site.spec.settings.table_autoscroll)){const e=this.e.parentElement.getBoundingClientRect().height,i=t.getBoundingClientRect().y-t.parentElement.getBoundingClientRect().y;this.e.parentElement.scroll({top:e>this.e.scrollHeight-i?this.e.parentElement.scrollHeight:i,behavior:this.site.spec.settings.table_scroll_behavior||"smooth"})}}}revert(e){e.features&&e.features.id in this.rows&&this.rows[e.features.id].classList.remove("highlighted")}createHeader(e){const t=this.parsed.dataset,i=this.site.data.meta.times[t],s=this.parts.head.firstElementChild,a=this.parsed.variable.time_range[t],n=a[0],r=a[1]+1,l=this.parsed.summary.n;let o=document.createElement("th"),d=document.createElement("span");this.parsed.time_index={},s.innerHTML="",s.appendChild(o),o.appendChild(d),d.innerText="Name";for(let t=n,a=0;t<r;t++)e.times[t]&&(this.site.spec.settings.show_empty_times||l[t-n])&&(this.parsed.time_index[i.value[t]]=a++,s.appendChild(o=document.createElement("th")),o.appendChild(d=document.createElement("span")),d.innerText=i.value[t]+"")}appendRows(e){const t=this.parsed.order,i=this.parsed.variable,s=this.site.data.meta.times[this.parsed.dataset].value,a=i.time_range[this.parsed.dataset],n=a[0],r=a[1]-n+1,l=e.selection.all;this.current_variable=i.code+this.parsed.dataset,this.parts.body.innerHTML="";for(let a=t.length;a--;){const o=t[a][0];if(o in l){const t=this.site.data.entities[o],a=t.data[i.code],l=document.createElement("tr");this.rows[o]=l,l.dataset.entityId=o;let d=document.createElement("td");if(d.innerText=t.features.name,l.appendChild(d),Array.isArray(a))for(let t=0;t<r;t++)e.times[t+n]&&s[t+n]in this.parsed.time_index&&(l.appendChild(d=document.createElement("td")),d.innerText=this.site.data.format_value(a[t]),t===this.parsed.time&&d.classList.add("highlighted"));else l.appendChild(d=document.createElement("td")),d.innerText=this.site.data.format_value(a),d.dataset.entityId=o,d.classList.add("highlighted");this.parts.body.appendChild(l)}}if(this.site.spec.settings.table_autoscroll&&this.parts.head.firstElementChild.childElementCount>2&&this.parts.head.firstElementChild.childElementCount>this.parsed.time+1){const e=this.e.parentElement.getBoundingClientRect().width,t=this.parts.head.firstElementChild.children[this.parsed.time+1].getBoundingClientRect();this.e.parentElement.scroll({left:t.x-this.e.getBoundingClientRect().x+t.width+16-e,behavior:this.site.spec.settings.table_scroll_behavior||"smooth"})}}update(t){return e(this,void 0,void 0,(function*(){if(this.queue>0&&clearTimeout(this.queue),this.queue=-1,t){let e=this.spec.variable_source&&this.site.valueOf(this.spec.variable_source).replace(this.site.patterns.all_periods,"\\.");const t=this.site.dataviews[this.view],i=t.get.dataset(),s=this.site.valueOf(t.time_agg),a=i+t.value()+t.get.time_filters()+this.site.spec.settings.digits+e+s+this.site.spec.settings.show_empty_times;if(!this.site.data.inited[i])return;if(a!==this.state){this.state=a,Object.keys(this.reference_options).forEach((e=>this.spec[e]=this.site.valueOf(this.reference_options[e])));const n=yield this.site.data.get_variable(e,t);this.parsed.dataset=i,this.parsed.color=e,this.parsed.variable=n,this.parsed.time_range=n.time_range[i],this.parsed.time=("number"==typeof s?s-this.site.data.meta.times[i].range[0]:0)-this.parsed.time_range[0],this.parsed.summary=n.views[this.view].summaries[i],this.parsed.order=n.views[this.view].order[i][this.parsed.time],this.createHeader(t),this.appendRows(t)}}else this.tab&&!this.tab.classList.contains("show")||(this.queue=setTimeout((()=>this.update(!0)),50))}))}mouseover(e){const t=e.target,i="TD"===t.tagName?t.parentElement:t,s=i.dataset.entityId;s&&(i.classList.add("highlighted"),this.site.subs.update(this.id,"show",this.site.data.entities[s]))}mouseout(e){const t=e.target,i="TD"===t.tagName?t.parentElement:t,s=i.dataset.entityId;s&&(i.classList.remove("highlighted"),this.site.subs.update(this.id,"revert",this.site.data.entities[s]))}click(e){const t=e.target,i=("TD"===t.tagName?t.parentElement:t).dataset.entityId;this.clickto&&i&&this.clickto.set(i)}},legend:class extends ie{constructor(e,t){super(e,t),this.type="legend",this.state="",this.parsed={time:0,color:"",bins:0,rank:!1},this.queue={lock:!1,cooldown:-1,reset:function(){this.lock=!1}},this.integer=!1,this.ticks={center:document.createElement("div"),min:document.createElement("div"),max:document.createElement("div"),entity:document.createElement("div")},this.current_palette="",this.mouseover=this.mouseover.bind(this),this.mouseout=this.mouseout.bind(this),this.click=this.click.bind(this),this.update=this.update.bind(this),e.addEventListener("mousemove",this.mouseover),e.addEventListener("mouseout",this.mouseout),e.addEventListener("click",this.click),this.variable=this.e.dataset.variable,this.queue.trigger=function(){this.mouseover(this.queue.e)}.bind(this),this.queue.reset=this.queue.reset.bind(this.queue),this.parts={ticks:this.e.querySelector(".legend-ticks"),scale:this.e.querySelector(".legend-scale"),summary:this.e.querySelector(".legend-summary")},this.parts.ticks.dataset.of=this.parts.scale.dataset.of=this.parts.summary.dataset.of=this.id,this.parts.summary.appendChild(this.ticks.center),this.parts.summary.appendChild(this.ticks.min),this.parts.summary.appendChild(this.ticks.max),this.parts.ticks.appendChild(this.ticks.entity)}init(){this.site.add_dependency(this.view,{type:"update",id:this.id});const e=this.site.dataviews[this.view];if("string"==typeof e.time_agg&&e.time_agg in this.site.inputs&&this.site.add_dependency(e.time_agg,{type:"update",id:this.id}),this.palette||(e.palette?(this.palette=e.palette,e.palette in this.site.inputs&&this.site.add_dependency(e.palette,{type:"update",id:this.id})):this.palette="settings.palette"in this.site.inputs?"settings.palette":this.site.spec.settings.palette),this.variable?this.variable in this.site.inputs&&this.site.add_dependency(this.variable,{type:"update",id:this.id}):e.y in this.site.inputs&&this.site.add_dependency(e.y,{type:"update",id:this.id}),this.palette in this.site.inputs){const e=this.site.inputs[this.palette];e.e&&e.e.addEventListener("change",this.update)}const t=this.e.dataset.click;t in this.site.inputs&&(this.clickto=this.site.inputs[t]),Object.keys(this.ticks).forEach((e=>{const t=document.createElement("div");let i=document.createElement("p");this.ticks[e].dataset.of=this.id,this.ticks[e].className="legend-tick",this.ticks[e].appendChild(t),t.dataset.of=i.dataset.of=this.id,t.appendChild(i),"m"!==e.substring(0,1)&&(t.appendChild(i=document.createElement("p")),i.dataset.of=this.id,t.appendChild(i=document.createElement("p")),i.dataset.of=this.id,"entity"===e?this.ticks[e].firstElementChild.lastElementChild.classList.add("entity"):this.ticks[e].firstElementChild.firstElementChild.classList.add("summary"))})),this.ticks.entity.firstElementChild.classList.add("hidden"),this.ticks.max.className="legend-tick-end max",this.ticks.min.className="legend-tick-end min",this.ticks.center.style.left="50%",this.update()}show(e){if(e&&e.features.name){const t=this.site.dataviews[this.view],i=this.parsed.summary,s=this.parsed.time,a=this.parsed.color,n=i&&"string"===i.type,r=i&&!n?i.min[s]:0,l=i?n?i.levels.length-r:i.range[s]:1,o=i.n[s],d=o===t.n_selected.dataset?"rank":"subset_rank",h=this.site.data.entities[e.features.id].views[this.view],c=e.get_value(a,s),u=100*((n?c in i.level_ids:"number"==typeof c)?this.site.spec.settings.color_by_order?NaN:Math.max(0,Math.min(1,l?((n?i.level_ids[c]:c)-r)/l:.5)):NaN),p=this.ticks.entity,m=p.firstElementChild.children[1];if(isFinite(u))m.parentElement.classList.remove("hidden"),m.innerText=this.site.data.format_value(c,this.integer),p.style.left=u+"%",p.firstElementChild.firstElementChild.innerText=(u>96||u<4)&&e.features.name.length>13?e.features.name.substring(0,12)+"…":e.features.name;else if(this.site.spec.settings.color_by_order&&a in h[d]){const t=h[d][a][s],i=o>1?t/(o-1)*100:0;p.firstElementChild.firstElementChild.innerText=t>-1&&(i>96||i<4)&&e.features.name.length>13?e.features.name.substring(0,12)+"…":e.features.name,t>-1&&(m.parentElement.classList.remove("hidden"),m.innerText="# "+(o-t),p.style.left=i+"%")}p.style.marginLeft=-p.getBoundingClientRect().width/2+"px"}}revert(){this.ticks.entity.firstElementChild.classList.add("hidden")}update(){return e(this,void 0,void 0,(function*(){const e=this.site.dataviews[this.view],t=this.site.valueOf(this.variable||e.y),i=e.get.dataset(),s=yield this.site.data.get_variable(t,e),a=this.site.valueOf(e.time_agg),n=this.site.palettes;if(null!==a&&e.valid[i]&&s&&this.view in s.views){const e=("number"==typeof a?a-this.site.data.meta.times[i].range[0]:0)-s.time_range[i][0],r=s.views[this.view].summaries[i],l=this.site.valueOf(this.palette).toLowerCase(),o=l in n?l:this.site.spec.settings.palette in n?this.site.spec.settings.palette:this.site.defaults.palette,d=n[o],h=d.colors.length,c=this.parts.scale,u=this.ticks;if(this.parsed.summary=r,this.parsed.order=s.views[this.view].order[i][e],this.parsed.time=e,this.parsed.color=t,r&&e<r.n.length){this.integer=i in s.info&&"integer"===s.info[i].type;const t=this.site.spec.settings.color_by_order!==this.parsed.rank,a=c.querySelectorAll("span"),n=d.odd,l="discrete"===d.type?!a.length||h!==this.parsed.bins:!c.firstElementChild||"SPAN"!==c.firstElementChild.tagName;if(this.parsed.bins=h,o+this.site.spec.settings.color_scale_center!==this.current_palette||t)if(this.current_palette=o+this.site.spec.settings.color_scale_center,this.parsed.rank=this.site.spec.settings.color_by_order,l&&(c.innerHTML=""),"discrete"===d.type){const e=Math.ceil(h/2);let t,i=0,s=document.createElement("div");if(l){c.appendChild(s),s.dataset.of=this.id,s.style.left="0";const a=1/(e-n/2)*100+"%";for(;i<e;i++)s.appendChild(t=document.createElement("span")),t.dataset.of=this.id,t.style.backgroundColor=d.colors[i],t.style.width=a;for(n&&(t.style.width=1/(e-n/2)*100/2+"%"),c.appendChild(s=document.createElement("div")),s.dataset.of=this.id,s.style.right="0",i=Math.floor(h/2);i<h;i++)s.appendChild(t=document.createElement("span")),t.dataset.of=this.id,t.style.backgroundColor=d.colors[i],t.style.width=a;n&&(s.firstElementChild.style.width=1/(Math.ceil(h/2)-n/2)*100/2+"%")}else{for(;i<e;i++)a[i].style.backgroundColor=d.colors[i];for(i=Math.floor(h/2);i<h;i++)a[i+n].style.backgroundColor=d.colors[i]}}else"continuous-polynomial"!==d.type&&(l&&(c.appendChild(document.createElement("span")),c.appendChild(document.createElement("span"))),c.firstElementChild.style.background="linear-gradient(0.25turn, rgb("+d.colors[2][0][0]+", "+d.colors[2][0][1]+", "+d.colors[2][0][2]+"), rgb("+d.colors[1][0]+", "+d.colors[1][1]+", "+d.colors[1][2]+"))",c.lastElementChild.style.background="linear-gradient(0.25turn, rgb("+d.colors[1][0]+", "+d.colors[1][1]+", "+d.colors[1][2]+"), rgb("+d.colors[0][0][0]+", "+d.colors[0][0][1]+", "+d.colors[0][0][2]+"))");const p=this.site.spec.settings.color_scale_center;if("string"===s.type)u.center.classList.remove("hidden"),u.min.firstElementChild.firstElementChild.innerText=s.levels[0],u.max.firstElementChild.firstElementChild.innerText=s.levels[s.levels.length-1];else if(this.site.spec.settings.color_by_order)u.center.classList.add("hidden"),u.min.firstElementChild.firstElementChild.innerText="# "+(r.n[e]?r.n[e]:0),u.max.firstElementChild.firstElementChild.innerText="# "+(r.n[e]?1:0);else{const i=""+r.n[e]+r.min[e]+r.max[e]+this.site.spec.settings.digits+p+this.site.spec.settings.summary_selection;(l||t||i!==this.state)&&(this.state=i,u.center.classList.remove("hidden"),u.min.firstElementChild.firstElementChild.innerText=(r.n[e]&&isFinite(r.min[e])?this.site.data.format_value(r.min[e],this.integer):NaN)+"",u.max.firstElementChild.firstElementChild.innerText=(r.n[e]&&isFinite(r.max[e])?this.site.data.format_value(r.max[e],this.integer):NaN)+"","none"===p?(u.center.firstElementChild.lastElementChild.innerText=ae[this.site.spec.settings.summary_selection]+" median",u.center.firstElementChild.children[1].innerText=this.site.data.format_value(r.median[e]),u.center.style.left=100*r.norm_median[e]+"%"):(u.center.firstElementChild.lastElementChild.innerText=ae[this.site.spec.settings.summary_selection]+" "+p,u.center.firstElementChild.children[1].innerText=this.site.data.format_value(r[p][e]),u.center.style.left=100*r["norm_"+p][e]+"%"),u.center.style.marginLeft=-u.center.getBoundingClientRect().width/2+"px")}this.site.spec.settings.color_by_order||"none"===p?(c.firstElementChild.style.width="50%",c.lastElementChild.style.width="50%"):(c.firstElementChild.style.width=100*r["norm_"+p][e]+"%",c.lastElementChild.style.width=100-100*r["norm_"+p][e]+"%")}}}))}mouseover(e){if(!this.queue.lock&&"clientX"in e){this.queue.lock=!0;const t=this.parts.scale.getBoundingClientRect(),i=(Math.max(t.x,Math.min(t.x+t.width,e.clientX))-t.x)/t.width;let s;if(this.site.spec.settings.color_by_order)this.parsed.order&&this.parsed.order.length&&(s=this.site.data.entities[this.parsed.order[Math.max(this.parsed.summary.missing[this.parsed.time],Math.min(this.parsed.order.length-1,Math.floor((this.parsed.order.length-1)*i)))][0]]);else if("min"in this.parsed.summary){const e=this.parsed.summary.min[this.parsed.time],t=e+i*(this.parsed.summary.max[this.parsed.time]-e);let a,n;if(this.parsed.order&&this.parsed.order.length&&(n=this.parsed.summary.missing[this.parsed.time],n<this.parsed.order.length))if(1!==this.parsed.order.length&&i){for(a=this.parsed.order.length-2;a>=n&&!((this.parsed.order[a][1]+this.parsed.order[a+1][1])/2<=t);--a);a++,s=this.site.data.entities[this.parsed.order[a][0]]}else s=this.site.data.entities[this.parsed.order[n][0]]}s&&(this.show(s),this.entity&&s.features.id===this.entity.features.id||(this.entity?this.site.subs.update(this.id,"revert",this.entity):this.entity=s,this.site.subs.update(this.id,"show",s),this.entity=s)),setTimeout(this.queue.reset,200)}else this.queue.cooldown>0&&clearTimeout(this.queue.cooldown),this.queue.e=e,this.queue.cooldown=setTimeout(this.queue.trigger,100)}mouseout(e){const t=e.relatedTarget;t&&this.id!==t.dataset.of&&(this.queue.cooldown>0&&clearTimeout(this.queue.cooldown),this.queue.cooldown=-1,this.revert(),this.entity&&(this.site.subs.update(this.id,"revert",this.entity),this.entity=void 0))}click(){this.clickto&&this.entity&&(this.revert(),this.clickto.set(this.entity.features.id))}},text:class extends ie{constructor(e,t){super(e,t),this.type="text",this.depends=new Map,this.update=this.update.bind(this),this.prep=this.prep.bind(this),this.text=this.spec.text,this.condition=this.spec.condition||[]}init(){this.text.forEach((e=>{Array.isArray(e)?(this.e.appendChild(document.createElement("span")),e.forEach(this.prep)):(this.prep(e),this.e.appendChild(e.parts))})),this.condition.forEach((e=>{e.id in this.site.inputs&&this.site.add_dependency(e.id,{type:"display",id:this.id})})),this.depends.forEach((e=>this.site.add_dependency(e.id,{type:"update",id:this.id}))),this.update()}update(){this.depends.forEach((e=>{e.parsed=this.site.valueOf(e.id);const t=this.site.inputs[e.id];t&&("values"in t&&"options"in t&&!Array.isArray(t.values)&&e.parsed in t.values?e.parsed=t.options[t.values[e.parsed]].innerText:e.parsed="display"in t&&e.parsed in t.display?t.display[e.parsed]:this.site.data.format_label(e.parsed))})),this.text.forEach(((e,t)=>{let i,s=!0;if(Array.isArray(e))for(let t=e.length;t--;){if("condition"in e[t])for(let i=e[t].condition.length;i--&&(s=e[t].condition[i].check(),s););if(s){i=e[t];break}}else{if("condition"in e)for(let t=e.condition.length;t--&&(s=e.condition[t].check(),s););s&&(i=e)}s?(i.text.forEach(((e,t)=>{if(Array.isArray(e)&&e.forEach((t=>{("default"===t.id||k.checks[t.type](this.site.valueOf(t.id),this.site.valueOf(t.value)))&&(e=t.text)})),this.depends.has(e))i.parts.children[t].innerText=this.depends.get(e).parsed;else if(e in i.button){let s="";i.button[e].text.forEach((e=>{s=(this.depends.has(e)?this.depends.get(e).parsed:e)+s})),i.parts.children[t].innerText=s}else i.parts.children[t].innerText=e})),Array.isArray(this.text[t])?(this.e.children[t].innerHTML="",this.e.children[t].appendChild(i.parts)):i.parts.classList.remove("hidden")):Array.isArray(e)?e.forEach((e=>e.parts.classList.add("hidden"))):e.parts.classList.add("hidden")}))}prep(e){if("button"in e||(e.button={}),"string"==typeof e.text&&(e.text=[e.text]),e.parts=document.createElement("span"),e.text.forEach((t=>{if(t in e.button){const i=e.button[t],s=document.createElement("button");if(e.parts.appendChild(s),s.type="button",i.trigger=R.bind({id:this.id+i.text,note:i.target,wrapper:s}),"note"===i.type)s.setAttribute("aria-description",i.target),s.dataset.of=this.id+i.text,s.className="has-note",s.addEventListener("mouseover",i.trigger),s.addEventListener("focus",i.trigger),s.addEventListener("blur",this.site.page.tooltip_clear);else{s.className="btn btn-link",Array.isArray(i.target)||(i.target=[i.target]);const e=new Map;i.target.forEach((t=>{const s=this.site.inputs[t],a=i.type;s&&"function"==typeof s[a]&&e.set(t,s[a])})),e.size&&(s.setAttribute("aria-label",i.text.join("")),s.addEventListener("click",function(){this.forEach((e=>e()))}.bind(e)))}}else e.parts.appendChild(document.createElement("span"));t in this.site.inputs&&this.depends.set(t,{id:t,parsed:""})})),"condition"in e)for(let t=e.condition.length;t--;){const i=e.condition[t];i.id&&("default"===i.id?i.check=function(){return!0}:(this.depends.set(i.id,i),i.site=this.site,i.check=function(){return"default"===this.id||k.checks[this.type](this.site.valueOf(this.id),this.site.valueOf(this.value))}.bind(i)))}}}};return class{constructor(e){if(this.storage=O,this.patterns=q,this.palettes=D,this.conditionals={},this.registered_inputs=new Map,this.registered_outputs=new Map,this.defaults=N,this.dataviews={},this.inputs={},this.outputs={},this.dependencies={},this.url_options={},this.queue={timeout:0,elements:new Map},this.tree={},this.maps={queue:{},waiting:{},overlay_property_selectors:[]},this.meta={retain_state:!0,lock_after:""},this.state="",this.query="",this.parsed_query={},this.rule_conditions={},e&&(this.spec=e,e.active=this),e.settings||(e.settings={}),"dataLayer"in window||(window.dataLayer=[]),O.copy=O.get(),O.copy)for(const t in e.settings)if(t in O.copy){let i=O.copy[t];"string"==typeof i&&(q.bool.test(i)?i=!!i||"true"===i:q.number.test(i)&&(i=parseFloat(i))),e.settings[t]=i}function t(e,t,i){const s=i.length;let a=i[0][e]+t*i[1][e],n=2;for(;n<s;n++)a+=Math.pow(t,n)*i[n][e];return Math.max(0,Math.min(255,a))}Object.keys(D).forEach((e=>{let i=D[e];if("continuous-polynomial"===i.type){const s=i.colors,a={name:e,type:"discrete",colors:[]};for(let e=0;e<255;e++){const i=e/255;a.colors.push("rgb("+t(0,i,s)+", "+t(1,i,s)+", "+t(2,i,s)+")")}i=D[e]=a}i.odd=i.colors.length%2})),this.query=window.location.search.replace("?",""),this.query&&this.query.split("&").forEach((e=>{const t=e.split("=");let i;t[0],t.length<2&&t.push("true"),i=q.bool.test(t[1])?!!t[1]||"true"===t[1]:t[1].replace(q.url_spaces," "),this.url_options[t[0]]=i,q.settings.test(t[0])&&O.set(t[0].replace(q.settings,""),i)})),("embedded"in this.url_options||"hide_navbar"in this.url_options)&&("hide_logo"in this.url_options||(this.url_options.hide_logo=!0),"hide_title"in this.url_options||(this.url_options.hide_title=!0),"hide_navcontent"in this.url_options||(this.url_options.hide_navcontent=!0),"hide_panels"in this.url_options||(this.url_options.hide_panels=!0),"embedded"in this.url_options&&!("close_menus"in this.url_options)&&(this.url_options.close_menus=!0)),this.init=this.init.bind(this),this.request_queue=this.request_queue.bind(this),this.run_queue=this.run_queue.bind(this),this.global_reset=this.global_reset.bind(this),Object.keys(F).forEach((e=>this.conditionals[e]=F[e].bind(this))),this.spec.dataviews?this.defaults.dataview=Object.keys(this.spec.dataviews)[0]:(this.spec.dataviews={},this.spec.dataviews[this.defaults.dataview]={}),this.maps.overlay_property_selectors||(this.maps.overlay_property_selectors=[]),this.view=new T(this),new Z(this),document.querySelectorAll(".auto-input").forEach((e=>{if(e.dataset.autotype in ne&&!(e.id in this.inputs)){const t=new ne[e.dataset.autotype](e,this);this.registered_inputs.set(t.id,t),this.inputs[t.id]=t}})),this.subs=new L(this),document.querySelectorAll(".auto-output").forEach((e=>{if(e.dataset.autotype in re&&!(e.id in this.outputs)){const t=new re[e.dataset.autotype](e,this);this.registered_outputs.set(t.id,t),this.outputs[t.id]=t;const i="options"in t?t.options:t.spec;"subto"in i&&("string"==typeof i.subto&&(i.subto=[i.subto]),Array.isArray(i.subto)&&i.subto.forEach((e=>this.subs.add(e,t))))}})),e.variables&&e.variables.length&&e.variables.forEach((e=>{const t=new ee(e,this);this.registered_inputs.set(e.id,t),this.inputs[e.id]=t})),this.defaults.dataset=this.spec.dataviews[N.dataview].dataset,this.spec.metadata||(this.spec.metadata={datasets:[]});const i=this.spec.metadata.datasets;i&&i.length&&-1===i.indexOf(this.defaults.dataset)&&(1===i.length?this.defaults.dataset=i[0]:(this.registered_inputs.forEach((e=>{if(!this.defaults.dataset){const t=e.default;-1!==i.indexOf(e.dataset)?this.defaults.dataset=e.dataset:"string"==typeof t&&-1!==i.indexOf(t)?this.defaults.dataset=t:"select"===e.type&&"number"==typeof t&&e.options[t]&&-1!==i.indexOf(e.options[t].value)?this.defaults.dataset=e.options[t].value:("select"===e.type||"combobox"===e.type)&&Array.isArray(e.values)&&e.values[e.default]&&-1!==i.indexOf(e.values[e.default])&&(this.defaults.dataset=e.values[e.default])}})),this.defaults.dataset||(this.defaults.dataset=i[i.length-1])),this.defaults.dataset=this.valueOf(this.defaults.dataset),-1===i.indexOf(this.defaults.dataset)&&(this.defaults.dataset=i[0]),this.registered_inputs.forEach((e=>{e.dataset||(e.dataset=this.defaults.dataset)})),this.spec.dataviews[N.dataview].dataset||(this.spec.dataviews[N.dataview].dataset=this.defaults.dataset)),e.rules&&e.rules.length&&e.rules.forEach(((e,t)=>{if(e.parsed={},"display"in e.effects){e.parsed.display={e:document.getElementById(e.effects.display)};const t=e.parsed.display.e.querySelector(".auto-input");if(t){const i=this.inputs[t.id];i.rule=e,e.parsed.display.u=i}}if("lock"in e.effects){const t=new Map;document.querySelectorAll("#"+e.effects.lock+" .auto-input").forEach((e=>t.set(e.id,this.inputs[e.id]))),e.parsed.lock=t}e.condition.forEach((i=>{i.type in k.checks&&(i.check=function(){return k.checks[this.c.type](this.site.valueOf(this.c.id),this.site.valueOf(this.c.value))}.bind({c:i,site:this}),i.id in this.inputs&&(this.add_dependency(i.id,{type:"rule",id:i.id,condition:i,rule:t}),i.id in this.rule_conditions||(this.rule_conditions[i.id]=[]),this.rule_conditions[i.id][t]=e),i.check()?Object.keys(e.effects).forEach((t=>{t in this.inputs&&this.inputs[t].set(this.valueOf(e.effects[t]))})):i.default&&Object.keys(e.effects).forEach((e=>{e in this.inputs&&this.inputs[e].set(this.valueOf(i.default))})))}))}));const s=this.valueOf(this.spec.dataviews[this.defaults.dataview].dataset);this.defaults.dataset="number"==typeof s?i[s]:s,-1===i.indexOf(this.defaults.dataset)&&(this.defaults.dataset=i[0]),this.data=new k(this.spec,this.defaults,this.data,{init:this.init,onload:function(){this.data.inited&&clearTimeout(this.data.inited.load_screen),setTimeout(this.drop_load_screen.bind(this),600),delete this.data.onload}.bind(this),data_load:function(){Object.keys(this.dependencies).forEach((e=>this.request_queue(!1,e)))}.bind(this)})}init(){if(this.data.variables){const e=Object.keys(this.data.variables);this.defaults.variable=e[e.length-1]}Object.keys(this.spec.dataviews).forEach((e=>new X(this,e,this.spec.dataviews[e]))),this.view.init(),this.page.init(),this.query&&(this.parsed_query=this.data.parse_query(this.query),this.parsed_query.variables.conditions.length&&this.parsed_query.variables.conditions.forEach((e=>{this.data.variable_info[e.name]&&this.page.add_filter_condition(e.name,e)}))),this.run_queue(),this.registered_inputs.forEach((t=>e(this,void 0,void 0,(function*(){const e="combobox"===t.type;if(t.optionSource&&"options"in t)if(q.palette.test(t.optionSource))t.options=[],Object.keys(D).forEach((e=>t.add(e,D[e].name))),-1===t.default&&(t.default=N.palette);else if(q.datasets.test(t.optionSource))-1===t.default&&(t.default=N.dataset),t.options=[],this.spec.metadata.datasets.forEach((e=>t.add(e)));else if("option_sets"in t){t.sensitive=!1,q.properties.test(t.optionSource)&&this.maps.overlay_property_selectors.push(t),t.depends&&this.add_dependency(t.depends,{type:"options",id:t.id}),t.dataset in this.inputs&&this.add_dependency(t.dataset,{type:"options",id:t.id}),t.view&&this.add_dependency(t.view,{type:"options",id:t.id});const e=this.valueOf(t.dataset)||N.dataset;"string"==typeof e&&(t.dataset||(t.dataset=e),e in this.data.info&&this.conditionals.options(t))}if(e||"select"===t.type){if(Array.isArray(t.values)){t.values={},t.display={};let e=!0;const i="select"===t.type;t.options.forEach((t=>{i&&(t.dataset.value=t.value),e&&(e=t.dataset.value===t.innerText)})),t.options.forEach(((i,s)=>{t.values[i.dataset.value]=s,e&&(i.innerText=this.data.format_label(i.dataset.value)),t.display[i.innerText]=s})),t.default in t.values||t.default in this.inputs||(t.default=+t.default,isNaN(t.default)&&(t.default=-1),-1!==t.default&&t.default<t.options.length?t.default=t.options[t.default].dataset.value:t.default=-1),t.source="",t.id in this.url_options?t.set(this.url_options[t.id]):t.reset()}t.subset=t.e.dataset.subset||"all",t.selection_subset=t.e.dataset.selectionSubset||t.subset,t.type in this.spec&&t.id in this.spec[t.type]&&(t.settings=this.spec[t.type][t.id],t.settings.filters&&Object.keys(t.settings.filters).forEach((e=>{this.add_dependency(t.settings.filters[e],{type:"filter",id:t.id})})))}else if("number"===t.type&&(t.min=t.e.getAttribute("min"),t.min_ref=parseFloat(t.min),t.min_indicator=t.e.parentElement.parentElement.querySelector(".indicator-min"),t.min_indicator&&t.min_indicator.addEventListener("click",function(){this.set(this.parsed.min)}.bind(t)),t.max=t.e.getAttribute("max"),t.max_ref=parseFloat(t.max),t.max_indicator=t.e.parentElement.parentElement.querySelector(".indicator-max"),t.max_indicator&&t.max_indicator.addEventListener("click",function(){this.set(this.parsed.max)}.bind(t)),t.ref=isNaN(t.min_ref)||isNaN(t.max_ref),t.range=[t.min_ref,t.max_ref],t.step=parseFloat(t.e.step)||1,t.parsed={min:void 0,max:void 0},t.depends={},t.default_max="max"===t.default||"last"===t.default,t.default_min="min"===t.default||"first"===t.default,t.view&&this.add_dependency(t.view,{type:"update",id:t.id}),t.max in this.data.variables?t.view&&this.add_dependency(t.view+"_time",{type:"max",id:t.id}):t.max in this.inputs?this.add_dependency(t.max,{type:"max",id:t.id}):t.e.max=t.max,t.min in this.data.variables?t.view&&this.add_dependency(t.view+"_time",{type:"min",id:t.id}):t.min in this.inputs?this.add_dependency(t.min,{type:"min",id:t.id}):t.e.min=t.min,void 0!==t.default&&(q.number.test(t.default)?t.default=+t.default:t.reset=t.default_max?function(){this.range&&(this.current_default=this.site.valueOf(this.range[1]),this.set(this.current_default))}.bind(t):t.default_max?function(){this.range&&(this.current_default=this.site.valueOf(this.range[0]),this.set(this.current_default))}.bind(t):t.default in this.inputs?function(){this.current_default=this.site.valueOf(this.default),this.set(this.current_default)}.bind(t):function(){}),t.variable)){const e=-1===this.spec.metadata.datasets.indexOf(t.dataset)?N.dataset:t.dataset;t.variable in this.inputs?this.add_dependency(t.variable,{type:"update",id:t.id}):t.variable in this.data.variables&&(t.min=t.parsed.min=t.range[0]=this.data.variables[t.variable].info[e].min,t.e.min=t.min+"",t.max=t.parsed.max=t.range[1]=this.data.variables[t.variable].info[e].max,t.e.max=t.max+"")}"select"!==t.type&&"number"!==t.type&&"text"!==t.type||t.e.parentElement.lastElementChild&&t.e.parentElement.lastElementChild.classList.contains("select-reset")&&t.e.parentElement.lastElementChild.addEventListener("click",t.reset.bind(t)),q.settings.test(t.id)&&(t.setting=t.id.replace(q.settings,""),null==t.default&&t.setting in this.spec.settings&&(t.default=this.spec.settings[t.setting]),this.add_dependency(t.id,{type:"setting",id:t.id})),t.view||(t.view=N.dataview);const i=this.url_options[t.id]||O.get(t.id.replace(q.settings,""));"init"in t&&t.init(),i?t.set(i):t.reset()})))),this.registered_outputs.forEach((e=>{"init"in e&&e.init()}))}global_update(){this.meta.retain_state=!1,this.queue.elements.forEach(this.request_queue),this.registered_outputs.forEach((e=>e.update()))}global_reset(){this.meta.retain_state=!1,this.registered_inputs.forEach(((e,t)=>{!e.setting&&e.reset&&(e.reset(),this.request_queue(!1,t))}))}clear_storage(){window.localStorage&&O.perm.removeItem(O.name),window.location.reload()}request_queue(e,t){"boolean"!=typeof e&&(t=e,e=!1),e||-1!==this.queue.timeout&&this.queue.elements.get(t)||(this.queue.elements.set(t,!0),this.queue.timeout>0&&clearTimeout(this.queue.timeout),this.queue.timeout=setTimeout(this.run_queue,20),this.meta.lock_after=t)}run_queue(){this.queue.timeout>0&&clearTimeout(this.queue.timeout),this.queue.timeout=-1,this.queue.elements.forEach(((e,t)=>{if(e){const e=this.refresh_conditions(t);if(e)return t in this.data.data_queue[e]||(this.data.data_queue[e][t]=this.run_queue),!1;this.queue.elements.set(t,!1)}}));let e=this.get_options_url();this.data.inited.first&&e!==this.state&&(this.state=e,Object.keys(this.url_options).forEach((t=>{const i=this.url_options[t];"string"==typeof i&&q.embed_setting.test(t)&&(e+="&"+t+"="+("navcolor"===t?i.replace(q.hashes,"%23"):i))})),this.spec.settings.hide_url_parameters||window.history.replaceState(Date.now(),"",e),setTimeout(this.page.resize,50))}refresh_conditions(e){if(e in this.dependencies){const t=this.dependencies[e],i=[],s="view."===e.substring(0,5)?this.view:e in this.dataviews?this.dataviews[e]:this.inputs[e],a=s instanceof X,n=s instanceof T,r="id"===e.substring(5)?"id_state":"filter_state",l=n?s[r]():s&&s.value()+"",o=n?s.states[r]:s&&s.state;if(s&&(!this.meta.retain_state||o!==l)){if(n)s.states[r]=l;else if(a)s.state=l;else{const e=this.dataviews[s.view],t=l in this.data.loaded?l:s.dataset?this.valueOf(s.dataset):e&&e.get.dataset();if(this.data.info&&t in this.data.loaded&&!this.data.loaded[t])return s.deferred||this.data.retrieve(t,this.data.info[t].site_file),t;s.state=l}t.forEach((e=>{if("rule"===e.type)-1===i.indexOf(e.rule)&&i.push(e.rule);else if("dataview"===e.type)this.dataviews[e.id].update();else if(e.conditional)this.conditionals[e.conditional](e.id in this.dataviews?this.dataviews[e.id]:this.inputs[e.id],s);else if(e.id in this.inputs){const t=this.inputs[e.id];e.type in t&&t[e.type]()}else if(e.id in this.outputs){const t=this.outputs[e.id];e.type in t&&t[e.type]()}})),i.forEach((e=>{let t=!1;const i=this.spec.rules[e],s=i.condition.length;for(let e=0;e<s;e++){const s=i.condition[e];if(t=s.check(),s.any?t:!t)break}Object.keys(i.parsed).forEach((e=>{if(t){if("display"===e)i.parsed[e].e.classList.remove("hidden");else if("lock"===e)i.parsed[e].forEach((e=>{e.e.classList.remove("locked"),S(e,!0)}));else if(e in this.inputs){const t=this.valueOf(i.effects[e]);this.inputs[e].set(t)}}else if("display"===e){const t=i.parsed[e];t.e.classList.contains("hidden")||(t.e.classList.add("hidden"),t.u&&t.u.reset&&t.u.reset(),t.e.querySelectorAll(".auto-input").forEach((e=>{const t=this.inputs[e.id];t&&t.reset&&t.reset()})))}else"lock"===e?i.parsed[e].forEach((e=>{e.e.classList.add("locked"),S(e)})):"default"in i&&e in this.inputs&&this.inputs[e].set(this.valueOf(i.default))}))}))}e===this.meta.lock_after&&(this.meta.retain_state=!0)}}valueOf(e){return"string"==typeof e&&e in this.inputs?this.valueOf(this.inputs[e].value()):e}get_options_url(){let e="";return this.registered_inputs.forEach(((t,i)=>{if(!("virtual"===t.type||q.settings.test(i)||"range"in t&&t.range[0]===t.range[1])){let s=t.value();("off_default"in t?t.off_default:s!==t.default)&&(Array.isArray(s)&&(s=s.join(",")),""!==s&&null!=s&&"-1"!=s&&(e+=(e?"&":"?")+i+"="+s))}})),this.data&&this.view.filters.size&&(e+=(e?"&":"?")+this.view.filter_state([])),window.location.protocol+"//"+window.location.host+window.location.pathname+e}gtag(...e){this.spec.settings.tracking&&window.dataLayer.push(arguments)}drop_load_screen(){this.data&&this.data.inited&&clearTimeout(+this.data.inited.load_screen),this.page.wrap.style.visibility="visible",this.page.load_screen.style.display="none",this.spec.tutorials&&"tutorial"in this.url_options&&setTimeout(this.page.tutorials.start_tutorial.bind(this.page.tutorials,{target:{dataset:{name:this.url_options.tutorial}}}),0)}add_dependency(e,t){e in this.dependencies||(this.dependencies[e]=[]),t.uid||(t.uid=JSON.stringify(t)),t.type in this.conditionals&&(t.conditional=t.type);const i=this.dependencies[e];for(let e=i.length;e--;)if(t.uid===i[e].uid)return;i.push(t),e in this.tree||(this.tree[e]={_n:{children:0,parents:0},children:{},parents:{}}),t.id in this.tree||(this.tree[t.id]={_n:{children:0,parents:0},children:{},parents:{}}),this.tree[e].children[t.id]=this.tree[t.id],this.tree[e]._n.children++,this.tree[t.id].parents[e]=this.tree[e],this.tree[t.id]._n.parents++,i.sort(((e,t)=>e.id in this.tree&&t.id in this.tree?this.tree[e.id]._n.children-this.tree[t.id]._n.children:-1/0)),this.request_queue(!0,e)}get_color(e,t,i,s,a,n){const r=D[t];if(isNaN(e)||"continuous-polynomial"===r.type)return this.defaults.missing;const l=this.spec.settings,o="none"!==l.color_scale_center&&!l.color_by_order,d="discrete"===r.type,h="string"===i.type,c=h?0:i.min[s],u=h?i.levels.length-c:i.range[s],p="none"===l.color_scale_center||q.median.test(l.color_scale_center)?"median":"mean",m=(l.color_by_order?"break_":"norm_")+p,f=l.color_by_order?o?i[m][s]/n:.5:isNaN(i[m][s])?.5:i[m][s],_=d?o&&!l.color_by_order?Math.ceil(r.colors.length/2)-r.odd/2:r.colors.length:1,v=l.color_by_order?(a+.5)/n:u?((h?i.level_ids[e]:e)-c)/u:.5,g=v>(o?f:.5),b=g?"upper_":"lower_",y=b+p+"_range";let E=o?u?((g?v-f:v+f)-i[b+p+"_min"][s])/i[y][s]:1:v;return d||(E=Math.max(0,Math.min(1,E)),g&&(E=1-E),o||(E*=2)),(h?e in i.level_ids:"number"==typeof e)?d?r.colors[Math.max(0,Math.min(r.colors.length-1,Math.floor(o&&g?_+_*E:_*E)))]:"rgb("+(g?r.colors[0][0][0]+E*r.colors[0][1][0]+", "+(r.colors[0][0][1]+E*r.colors[0][1][1])+", "+(r.colors[0][0][2]+E*r.colors[0][1][2]):r.colors[2][0][0]+E*r.colors[2][1][0]+", "+(r.colors[2][0][1]+E*r.colors[2][1][1])+", "+(r.colors[2][0][2]+E*r.colors[2][1][2]))+")":N.missing}}}));
//# sourceMappingURL=community.v2.min.js.map
